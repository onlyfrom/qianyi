<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仟艺服饰管理后台</title>
    <link rel="icon" type="image/x-icon" href="https://7072-prod-9gd4jllic76d4842-1348936510.tcb.qcloud.la/system/logo.png?sign=013420464d5c9d73dd11b8a00bbcc674&t=1742838676">
    <!-- 引入 Element Plus 相关文件 -->
    <link rel="stylesheet" href="/admin/lib/element-plus/index.css">
    <script src="/admin/lib/vue/vue.global.min.js"></script>
    <script src="/admin/lib/element-plus/index.full.min.js"></script>
    <script src="/admin/lib/icons/icons-vue.js"></script>
    <script src="/admin/lib/axios/axios.min.js"></script>
    <script src="/admin/lib/sortable/Sortable.min.js"></script>
    <script src="components/ProductSelector.js"></script>
    <script src="components/PurchaseOrderDetail.js"></script>
    <script src="https://unpkg.com/element-plus/dist/locale/zh-cn.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
        }

        #app {
            height: 100%;
        }

        .layout-container {
            height: 100%;
        }

        .el-header {
            background-color: #545c64;
            color: #fff;
            line-height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .el-aside {
            background-color: #545c64;
            color: #fff;
            height: 100%;
        }

        .color-stock-form-item {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
        }

        .color-stock-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border: 1px solid #ebeef5;
            border-radius: 4px;
            width: calc(33.33% - 10px);
            width: 250px;
            background-color: #fff;
        }

        .color-tag {
            width: 80px;
            text-align: center;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .stock-input {
            flex: 1;
            min-width: 100px;
        }

        /* 确保图片预览显示在最上层 */
        .el-image-viewer__wrapper {
            z-index: 2100 !important;
        }

        .el-image-viewer__mask {
            z-index: 2099 !important;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .left-tools {
            display: flex;
            gap: 10px;
        }

        .excel-uploader {
            display: inline-block;
        }

        /* 自定义分页文本 */
        .el-pagination {
            --el-pagination-total-text: "总计";
        }

        /* 自定义每页显示数量的下拉框文本 */
        .custom-page-sizes .el-select-dropdown__item {
            &::before {
                content: "每页 ";
            }

            &::after {
                content: " 条";
            }
        }

        .statistics-container {
            padding: 20px;
        }

        .filter-bar {
            margin-bottom: 20px;
        }

        .summary-cards {
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-value {
            font-size: 24px;
            font-weight: bold;
            color: #409EFF;
            text-align: center;
        }

        .rank-lists .el-card {
            margin-bottom: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .el-dropdown-link {
            display: flex;
            align-items: center;
            color: #fff;
            cursor: pointer;
        }

        .el-dropdown-link:hover {
            opacity: 0.8;
        }

        .search-bar {
            flex: 1;
            max-width: 600px;
        }


        /* ... 其他样式保持不变 ... */
        .status-tabs {
            margin-bottom: 20px;
        }
        
        .count-tag {
            margin-left: 5px;
            transform: scale(0.8);
        }
        
        .el-radio-button__inner {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .filter-container {
            display: flex;
            width: 100rpx            ;
        }

        .my-select-dropdown {
            width: auto !important;
            min-width: 200px !important;
        }

        .my-select-dropdown .el-select-dropdown__item {
            width: 100%;
            min-width: 200px;
        }

        .el-select {
            display: block;
        }

        .el-select .el-input {
            width: 100%;
        }

        .el-select-dropdown {
            width: auto !important;
        }
        
        /* 自定义图片预览样式 */
        :root {
            --el-image-viewer-mask-color: rgba(0, 0, 0, 0.9);
        }

        .el-image-viewer__wrapper {
            position: fixed;
            z-index: 2050 !important;
        }

        .el-image-viewer__btn {
            opacity: 0.8;
            color: #fff;
            font-size: 24px;
        }

        .el-image-viewer__close {
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            font-size: 24px;
        }

        .el-image-viewer__canvas {
            user-select: none;
        }

        .el-image-viewer__actions {
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
        }

        .el-image-viewer__actions__inner {
            gap: 15px;
        }

        .el-image {
            .el-image__inner {
                transition: all 0.3s;
            }
            
            &:hover .el-image__inner {
                transform: scale(1.05);
            }
        }

        /* 调整图片预览组件的层级关系 */
        .el-image-viewer__wrapper {
            position: fixed !important;
            z-index: 2999 !important;
        }

        .el-image-viewer__mask {
            position: fixed !important;
            z-index: 2998 !important;
            background-color: rgba(0, 0, 0, 0.9);
        }

        .el-image-viewer__btn {
            z-index: 3000 !important;
        }

        .el-image-viewer__close {
            z-index: 3000 !important;
        }

        .el-image-viewer__canvas {
            z-index: 2999 !important;
        }

        .el-image-viewer__actions {
            z-index: 3000 !important;
        }

        /* 图片预览器内的操作按钮样式 */
        .el-image-viewer__actions__inner i {
            color: #fff !important;
            font-size: 18px !important;
            margin: 0 10px !important;
            cursor: pointer !important;
        }

        /* 预览图片容器样式 */
        .el-image-viewer__img {
            background-color: transparent !important;
            max-width: 90vw !important;
            max-height: 90vh !important;
            user-select: none !important;
        }

        /* 缩略图样式 */
        .el-image {
            border-radius: 4px;
            overflow: hidden;
            
            .el-image__inner {
                transition: all 0.3s;
            }
            
            &:hover .el-image__inner {
                transform: scale(1.05);
            }
        }

        /* 占位符和错误状态样式 */
        .image-placeholder,
        .image-error {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #f5f7fa;
            color: #909399;
            font-size: 12px;
        }

        .image-error {
            .el-icon {
                font-size: 20px;
                margin-bottom: 8px;
            }
        }

        /* 重新调整图片预览组件的层级和样式 */
        :root {
            --el-image-viewer-mask-color: rgba(0, 0, 0, 0.85);
        }

        .el-image-viewer__wrapper {
            position: fixed !important;
            z-index: 2100 !important;
        }

        .el-image-viewer__mask {
            position: fixed !important;
            z-index: 2000 !important;
            backdrop-filter: blur(2px);
        }

        .el-image-viewer__img {
            z-index: 2200 !important;
            position: relative !important;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
        }

        .el-image-viewer__prev,
        .el-image-viewer__next,
        .el-image-viewer__close {
            z-index: 2300 !important;
            background-color: rgba(0, 0, 0, 0.3) !important;
            border-radius: 50%;
            width: 44px !important;
            height: 44px !important;
            line-height: 44px !important;
            
            &:hover {
                background-color: rgba(0, 0, 0, 0.5) !important;
            }
        }

        .el-image-viewer__actions {
            z-index: 2300 !important;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 8px 20px;
            
            .el-image-viewer__actions__inner {
                gap: 20px;
                
                i {
                    font-size: 20px;
                    transition: all 0.3s;
                    
                    &:hover {
                        transform: scale(1.2);
                        color: #fff;
                    }
                }
            }
        }

        .el-image-viewer__canvas {
            z-index: 2200 !important;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        /* 优化图片加载和错误状态的显示 */
        .image-placeholder,
        .image-error {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #f5f7fa;
            border-radius: 4px;
            
            .el-icon {
                font-size: 20px;
                margin-bottom: 8px;
                color: #909399;
            }
        }

        .filter-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 4px;
        }

        .filter-option-item {
            padding: 6px 12px;
            border: 1px solid #DCDFE6;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: #fff;
            font-size: 13px;
            color: #606266;
        }

        .filter-option-item:hover {
            border-color: #409EFF;
            color: #409EFF;
        }

        .filter-option-item.is-active {
            background: #409EFF;
            border-color: #409EFF;
            color: #fff;
        }

        .dialog-footer {
            padding-top: 20px;
            text-align: right;
        }

        .el-select {
            width: 100%;
        }

        .el-dialog {
            border-radius: 8px;
        }

        .el-dialog__header {
            margin-right: 0;
            padding: 20px;
            border-bottom: 1px solid #dcdfe6;
        }

        .el-dialog__body {
            padding: 20px;
        }

        .el-dialog__footer {
            padding: 10px 20px 20px;
            border-top: 1px solid #dcdfe6;
        }
        .batch-style-dialog {
            width: 400px;
            height: 400px;
        }

        /* 添加新样式 */
        .color-images-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .color-image-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #EBEEF5;
            border-radius: 4px;
        }

        .selected-images {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .image-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            padding: 10px;
        }

        .image-select-item {
            width: 100px;
            height: 100px;
            border: 2px solid transparent;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-select-item:hover {
            transform: scale(1.05);
        }

        .image-select-item.selected {
            border-color: #409EFF;
        }

        .color-image-preview {
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .color-image-preview:hover {
            opacity: 0.8;
        }

        .image-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            padding: 10px;
        }

        .image-select-item {
            width: 100px;
            height: 100px;
            border: 2px solid transparent;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-select-item:hover {
            transform: scale(1.05);
        }

        .image-select-item.selected {
            border-color: #409EFF;
        }

        /* 添加图片选择相关样式 */
        .image-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .image-select-item {
            width: 100px;
            height: 100px;
            border: 2px solid transparent;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-select-item:hover {
            transform: scale(1.05);
        }

        .image-select-item.selected {
            border-color: #409EFF;
        }

        .color-image-preview {
            margin-left: 10px;
            cursor: pointer;
        }

        .color-image-preview:hover {
            opacity: 0.8;
        }

        /* 添加行内编辑样式 */
        .editable-cell {
            padding: 2px 0;
        }

        .editable-cell .el-input.is-small .el-input__wrapper {
            padding: 1px 5px;
        }

        .editable-cell .el-input-number.is-small {
            width: 50px;
        }

        .el-table .cell {
            padding: 5px;
        }

        /* 添加到已有的 style 标签中 */
        .spec-form-container {
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 16px;
            display: flex;
            flex-direction: row;
            gap: 12px;
        }

        .spec-form-title {
            font-size: 14px;
            color: #606266;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .spec-form-title::before {
            content: '';
            width: 3px;
            height: 14px;
            background-color: #409EFF;
            margin-right: 8px;
            border-radius: 2px;
        }

        .spec-form-row {
            display: flex;
            width: 200rpx;
            gap: 16px;
            margin-bottom: 12px;
        }

        .spec-form-item {
            display: flex;
            flex-direction: row;
            width: 200rpx;
            gap: 12px;
        }

        .spec-form-item .el-form-item__label {
            font-size: 13px;
            color: #606266;
            margin-bottom: 4px;
        }

        .recommended-products-container {
            padding: 10px;
        }

        .recommended-list {
            margin-top: 20px;
        }

        .recommended-list h4,
        .search-results h4 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #409EFF;
            padding-left: 10px;
            border-left: 3px solid #409EFF;
        }

        .search-results {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px dashed #EBEEF5;
        }

        /* 修改分页组件 */
        .pagination-container {
            margin-top: 20px;
            text-align: right;
        }

        .pagination-dropdown .el-select-dropdown__item {
            display: flex;
        }

        .pagination-dropdown .el-select-dropdown__item::before {
            content: "每页 ";
        }

        .pagination-dropdown .el-select-dropdown__item::after {
            content: " 条";
        }

        /* 发货单管理 */
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: 1px solid #ebeef5;
        }

        .module-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .module-actions {
            display: flex;
            gap: 10px;
        }

        .filter-container {
            margin-bottom: 20px;
        }

        .search-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
        }

        .filter-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .batch-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #ecf5ff;
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .selected-count {
            font-size: 14px;
            color: #606266;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .secondary-text {
            font-size: 12px;
            color: #909399;
            margin-top: 5px;
        }

        .customer-info > div:first-child {
            font-weight: bold;
        }

        .delivery-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 3px solid #409eff;
        }

        .remark-content {
            background-color: #f8f8f8;
            padding: 10px 15px;
            border-radius: 4px;
            color: #606266;
            line-height: 1.6;
        }

        .image-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .delivery-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .delivery-image:hover {
            transform: scale(1.05);
        }

        .log-detail {
            font-size: 12px;
            color: #909399;
            margin-top: 5px;
        }

        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .order-summary {
            margin-top: 20px;
            padding: 10px 15px;
            background-color: #f8f8f8;
            border-radius: 4px;
            display: flex;
            justify-content: flex-end;
            gap: 20px;
        }

        .dialogwangyou {
            transform: translateX(-300px) !important;
        }

        .summary-item {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .summary-item span:last-child {
            font-weight: bold;
            color: #409eff;
        }

        .upload-tip {
            color: #909399;
            font-size: 12px;
            margin-top: 10px;
            text-align: center;
        }

        /* 打印样式 */
        .print-container {
            padding: 20px;
            background-color: white;
        }

        .print-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .print-header h2 {
            margin: 0;
            padding: 0;
        }

        .print-order-number {
            margin-top: 5px;
            font-size: 14px;
        }

        .print-info {
            margin-bottom: 20px;
        }

        .print-info-item {
            margin-bottom: 8px;
        }

        .print-label {
            font-weight: bold;
            min-width: 60px;
            display: inline-block;
        }

        .print-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .print-table th,
        .print-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .print-table th {
            background-color: #f2f2f2;
        }

        .print-footer {
            margin-top: 30px;
        }

        .print-remark {
            margin-bottom: 20px;
        }

        .print-signatures {
            display: flex;
            justify-content: space-between;
            margin-top: 50px;
        }

        .print-signature {
            width: 45%;
        }

        .signature-line {
            border-bottom: 1px solid #000;
            display: inline-block;
            width: 150px;
        }

        .el-dialog__body {
            padding: 20px;
        }

        .el-dialog__footer {
            padding: 10px 20px 20px;
            border-top: 1px solid #dcdfe6;
        }
        .batch-style-dialog {
            width: 400px;
            height: 400px;
        }

        /* 添加新样式 */
        .color-images-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .color-image-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #EBEEF5;
            border-radius: 4px;
        }

        .selected-images {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .image-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            padding: 10px;
        }

        .image-select-item {
            width: 100px;
            height: 100px;
            border: 2px solid transparent;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-select-item:hover {
            transform: scale(1.05);
        }

        .image-select-item.selected {
            border-color: #409EFF;
        }

        .color-image-preview {
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .color-image-preview:hover {
            opacity: 0.8;
        }

        .image-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            padding: 10px;
        }

        .image-select-item {
            width: 100px;
            height: 100px;
            border: 2px solid transparent;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-select-item:hover {
            transform: scale(1.05);
        }

        .image-select-item.selected {
            border-color: #409EFF;
        }

        /* 添加图片选择相关样式 */
        .image-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .image-select-item {
            width: 100px;
            height: 100px;
            border: 2px solid transparent;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-select-item:hover {
            transform: scale(1.05);
        }

        .image-select-item.selected {
            border-color: #409EFF;
        }

        .color-image-preview {
            margin-left: 10px;
            cursor: pointer;
        }

        .color-image-preview:hover {
            opacity: 0.8;
        }

        /* 添加行内编辑样式 */
        .editable-cell {
            padding: 2px 0;
        }

        .editable-cell .el-input.is-small .el-input__wrapper {
            padding: 1px 5px;
        }

        .editable-cell .el-input-number.is-small {
            width: 50px;
        }

        .el-table .cell {
            padding: 5px;
        }

        /* 添加到已有的 style 标签中 */
        .spec-form-container {
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 16px;
            display: flex;
            flex-direction: row;
            gap: 12px;
        }

        .spec-form-title {
            font-size: 14px;
            color: #606266;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .spec-form-title::before {
            content: '';
            width: 3px;
            height: 14px;
            background-color: #409EFF;
            margin-right: 8px;
            border-radius: 2px;
        }

        .spec-form-row {
            display: flex;
            width: 200rpx;
            gap: 16px;
            margin-bottom: 12px;
        }

        .spec-form-item {
            display: flex;
            flex-direction: row;
            width: 200rpx;
            gap: 12px;
        }

        .spec-form-item .el-form-item__label {
            font-size: 13px;
            color: #606266;
            margin-bottom: 4px;
        }

        .recommended-products-container {
            padding: 10px;
        }

        .recommended-list {
            margin-top: 20px;
        }

        .recommended-list h4,
        .search-results h4 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #409EFF;
            padding-left: 10px;
            border-left: 3px solid #409EFF;
        }

        .search-results {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px dashed #EBEEF5;
        }

        /* 修改分页组件 */
        .pagination-container {
            margin-top: 20px;
            text-align: right;
        }

        .pagination-dropdown .el-select-dropdown__item {
            display: flex;
        }

        .pagination-dropdown .el-select-dropdown__item::before {
            content: "每页 ";
        }

        .pagination-dropdown .el-select-dropdown__item::after {
            content: " 条";
        }

        .delivery-detail-dialog {
            .el-dialog__body {
                padding: 20px;
            }
        }

        .delivery-info {
            margin-bottom: 20px;
        }

        .delivery-info .el-descriptions {
            margin-bottom: 20px;
        }

        .product-list {
            margin-top: 20px;
        }

        .product-list h3 {
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 500;
        }

        .dialog-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .delivery-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 10px;
        }
    </style>
</head>

<body>
    <div id="app">
        <el-container class="layout-container">
            <el-header>
                <div class="header-title">杭州仟艺服饰后台管理系统</div>
                <div class="user-info">
                    <el-dropdown @command="handleCommand">
                        <span class="el-dropdown-link">
                            <el-avatar :size="32" :src="getUserInfo().avatar"></el-avatar>
                            <span style="margin-left: 8px">{{ getUserInfo().nickname || getUserInfo().username }}</span>
                            <el-icon class="el-icon--right"><arrow-down /></el-icon>
                        </span>
                        <template #dropdown>
                            <el-dropdown-menu>
                                <el-dropdown-item command="profile">个人信息</el-dropdown-item>
                                <el-dropdown-item command="logout">退出登录</el-dropdown-item>
                            </el-dropdown-menu>
                        </template>
                    </el-dropdown>
                </div>
            </el-header>

            <el-container>
                <el-aside width="200px">
                    <el-menu default-active="1" background-color="#545c64" text-color="#fff" active-text-color="#ffd04b"
                        @select="handleSelect">

                        <el-menu-item index="1">
                            <el-icon>
                                <Document />
                            </el-icon>
                            <span>商品管理</span>
                        </el-menu-item>

                        <el-menu-item index="2">
                            <el-icon><User /></el-icon>
                            <span>用户管理</span>
                        </el-menu-item>

                        <el-menu-item index="3">
                            <el-icon><List /></el-icon>
                            <span>采购单管理</span>
                        </el-menu-item>

                        <el-menu-item index="4">
                            <el-icon>
                                <List />
                            </el-icon>
                            <span>发货单管理</span>
                        </el-menu-item>
                        <el-menu-item index="7">
                            <el-icon><share /></el-icon>
                            <span>推送单管理</span>
                        </el-menu-item>
                        <el-menu-item index="5">
                            <el-icon>
                                <Setting />
                            </el-icon>
                            <span>系统设置</span>
                        </el-menu-item>

                        <el-menu-item index="6">
                            <el-icon><Histogram /></el-icon>
                            <span>数据统计</span>
                        </el-menu-item>

                        
                    </el-menu>
                </el-aside>

                <el-main>
                    <div class="content-container">
                        <!-- 商品管理内容 -->
                        
                        <div v-if="currentPage === '1'">
                             <!-- 批量修改款式对话框 -->
                            <!-- 批量修改款式对话框 -->
                            <el-dialog title="批量修改款式" v-model="batchStyleDialogVisible" width="400px">
                                <el-form :model="batchStyleForm" label-width="80px">
                                    <el-form-item label="款式">
                                        <el-select v-model="batchStyleForm.type" placeholder="请选择款式">
                                            <el-option
                                                v-for="item in styleOptions"
                                                :key="item.id"
                                                :label="item.name"
                                                :value="item.id">
                                            </el-option>
                                        </el-select>
                                    </el-form-item>
                                </el-form>
                                <template #footer>
                                    <span class="dialog-footer">
                                        <el-button @click="batchStyleDialogVisible = false">取消</el-button>
                                        <el-button type="primary" @click="handleBatchStyleUpdate">确定</el-button>
                                    </span>
                                </template>
                            </el-dialog>
                            
                            <div class="toolbar">
                                <div class="left-tools">
                                    <el-button type="primary" @click="showAddProductDialog">添加商品</el-button>
                                    <el-button type="primary" @click="toggleEditMode">
                                        {{ isEditMode ? '退出编辑' : '开启编辑' }}
                                    </el-button>
                                    <el-dropdown @command="handleBatchCommand" :disabled="!selectedProducts.length">
                                        <el-button type="primary">
                                            批量操作 <el-icon class="el-icon--right"><arrow-down /></el-icon>
                                            <span v-if="selectedProducts.length">({{selectedProducts.length}})</span>
                                        </el-button>
                                        <template #dropdown>
                                            <el-dropdown-menu>
                                                <el-dropdown-item command="delete">批量删除</el-dropdown-item>
                                                <el-dropdown-item command="style">批量修改款式</el-dropdown-item>
                                                <el-dropdown-item command="status">批量修改状态</el-dropdown-item>
                                                <el-dropdown-item command="public">批量修改公开状态</el-dropdown-item>
                                            </el-dropdown-menu>
                                        </template>
                                    </el-dropdown>
                                </div>
                                
                                <div class="search-bar">
                                    <el-input
                                        v-model="productSearch.keyword"
                                        placeholder="搜索商品名称/款号"
                                        clearable
                                        @clear="handleProductSearch"
                                        @keyup.enter="handleProductSearch"
                                    >
                                        <template #append>
                                            <el-button @click="handleProductSearch">搜索</el-button>
                                        </template>
                                    </el-input>
                                </div>
                                
                                
                                </el-switch>
                                <!-- 筛选区域 -->
                                <el-upload class="excel-uploader" action="/products/import-stock" :headers="uploadHeaders"
                                    :on-success="handleImportSuccess" :on-error="handleImportError"
                                    :before-upload="beforeImportUpload" accept=".xlsx,.xls" :show-file-list="false">
                                    <el-button type="success">Excel导入</el-button>
                                </el-upload>
                                <el-button type="info" @click="downloadTemplate">下载模板</el-button>
                                <el-switch v-model="selectedFilters.status"
                                :active-value="1"
                                :inactive-value="0"
                                :active-text="selectedFilters.status === 1 ? '在售' : '下架'"
                                @change="handleStatusFilterChange"
                                >
                            </div>
                            <!-- 商品列表 -->
                            <el-table 
                                :data="products" 
                                style="width: 100%;" 
                                v-loading="productLoading"
                                ref="productTable"
                                max-height="calc(100vh - 200px)"
                                @selection-change="handleSelectionChange"
                                @sort-change="handleSortChange">
                                <el-table-column type="selection" width="55"></el-table-column>
                                <!-- 货号 -->
                                <el-table-column prop="id" label="货号" width="80" sortable="custom"></el-table-column>
                                <el-table-column label="图片"  width="65">
                                    <template #default="scope">
                                        <el-image 
                                            v-if="scope.row.images && scope.row.images.length > 0"
                                            style="width: 50px; height: 50px; cursor: pointer; border-radius: 4px; overflow: hidden;" 
                                            :src="handleImageUrl(scope.row.images[0])"
                                            :preview-src-list="scope.row.images.map(img => handleImageUrl(img))"
                                            :initial-index="0"
                                            :zoom-rate="1.2"
                                            :preview-teleported="true"
                                            :close-on-press-escape="true"
                                            :infinite="true"
                                            fit="cover"
                                            @load="onImageLoad">
                                            <template #placeholder>
                                                <div class="image-placeholder">
                                                    <el-icon><Picture /></el-icon>
                                                </div>
                                            </template>
                                            <template #error>
                                                <div class="image-error">
                                                    <el-icon><Picture /></el-icon>
                                                    <span>加载失败</span>
                                                </div>
                                            </template>
                                        </el-image>
                                    </template>
                                </el-table-column>
                                
                                <el-table-column prop="is_public" label="是否公开" width="80">
                                    <template #header>
                                        <el-popover placement="bottom" :width="120" trigger="click" v-model:visible="filterVisible.is_public">
                                            <template #reference>
                                                <span :style="{ color: selectedFilters.is_public !== null ? '#inherit' : 'inherit' }" style="cursor: pointer">
                                                    {{ selectedFilters.is_public === 1 ? '公开' : selectedFilters.is_public === 0 ? '私密' : '全部' }}
                                                    <el-icon v-if="selectedFilters.is_public !== null"></el-icon>
                                                </span>
                                            </template>
                                            <div class="filter-options">
                                                <div class="filter-option-item"
                                                    :class="{ 'is-active': selectedFilters.is_public === 1 }"
                                                    @click="selectedFilters.is_public = null">
                                                    全部
                                                </div>
                                                <div class="filter-option-item"
                                                    :class="{ 'is-active': selectedFilters.is_public === 1 }"
                                                    @click="selectedFilters.is_public = 1">
                                                    公开
                                                </div>
                                                <div class="filter-option-item"
                                                    :class="{ 'is-active': selectedFilters.is_public === 0 }"
                                                    @click="selectedFilters.is_public = 0">
                                                    私密
                                                </div>
                                            </div>
                                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #EBEEF5; text-align: right">
                                                <el-button size="small" @click="resetSpecificFilter('is_public')">重置</el-button>
                                                <el-button size="small" type="primary" @click="handleProductSearch">确定</el-button>
                                            </div>
                                        </el-popover>
                                    </template>
                                    <template #default="scope">
                                        <el-tag :type="scope.row.is_public === 1 ? 'info' : 'success'" @click="handleStatusChange(scope.row, 'is_public')">
                                            {{ scope.row.is_public === 1 ? '公开' : '私密' }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="name" label="商品名称" width="200" sortable @sort-change="handleSortChange"></el-table-column>
                                <el-table-column prop="price_b" label="价格" width="80" v-if="userInfo.user_type === 1">
                                    <template #default="scope">
                                        {{ scope.row.price_b === 0 ? '讯价' : '¥' + scope.row.price_b }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="款式" width="80" prop="type" >
                                    <template #header>
                                        <el-popover placement="bottom" :width="120" trigger="click" v-model:visible="filterVisible.type">
                                            <template #reference>
                                                <span :style="{ color: selectedFilters.type !== null ? '#ADD8E6' : 'inherit' }" style="cursor: pointer">
                                                    款式
                                                    <el-icon v-if="selectedFilters.type !== null"></el-icon>
                                                </span>
                                            </template>
                                            <div class="filter-options">
                                                <div v-for="item in styleOptions" 
                                                    :key="item.id" 
                                                    class="filter-option-item"
                                                    :class="{ 'is-active': selectedFilters.type === item.id }"
                                                    @click="selectedFilters.type = item.id">
                                                    {{ item.name }}
                                                </div>
                                            </div>
                                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #EBEEF5; text-align: right">
                                                <el-button size="small" @click="resetSpecificFilter('type')">重置</el-button>
                                                <el-button size="small" type="primary" @click="handleProductSearch">确定</el-button>
                                            </div>
                                        </el-popover>
                                    </template>
                                    <template #default="scope">
                                        <span>{{ styleOptions.find(item => item.id === scope.row.type)?.name || '未知' }}</span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="尺寸" prop="size" width="80">
                                    <template #header>
                                        <el-popover placement="bottom" :width="200" trigger="click" v-model:visible="filterVisible.size">
                                            <template #reference>
                                                <span :style="{ color: selectedFilters.size !== null ? '#ADD8E6' : 'inherit' }" style="cursor: pointer">
                                                    尺寸(cm)
                                                    <el-icon v-if="selectedFilters.size !== null" class="el-icon--right"></el-icon>
                                                </span>
                                            </template>
                                            <div class="filter-options">
                                                <div v-for="item in filterOptions.sizes" 
                                                    :key="item.value" 
                                                    class="filter-option-item"
                                                    :class="{ 'is-active': selectedFilters.size === item.value }"
                                                    @click="selectedFilters.size = item.value">
                                                    {{ item.text }}
                                                </div>
                                            </div>
                                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #EBEEF5; text-align: right">
                                                <el-button size="small" @click="resetSpecificFilter('size')">重置</el-button>
                                                <el-button size="small" type="primary" @click="handleProductSearch">确定</el-button>
                                            </div>
                                        </el-popover>
                                    </template>
                                    <template #default="{ row }">
                                        <div v-if="isEditMode" class="editable-cell">
                                            <el-input
                                                v-model="row.size"
                                                size="small"
                                                @keyup.enter="handleSpecsSave(row)"
                                                placeholder="输入尺寸">
                                            </el-input>
                                        </div>
                                        <span v-else>{{ row.size || '-' }}</span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="克重" prop="weight" :width="isEditMode ? '135px' : '80px'">
                                    <template #header>
                                        <el-popover placement="bottom" :width="200" trigger="click" v-model:visible="filterVisible.weight">
                                            <template #reference>
                                                <span :style="{ color: selectedFilters.weight !== null ? '#ADD8E6' : 'inherit' }" style="cursor: pointer">
                                                    克重(g)
                                                    <el-icon v-if="selectedFilters.weight !== null" class="el-icon--right"></el-icon>
                                                </span>
                                            </template>
                                            <div class="filter-options">
                                                <div v-for="item in filterOptions.weights" 
                                                    :key="item.value" 
                                                    class="filter-option-item"
                                                    :class="{ 'is-active': selectedFilters.weight === item.value }"
                                                    @click="selectedFilters.weight = item.value">
                                                    {{ item.text }}
                                                </div>
                                            </div>
                                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #EBEEF5; text-align: right">
                                                <el-button size="small" @click="resetSpecificFilter('weight')">重置</el-button>
                                                <el-button size="small" type="primary" @click="handleProductSearch">确定</el-button>
                                            </div>
                                        </el-popover>
                                    </template>
                                    <template #default="{ row }">
                                        <div v-if="isEditMode" class="editable-cell">
                                            <el-input-number
                                                v-model="row.weight"
                                                size="small"
                                                :min="0"
                                                :step="1"
                                                @keyup.enter="handleSpecsSave(row)"
                                                placeholder="输入克重">
                                            </el-input-number>
                                        </div>
                                        <span v-else>{{ row.weight || '-' }}</span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="材质" prop="yarn" width="100">
                                    <template #header>
                                        <el-popover placement="bottom" :width="200" trigger="click" v-model:visible="filterVisible.yarn">
                                            <template #reference>
                                                <span :style="{ color: selectedFilters.yarn !== null ? '#ADD8E6' : 'inherit' }" style="cursor: pointer">
                                                    材质
                                                    <el-icon v-if="selectedFilters.yarn !== null" class="el-icon--right"></el-icon>
                                                </span>
                                            </template>
                                            <div class="filter-options">
                                                <div v-for="item in filterOptions.yarns" 
                                                    :key="item.value" 
                                                    class="filter-option-item"
                                                    :class="{ 'is-active': selectedFilters.yarn === item.value }"
                                                    @click="selectedFilters.yarn = item.value">
                                                    {{ item.text }}
                                                </div>
                                            </div>
                                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #EBEEF5; text-align: right">
                                                <el-button size="small" @click="resetSpecificFilter('yarn')">重置</el-button>
                                                <el-button size="small" type="primary" @click="handleProductSearch">确定</el-button>
                                            </div>
                                        </el-popover>
                                    </template>
                                    <template #default="{ row }">
                                        <div v-if="isEditMode" class="editable-cell">
                                            <el-input
                                                v-model="row.yarn"
                                                size="small"
                                                @keyup.enter="handleSpecsSave(row)"
                                                placeholder="输入材质">
                                            </el-input>
                                        </div>
                                        <span v-else style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; width: 80px; cursor: pointer;" :title="row.yarn">{{ row.yarn || '-' }}</span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="成分" prop="composition" width=100">
                                    <template #header>
                                        <el-popover placement="bottom" :width="200" trigger="click" v-model:visible="filterVisible.composition">
                                            <template #reference>
                                                <span :style="{ color: selectedFilters.composition !== null ? '#ADD8E6' : 'inherit' }" style="cursor: pointer">
                                                    成分
                                                    <el-icon v-if="selectedFilters.composition !== null" class="el-icon--right"></el-icon>
                                                </span>
                                            </template>
                                            <div class="filter-options">
                                                <div v-for="item in filterOptions.compositions" 
                                                    :key="item.value" 
                                                    class="filter-option-item"
                                                    :class="{ 'is-active': selectedFilters.composition === item.value }"
                                                    @click="selectedFilters.composition = item.value">
                                                    {{ item.text }}
                                                </div>
                                            </div>
                                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #EBEEF5; text-align: right">
                                                <el-button size="small" @click="resetSpecificFilter('composition')">重置</el-button>
                                                <el-button size="small" type="primary" @click="handleProductSearch">确定</el-button>
                                            </div>
                                        </el-popover>
                                    </template>
                                    <template #default="{ row }">
                                        <div v-if="isEditMode" class="editable-cell">
                                            <el-input
                                                v-model="row.composition"
                                                size="small"
                                                @keyup.enter="handleSpecsSave(row)"
                                                placeholder="输入成分">
                                            </el-input>
                                        </div>
                                        <span v-else style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; width: 80px; cursor: pointer;" :title="row.composition">{{ row.composition || '-' }}</span>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="specs" label="颜色/库存" width="250" min-width="125">
                                    <template #default="scope">
                                        <template v-for="spec in getSpecs(scope.row.specs)" :key="spec.color">
                                            <el-tooltip
                                                v-if="spec.stock >= 1000"
                                                :content="spec.color + ': ' + spec.stock"
                                                placement="top"
                                                effect="light">
                                                <el-tag size="small" style="margin: 2px">
                                                    {{ spec.color }}(充足)
                                                </el-tag>
                                            </el-tooltip>
                                            <el-tag v-else size="small" style="margin: 2px">
                                                {{ spec.color }}({{ spec.stock }})
                                            </el-tag>
                                        </template>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="created_at" label="创建日期" width="120">
                                    <template #default="scope">
                                        {{ formatDate(scope.row.created_at) }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="175" fixed="right">
                                    <template #default="scope">
                                        <el-button-group>
                                            <el-button size="small" type="primary"
                                                @click="handleEdit(scope.row)">编辑</el-button>
                                        <el-button size="small" type="danger"
                                            @click="handleDelete(scope.row)">删除</el-button>
                                        <el-button size="small" :type="scope.row.status === 1 ? 'info' : 'success'"
                                            @click="handleStatusChange(scope.row,'status')">{{ scope.row.status === 1 ? '下架' : '上架' }}</el-button>
                                        </el-button-group> q


                                    </template>
                                </el-table-column>
                            </el-table>
                            <!-- 分页 -->
                            <div class="pagination-container">
                                <el-pagination 
                                    v-model:current-page="purchasePagination.currentPage"
                                    v-model:page-size="purchasePagination.pageSize" 
                                    :total="purchasePagination.total"
                                    :page-sizes="[10, 20, 50, 100]"
                                    @size-change="handlePurchaseSizeChange"
                                    @current-change="handlePurchasePageChange" 
                                    layout="total, sizes, prev, pager, next" />
                            </div>

                            <!-- 添加商品编辑商品对话框 -->
                            <el-dialog 
                                v-model="dialogVisible" 
                                :title="dialogType === 'add' ? '添加商品' : '编辑商品'"
                                width="60%"
                                @close="handleDialogClose">
                                <el-form :model="productForm" :rules="productRules" ref="productFormRef"
                                    label-width="100px">
                                    <el-form-item label="款号" >
                                        <el-input v-model="productForm.id" :disabled="true"
                                            placeholder="自动生成">
                                        </el-input>
                                    </el-form-item>

                                    <el-form-item label="商品名称" prop="name">
                                        <el-input v-model="productForm.name" placeholder="请输入商品名称"></el-input>
                                    </el-form-item>
                                    <el-form-item label="商品状态">
                                        <el-row :gutter="20">
                                            <el-col :span="12">
                                                <el-tag :type="productForm.status === 1 ? 'success' : 'info'" @click="handleStatusChange(productForm, 'status')">{{ productForm.status === 1 ? '上架' : '下架' }}</el-tag>
                                            </el-col>
                                            <el-col :span="12">
                                                <el-tag :type="productForm.is_public === 1 ? 'info' : 'success'" @click="handleStatusChange(productForm, 'is_public')">{{ productForm.is_public === 1 ? '公开' : '私密' }}</el-tag>   
                                                </el-switch>
                                            </el-col>
                                        </el-row>
                                    </el-form-item>

                                    

                                    <!-- 只有管理员(user_type=1)才显示这些价格设置 -->
                                    <template v-if="userInfo.user_type === 1">
                                        <el-row :gutter="10">
                                            <el-col :span="8">
                                                <el-form-item label="A类价格" prop="price_b">
                                                    <el-input-number v-model="productForm.price_b" :precision="2" :step="0.1" :min="0"></el-input-number>
                                                </el-form-item>
                                            </el-col>
                                            <el-col :span="8">
                                                <el-form-item label="B类价格" prop="price_c">
                                                    <el-input-number v-model="productForm.price_c" :precision="2" :step="0.1" :min="0"></el-input-number>
                                                </el-form-item>
                                            </el-col>
                                            <el-col :span="8">
                                                <el-form-item label="C类价格" prop="price_d">
                                                    <el-input-number v-model="productForm.price_d" :precision="2" :step="0.1" :min="0"></el-input-number>
                                                </el-form-item>
                                            </el-col>
                                        </el-row>
                                        <el-row :gutter="10" >
                                            <el-col :span="12">
                                                <el-form-item label="建议零售价" prop="price">
                                                    <el-input-number v-model="productForm.price" :precision="2" :step="0.1" :min="0"></el-input-number>
                                                </el-form-item>
                                            </el-col>
                                            <el-col :span="12">
                                                <el-form-item label="成本价" prop="cost_price">
                                                    <el-input-number v-model="productForm.cost_price" :precision="2" :step="0.1" :min="0"></el-input-number>
                                                </el-form-item>
                                            </el-col>
                                        </el-row>
                                    </template>

                                    <el-form-item label="商品款式" prop="style">
                                        <el-select v-model="productForm.style" placeholder="请选择商品款式">
                                            <el-option
                                                v-for="item in styleOptions"
                                                :key="item.id"
                                                :label="item.name"
                                                :value="item.id">
                                            </el-option>
                                        </el-select>
                                    </el-form-item>

                                    <el-form-item label="颜色">
                                        <div style="margin-bottom: 10px;">
                                            <el-checkbox-group v-model="selectedPresetColors"
                                                @change="handlePresetColorsChange">
                                                <el-checkbox v-for="color in presetColors" :key="color" :label="color">
                                                    <span class="color-label">{{ color }}</span>
                                                </el-checkbox>
                                            </el-checkbox-group>
                                        </div>
                                        <el-select v-model="customColorInput" multiple filterable allow-create
                                            default-first-option placeholder="可输入自定义颜色"
                                            @change="handleCustomColorChange" :reserve-keyword="false"
                                            style="width: 100%">
                                            <el-option v-for="color in customColorOptions" :key="color" :label="color"
                                                :value="color">
                                            </el-option>
                                        </el-select>
                                    </el-form-item>

                                    <el-form-item label="商品图片" prop="images">
                                        <el-upload 
                                            ref="uploadRef"
                                            list-type="picture-card"
                                            :auto-upload="dialogType === 'add' ? false : true" 
                                            :multiple="true"
                                            :http-request="customUpload"
                                            :before-upload="handleBeforeUpload"                                        
                                            :on-success="handleUploadSuccess" 
                                            :on-remove="handleRemove"
                                            :on-error="handleUploadError" 
                                            :on-exceed="handleExceed"
                                            :file-list="fileList" 
                                            :on-preview="handlePictureCardPreview"
                                            hide-on-click-modal
                                            accept=".jpg,.png,.jpeg,.gif,.webp"
                                            @change="handleFileChange">
                                            <el-icon>
                                                <Plus />
                                            </el-icon>
                                        </el-upload>
                                    </el-form-item>

                                    <el-form-item label="商品视频">
                                        <div v-if="videoPreviewUrl" class="video-preview-container" style="margin-top: 15px;">
                                            <video 
                                                :src="videoPreviewUrl" 
                                                controls 
                                                style="max-width: 100%; max-height: 300px; border-radius: 4px;"
                                                >
                                            </video>
                                            <div class="video-preview-actions" style="margin-top: 10px;">
                                                <el-button type="primary" size="small" @click="openVideoPreview">
                                                    <el-icon class="el-icon--left"></el-icon>预览视频
                                                </el-button>
                                                <el-button type="danger" size="small" @click="removeVideo">
                                                    <el-icon class="el-icon--left"><Delete /></el-icon>删除视频
                                                </el-button>
                                            </div>
                                        </div>
                                        <el-upload
                                            ref="videoUploadRef"
                                            class="video-uploader"
                                            :limit="1"
                                            :auto-upload="true"
                                            :multiple="false"
                                            :http-request="customVideoUpload"
                                            :before-upload="handleBeforeVideoUpload"
                                            :on-success="handleVideoUploadSuccess"
                                            :on-remove="handleVideoRemove"
                                            :on-error="handleUploadError"
                                            accept=".mp4,.mov,.avi,.webm"
                                            :file-list="videoFileList">
                                            <el-button type="primary">
                                                <el-icon class="el-icon--left"><Upload /></el-icon>上传视频
                                            </el-button>
                                            <template #tip>
                                                <div class="el-upload__tip">仅支持MP4/MOV/AVI/WebM格式，大小不超过50MB</div>
                                            </template>
                                        </el-upload>
                                        
                                    </el-form-item>

                                    <el-form-item label="商品描述" >
                                        <el-input type="textarea" v-model="productForm.description"
                                            placeholder="请输入商品描述"></el-input>
                                    </el-form-item>

                                    
                                    <el-form-item label="商品规格">
                                        <div class="spec-form-container">
                                            <el-row :gutter="4" class="spec-form-row">
                                                <el-col :span="5">
                                                    <div class="spec-form-item">
                                                        <label style='width: 50px;' >尺寸</label>
                                                        <el-input 
                                                            v-model="productForm.size" 
                                                            placeholder="请输入尺寸">
                                                        </el-input>
                                                    </div>
                                                </el-col>
                                                <el-col :span="6">
                                                    <div class="spec-form-item">
                                                        <label style='width: 50px;' >克重</label>
                                                        <el-input-number 
                                                            v-model="productForm.weight" 
                                                            :min="0" 
                                                            :precision="1" 
                                                            placeholder="请输入克重"
                                                            style="width: 100%">
                                                        </el-input-number>
                                                    </div>
                                                </el-col>
                                                <el-col :span="5">
                                                    <div class="spec-form-item">
                                                        <label style='width: 50px;' >材质</label>
                                                        <el-input 
                                                            v-model="productForm.yarn" 
                                                            placeholder="请输入材质">
                                                        </el-input>
                                                    </div>
                                                </el-col>
                                                <el-col :span="5">
                                                    <div class="spec-form-item">
                                                        <label style='width: 50px;' >成分</label>
                                                        <el-input 
                                                            v-model="productForm.composition" 
                                                            placeholder="请输入成分">
                                                        </el-input>
                                                    </div>
                                                </el-col>
                                            </el-row>
                                        </div>
                                    </el-form-item>

                                    <el-form-item label="颜色库存">
                                        <div class="color-stock-form-item" style="border: 1px solid #dcdfe6; border-radius: 4px; padding: 5px;">
                                            <div v-for="(color, index) in productForm.specs" :key="index" class="color-stock-item">
                                                <el-tag class="color-tag" size="small">{{ color.color }}</el-tag>
                                                <div class="stock-input">
                                                    <el-input-number v-model="color.stock" :min="0" :step="1"
                                                        size="small" controls-position="right" style="width: 100px;"
                                                        placeholder="库存数量">
                                                    </el-input-number>
                                                </div>
                                                <div class="color-image-preview" @click="handleColorImageClick(index)">
                                                    <el-image 
                                                        v-if="color.image" 
                                                        :src="this.cloudtohttps(color.image)" 
                                                        fit="cover"
                                                        style="width: 40px; height: 40px; border-radius: 4px;">
                                                    </el-image>
                                                    <el-button v-else size="small" type="primary" link>
                                                        选择图片
                                                    </el-button>
                                                </div>
                                            </div>
                                        </div>
                                    </el-form-item>

                                    <el-form-item label="库存预警" prop="stock_warning">
                                        <el-input-number v-model="productForm.stock_warning" :min="0" :step="1"
                                            placeholder="库存预警阈值">
                                        </el-input-number>
                                        <div class="el-form-item__description">
                                            当库存低于此值时将发出预警提醒
                                        </div>
                                    </el-form-item>
                                </el-form>
                                <template #footer>
                                    <span class="dialog-footer">
                                        <el-button @click="handleCancel">取消</el-button>
                                        <el-button type="primary" @click="submitProduct">确定</el-button>
                                    </span>
                                </template>
                            </el-dialog>

                            <!-- 添加颜色图片选择对话框 -->
                            <el-dialog
                                v-model="colorImageDialogVisible"
                                title="选择颜色图片"
                                width="60%"
                                append-to-body>
                                <div class="image-select-grid">
                                    <div 
                                        v-for="(file, index) in fileList"
                                        :key="index"
                                        class="image-select-item"
                                        :class="{ 'selected': selectedImageUrl === file.url }"
                                        @click="selectImage(file)">
                                        <el-image 
                                            :src="file.url" 
                                            fit="cover"
                                            style="width: 100%; height: 100%;">
                                        </el-image>
                                    </div>
                                </div>
                                <template #footer>
                                    <span class="dialog-footer">
                                        <el-button @click="colorImageDialogVisible = false">取消</el-button>
                                        <el-button type="primary" @click="confirmColorImage">确定</el-button>
                                    </span>
                                </template>
                            </el-dialog>
                        </div>

                        <!-- 用户管理内容 -->
                        <div v-if="currentPage === '2'" class="user-container">
                            <!-- 用户列表 -->
                            <el-button size="small" type="primary"
                                 @click="handleAddUser">新增用户</el-button>
                                 <el-upload class="excel-uploader" action="/users/import-and-push" :headers="uploadHeaders"
                                    :on-success="handleImportSuccess" :on-error="handleImportError"
                                    :before-upload="beforeImportUpload" accept=".xlsx,.xls" :show-file-list="false">
                                    <el-button type="success">客户导入</el-button>
                                </el-upload>
                            <el-table :data="users" style="width: 100%">
                                <el-table-column prop="id" label="ID" width="80"></el-table-column>
                                <el-table-column prop="username" label="用户名" width="120"></el-table-column>
                                <el-table-column label="头像" width="80">
                                    <template #default="scope">
                                        <el-avatar :size="40" :src="scope.row.avatar">
                                            <img
                                                src="https://cube.elemecdn.com/e/fd/0fc7d20532fdaf769a25683617711png.png" />
                                        </el-avatar>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="nickname" label="昵称" width="120"></el-table-column>
                                <el-table-column prop="phone" label="电话" width="120"></el-table-column>
                                <el-table-column prop="address" label="地址"></el-table-column>
                                <el-table-column prop="contact" label="联系人" width="100"></el-table-column>
                                <el-table-column label="用户类型" width="100">
                                    <template #default="scope">
                                        <el-tag :type="scope.row.user_type === 0 ? 'info' : scope.row.user_type === 2 ? 'success' : scope.row.user_type === 3 ? 'warning' : scope.row.user_type === 4 ? 'danger' : scope.row.user_type === 5 ? 'warning' : scope.row.user_type === 6 ? 'info' : 'danger'">
                                            {{ scope.row.user_type === 0 ? '零售客户' : scope.row.user_type === 2 ? 'A类客户' : scope.row.user_type === 3 ? 'B类客户' : scope.row.user_type === 4 ? 'C类客户' : scope.row.user_type === 5 ? 'STAFF' : scope.row.user_type === 6 ? '普通管理员' : '未知' }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="status" label="状态" width="80">
                                    <template #default="scope">
                                        <el-tag :type="scope.row.status === 1 ? 'success' : 'danger'">
                                            {{ scope.row.status === 1 ? '启用' : '禁用' }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="created_at" label="注册时间" width="160">
                                    <template #default="scope">
                                        {{ formatDate(scope.row.created_at) }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="180" fixed="right" >
                                    <template #default="scope" >
                                        <el-button-group>
                                            <el-button size="small" type="primary"  v-if="userInfo.role === 'admin'"
                                                @click="handleEditUser(scope.row)">编辑</el-button>
                                            <el-button size="small" v-if="userInfo.role === 'admin'"
                                                :type="scope.row.status === 1 ? 'danger' : 'success'"
                                                @click="handleToggleUserStatus(scope.row)">
                                                {{ scope.row.status === 1 ? '禁用' : '启用' }}
                                            </el-button>
                                            <el-button size="small" type="primary" v-if="userInfo.role === 'admin'"
                                                @click="handleDeleteUser(scope.row)">删除</el-button>
                                        </el-button-group>
                                    </template>
                                </el-table-column>
                            </el-table>

                            <!-- 分页 -->
                            <div class="pagination-container" style="margin-top: 20px; text-align: right;">
                                <el-pagination v-model:current-page="userPagination.currentPage"
                                    v-model:page-size="userPagination.pageSize" :page-sizes="pageSizeOptions"
                                    :total="userPagination.total" layout="total, sizes, prev, pager, next, jumper"
                                    @size-change="handleUserSizeChange" @current-change="handleUserCurrentChange" />
                            </div>

                            <!-- 编辑用户对话框 -->
                            <el-dialog v-model="userDialogVisible" :title="userDialogStatus === 'add' ? '新增用户' : '编辑用户'" width="50%">
                                <el-form :model="userForm" :rules="userFormRules" ref="userFormRef" label-width="100px">
                                    <el-form-item label="用户名" prop="username">
                                        <el-input v-model="userForm.username" :disabled="userDialogStatus === 'edit'"></el-input>
                                    </el-form-item>
                                    <el-form-item label="用户类型" prop="user_type">
                                        <el-select v-model="userForm.user_type" placeholder="请选择用户类型">
                                            <el-option label="零售客户" :value="0"></el-option>
                                            <el-option label="A类客户" :value="2"></el-option>
                                            <el-option label="B类客户" :value="3"></el-option>
                                            <el-option label="C类客户" :value="4"></el-option>
                                            <el-option label="普通管理员" :value="6"></el-option>
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item label="密码" prop="password" v-if="userDialogStatus === 'add'"> 
                                        <el-input v-model="userForm.password" type="password"></el-input>
                                    </el-form-item>
                                    <el-form-item label="昵称" prop="nickname">
                                        <el-input v-model="userForm.nickname"></el-input>
                                    </el-form-item>
                                    <el-form-item label="电话" prop="phone">
                                        <el-input v-model="userForm.phone"></el-input>
                                    </el-form-item>
                                    <el-form-item label="地址">
                                        <el-input v-model="userForm.address" type="textarea"></el-input>
                                    </el-form-item>
                                    <el-form-item label="联系人">
                                        <el-input v-model="userForm.contact"></el-input>
                                    </el-form-item>
                                    <el-form-item label="状态">
                                        <el-switch v-model="userForm.status" :active-value="1" :inactive-value="0"
                                            active-text="启用" inactive-text="禁用">
                                        </el-switch>
                                    </el-form-item>
                                </el-form>
                                <template #footer>
                                    <span class="dialog-footer">
                                        <el-button @click="userDialogVisible = false">取消</el-button>
                                        <el-button type="primary" @click="submitUserForm" v-if="userDialogStatus === 'edit'">确定</el-button>
                                        <el-button type="primary" @click="handleAddUserSubmit" v-if="userDialogStatus === 'add'">注册</el-button>
                                    </span>
                                </template>
                            </el-dialog>
                        </div>

                        <!-- 系统设置内容 -->
                        <div v-if="currentPage === '5'" class="content-container">
                            <h2>系统设置</h2>
                            <div class="settings-container" style="padding: 20px;">
                                <el-row :gutter="20">
                                    <el-col :span="8" >
                                        <el-card shadow="hover" class="settings-card">
                                            <template #header>
                                                <div class="card-header">
                                                    <span>系统基础设置</span>
                                                </div>
                                            </template>
                                            <div class="card-content">
                                                <el-button type="primary" @click="showSystemSettings">设置</el-button>
                                            </div>
                                        </el-card>
                                    </el-col>
                                    <el-col :span="8">
                                        <el-card shadow="hover" class="settings-card">
                                            <template #header>
                                                <div class="card-header">
                                                    <span>商品款式管理</span>
                                                </div>
                                                
                                            </template>     
                                            <el-button type="primary" @click="showStyleSettings">管理</el-button>                                      
                                        </el-card>
                                    </el-col>
                                    <el-col :span="8">
                                        <el-card shadow="hover" class="settings-card">
                                            <template #header>
                                                <div class="card-header">
                                                    <span>推荐商品管理</span>
                                                </div>
                                            </template>
                                            <el-button type="primary" @click="showRecommendedProducts">管理</el-button>
                                        </el-card>
                                    </el-col>
                                    <el-col :span="8">
                                        <el-card shadow="hover" class="settings-card">
                                            <template #header>
                                                <div class="card-header">
                                                    <span>暗推产品管理</span>
                                                </div>
                                            </template>
                                            <el-button type="primary" @click="showHiddenProducts">管理</el-button>
                                        </el-card>
                                    </el-col>
                                </el-row>
                            </div>
                        </div>

                        <!-- 数据统计内容 -->
                        <div v-if="currentPage === '6'" class="statistics-container">
                            <div class="filter-bar">
                                <el-radio-group v-model="timeRange" @change="loadStatistics">
                                    <el-radio-button label="all">全部</el-radio-button>
                                    <el-radio-button label="today">今日</el-radio-button>
                                    <el-radio-button label="week">本周</el-radio-button>
                                    <el-radio-button label="month">本月</el-radio-button>
                                </el-radio-group>
                            </div>

                            <!-- 总体数据卡片 -->
                            <el-row :gutter="20" class="summary-cards">
                                <el-col :span="6">
                                    <el-card shadow="hover">
                                        <template #header>
                                            <div class="card-header">
                                                <span>总浏览量</span>
                                            </div>
                                        </template>
                                        <div class="card-value">{{ statistics.summary.total_views || 0 }}</div>
                                    </el-card>
                                </el-col>
                                <el-col :span="6">
                                    <el-card shadow="hover">
                                        <template #header>
                                            <div class="card-header">
                                                <span>被浏览商品数</span>
                                            </div>
                                        </template>
                                        <div class="card-value">{{ statistics.summary.viewed_products || 0 }}</div>
                                    </el-card>
                                </el-col>
                                <el-col :span="6">
                                    <el-card shadow="hover">
                                        <template #header>
                                            <div class="card-header">
                                                <span>采购单数</span>
                                            </div>
                                        </template>
                                        <div class="card-value">{{ statistics.summary.total_orders || 0 }}</div>
                                    </el-card>
                                </el-col>
                                <el-col :span="6">
                                    <el-card shadow="hover">
                                        <template #header>
                                            <div class="card-header">
                                                <span>采购总数量</span>
                                            </div>
                                        </template>
                                        <div class="card-value">{{ statistics.summary.total_quantity || 0 }}</div>
                                    </el-card>
                                </el-col>
                            </el-row>

                            <!-- 排行榜 -->
                            <el-row :gutter="20" class="rank-lists">
                                <el-col :span="12">
                                    <el-card shadow="hover">
                                        <template #header>
                                            <div class="card-header">
                                                <span>浏览量排行</span>
                                            </div>
                                        </template>
                                        <el-table :data="statistics.top_viewed" stripe>
                                            <el-table-column type="index" label="排名" width="80"></el-table-column>
                                            <el-table-column prop="id" label="款号" width="100"></el-table-column>
                                            <el-table-column prop="name" label="商品名称"></el-table-column>
                                            <el-table-column prop="view_count" label="浏览量"
                                                width="100"></el-table-column>
                                        </el-table>
                                    </el-card>
                                </el-col>
                                <el-col :span="12">
                                    <el-card shadow="hover">
                                        <template #header>
                                            <div class="card-header">
                                                <span>采购量排行</span>
                                            </div>
                                        </template>
                                        <el-table :data="statistics.top_purchased" stripe>
                                            <el-table-column type="index" label="排名" width="80"></el-table-column>
                                            <el-table-column prop="id" label="款号" width="100"></el-table-column>
                                            <el-table-column prop="name" label="商品名称"></el-table-column>
                                            <el-table-column prop="order_count" label="采购次数"
                                                width="100"></el-table-column>
                                            <el-table-column prop="total_quantity" label="采购总量"
                                                width="100"></el-table-column>
                                        </el-table>
                                    </el-card>
                                </el-col>
                            </el-row>
                        </div>

                        <!-- 采购单管理内容 -->
                        <div v-if="currentPage === '3'" class="content-container">
                            <!-- 搜索栏 -->
                            <div class="toolbar">
                                <div class="search-bar">
                                    <el-input v-model="purchaseSearch.keyword" placeholder="搜索采购单号/采购人" clearable
                                        @keyup.enter="handlePurchaseSearch">
                                        <template #append>
                                            <el-button @click="handlePurchaseSearch">搜索</el-button>
                                        </template>
                                    </el-input>
                                </div>
                                <div class="action-buttons">
                                    <el-button type="primary" @click="showPlaceOrderDialog">代客下单</el-button>
                                </div>
                                
                            </div>
                            <div class="date-filter">
                                <el-date-picker
                                    v-model="purchaseSearch.dateRange"
                                    type="daterange"
                                    range-separator="至"
                                    start-placeholder="开始日期"
                                    end-placeholder="结束日期"
                                    :shortcuts="dateShortcuts"
                                    @change="handlePurchaseDateRangeChange"
                                    value-format="YYYY-MM-DD"
                                    format="YYYY年MM月DD日"
                                    :default-time="[
                                        new Date(2000, 1, 1, 0, 0, 0),
                                        new Date(2000, 1, 1, 23, 59, 59)
                                    ]"
                                    timezone="Asia/Shanghai"
                                />
                               
                            </div>
                            <!-- 采购单列表 -->
                            <el-table :data="purchaseOrders" v-loading="purchaseLoading" border stripe>
                                <el-table-column prop="order_number" label="采购单号" width="180">
                                    <template #default="scope">
                                        {{ scope.row.order_number }}
                                    </template>
                                </el-table-column>
                                <el-table-column prop="user_name" label="客户名称" width="120">
                                    <template #default="scope">
                                        {{ scope.row.user?.nickname || scope.row.user?.username || '未知' }}

                                    </template>
                                </el-table-column>
                                <el-table-column prop="order_number" label="采购数量" width="180">
                                    <template #default="scope">
                                        {{ scope.row.total_quantity }}
                                    </template>
                                </el-table-column>
                                <el-table-column prop="order_number" label="采购金额" width="180" v-if="false">
                                    <template #default="scope">
                                        {{ scope.row.total_amount }}
                                    </template>
                                </el-table-column>
                                <el-table-column prop="status" label="状态" width="100">
                                    <template #default="scope">
                                        <el-tag :type="getPurchaseStatusType(scope.row.status)">
                                            {{ getPurchaseStatusText(scope.row.status) }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="created_at" label="创建时间" width="180">
                                    <template #default="scope">
                                        {{ formatDate(scope.row.created_at) }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="200" fixed="right">
                                    <template #default="scope">
                                        <el-button-group>
                                            <el-button size="small"
                                                @click="viewPurchaseDetail(scope.row)">查看</el-button>
                                            <el-button v-if="scope.row.status === 0" size="small" type="success"
                                                @click="handleAcceptPurchase(scope.row)">接受</el-button>
                                            <el-button v-if="scope.row.status === 0 || scope.row.status === 1" size="small" type="danger"
                                                @click="handleCancelPurchase(scope.row)">取消</el-button>
                                            <el-button size="small" type="primary"
                                                @click="createFromPurchase(scope.row.id)" v-if = "scope.row.status === 1 ">一键发货</el-button>
                                        </el-button-group>
                                    </template>
                                </el-table-column>
                            </el-table>

                            <!-- 分页 -->
                            <div class="pagination-container">
                                <el-pagination v-model:current-page="purchasePagination.currentPage"
                                    v-model:page-size="purchasePagination.pageSize" :total="purchasePagination.total"
                                    @current-change="handlePurchasePageChange" layout="total, prev, pager, next" />
                            </div>

                            
                        </div>

                        <!-- 配送单管理内容 -->
                        <div v-if="currentPage === '4'" class="content-container">
                            <div class="module-header">
                                <h2 class="module-title">发货单管理</h2>
                                <div class="module-actions">
                                    <el-button @click="loadDeliveryOrders" icon="Refresh">刷新</el-button>
                                    <el-button @click="exportDeliveryData" icon="Download">导出数据</el-button>
                                </div>
                            </div>
                            
                            <!-- 搜索和筛选 -->
                            <div class="filter-container">
                                <div class="search-section">
                                    <el-input 
                                        v-model="deliverySearch.keyword" 
                                        placeholder="搜索发货单号/客户名称/电话" 
                                        clearable
                                        @keyup.enter="handleDeliverySearch"
                                        prefix-icon="Search"
                                        class="search-input"
                                    >
                                        <template #append>
                                            <el-button @click="handleDeliverySearch">搜索</el-button>
                                        </template>
                                    </el-input>
                                    
                                    <div class="date-filter">
                                        <el-date-picker
                                            v-model="deliverySearch.dateRange"
                                            type="daterange"
                                            range-separator="至"
                                            start-placeholder="开始日期"
                                            end-placeholder="结束日期"
                                            :shortcuts="dateShortcuts"
                                            @change="handleDateRangeChange"
                                            value-format="YYYY-MM-DD"
                                            format="YYYY年MM月DD日"
                                            :default-time="[
                                                new Date(2000, 1, 1, 0, 0, 0),
                                                new Date(2000, 1, 1, 23, 59, 59)
                                            ]"
                                            timezone="Asia/Shanghai"
                                        />
                                       
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 发货单管理 -->
                            <div>
                                <el-tabs v-model="currentDeliveryTab" @tab-change="switchDeliveryTab" type="card">
                                    <el-tab-pane 
                                        v-for="(tab, index) in deliveryTabs" 
                                        :key="index" 
                                        :label="tab.name" 
                                        :name="index"
                                    >
                                        <template #label>
                                            <span>{{ tab.name }}</span>
                                            <el-badge :value="getDeliveryCount(tab.status)" :type="getDeliveryBadgeType(tab.status)" :hidden="getDeliveryCount(tab.status) === 0" />
                                        </template>
                                    </el-tab-pane>
                                </el-tabs>                            
                                <el-table 
                                    :data="deliveryOrders" 
                                    v-loading="deliveryLoading" 
                                    border 
                                    stripe
                                    :empty-text="currentDeliveryTab === 0 ? '暂无待发货单据，可以从采购单创建发货单' : '暂无发货单数据'"
                                    style="height: calc(100vh - 400px)"
                                    @selection-change="handleDeliverySelectionChange"
                                >
                                    <el-table-column type="selection" width="55" >
                                    </el-table-column>
                                    <el-table-column prop="orderNumber" label="订单号" min-width="180" show-overflow-tooltip>
                                        <template #default="scope">
                                            <el-button link type="primary" @click="viewDeliveryDetail(scope.row)">
                                                {{ scope.row.order_number || scope.row.orderNumber }}
                                            </el-button>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="客户信息" min-width="200">
                                        <template #default="scope">
                                            <div class="customer-info">
                                                <div>{{ scope.row.customerName || scope.row.user?.nickname || '未知客户' }}</div>
                                                <div class="secondary-text">{{ scope.row.customerPhone || scope.row.user?.phone || '无电话' }}</div>
                                            </div>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="商品信息" min-width="180">
                                        <template #default="scope">
                                            <div>总数量: {{ scope.row.total_quantity }}件</div>
                                            <!-- 只在待发货状态(status=0)显示待发数量 -->
                                            <div v-if="scope.row.total_quantity - scope.row.total_shipped_quantity > 0">待发数量: {{ scope.row.total_quantity - scope.row.total_shipped_quantity }}件</div>
                                            <!-- 商品明细提示，所有状态都显示 -->
                                            <div class="secondary-text" v-if="scope.row.items && scope.row.items.length > 0">
                                                <el-tooltip placement="top">
                                                    <template #content>
                                                        <div v-for="(item, idx) in scope.row.items" :key="idx">
                                                            {{ item.product_name }} {{ item.color ? `(${item.color})` : '' }}: {{ item.quantity }}件
                                                        </div>
                                                    </template>
                                                    <el-tag size="small" :type="scope.row.status === 0 ? 'warning' : 'info'">查看商品明细</el-tag>
                                                </el-tooltip>
                                            </div>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="status" label="状态" width="100">
                                        <template #default="scope">
                                            <el-tag :type="getDeliveryStatusType(scope.row.status)">
                                                {{ getDeliveryStatusTextWithPartial(scope.row) }}
                                            </el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="创建/更新时间" min-width="200">
                                        <template #default="scope">
                                            <div>创建: {{ formatDate(scope.row.createdAt || scope.row.created_at) }}</div>
                                            <div class="secondary-text" v-if="scope.row.updatedAt">更新: {{ formatDate(scope.row.updatedAt) }}</div>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="操作" width="200" fixed="right">
                                        <template #default="scope">
                                            <div class="action-buttons">
                                                <template v-if="currentDeliveryTab === 0">
                                                    <!-- 待发货状态 -->
                                                    <el-button type="primary" size="small" @click="createDeliveryFromOrder(scope.row)">创建发货单</el-button>
                                                </template>
                                                <template v-else>
                                                    <el-button-group>
                                                        <!-- 查看按钮对所有状态都显示 -->
                                                        <el-button 
                                                            size="small"
                                                            type="primary"
                                                            plain
                                                            @click="viewPurchaseDetail(scope.row)">
                                                            查看详情
                                                        </el-button>

                                                        <!-- 待发货状态显示发货和取消按钮 -->
                                                        <template v-if="scope.row.status === 0">
                                                            <el-button 
                                                                size="small"
                                                                type="success"
                                                                @click="handleDelivery(scope.row)">
                                                                发货
                                                            </el-button>
                                                            <el-button 
                                                                size="small"
                                                                type="danger"
                                                                @click="cancelDelivery(scope.row)">
                                                                取消
                                                            </el-button>
                                                        </template>

                                                        <!-- 已发货状态显示完成按钮 -->
                                                        <!--template v-if="scope.row.status === 1" >
                                                            <el-button 
                                                                size="small"
                                                                type="success"
                                                                @click="completeDelivery(scope.row)">
                                                                完成
                                                            </el-button>
                                                        </template-->

                                                        <!-- 打印按钮对所有状态都显示 -->
                                                        <el-button 
                                                            size="small"
                                                            type="info"
                                                            plain
                                                            @click="printDelivery(scope.row)">
                                                            打印
                                                        </el-button>
                                                    </el-button-group>
                                                </template>
                                            </div>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                            
                            <!-- 批量操作工具栏 -->
                            <div class="batch-actions" v-if="selectedDeliveries.length > 0">
                                <span class="selected-count">已选择 {{ selectedDeliveries.length }} 项</span>
                                <el-button-group>
                                    <el-button size="small" type="primary" @click="batchMarkAsShipped" v-if="canBatchShip">批量标记发货</el-button>
                                    <el-button size="small" type="success" @click="batchMarkAsCompleted" v-if="canBatchComplete">批量标记完成</el-button>
                                    <el-button size="small" type="danger" @click="batchDelete" v-if="canBatchDelete">批量删除</el-button>
                                    <el-button size="small" @click="batchPrint">批量打印</el-button>
                                </el-button-group>
                            </div>
                            
                            <!-- 分页 -->
                            <div class="pagination-container">
                                <el-pagination
                                    v-model:current-page="deliveryPagination.currentPage"
                                    v-model:page-size="deliveryPagination.pageSize"
                                    :page-sizes="[10, 20, 50, 100]"
                                    :total="deliveryPagination.total"
                                    @current-change="handleDeliveryPageChange"
                                    @size-change="handleDeliverySizeChange"
                                    layout="total, sizes, prev, pager, next, jumper"
                                />
                            </div>
                        </div>

                        <!-- 推送单管理内容 -->
                        <div v-if="currentPage === '7'" class="content-container">
                            <!-- 搜索栏 -->
                            <div class="toolbar">
                                <div class="search-bar">
                                    <el-input v-model="pushSearch.keyword" placeholder="搜索推送单号/推送对象" clearable @keyup.enter="handlePushSearch">
                                        <template #append>
                                            <el-button @click="handlePushSearch">搜索</el-button>
                                        </template>
                                    </el-input>
                                </div>
                            </div>
                            
                            <!-- 状态筛选 -->
                            <div class="status-tabs">
                                <el-radio-group v-model="pushSearch.status" @change="handlePushSearch">
                                    <el-radio-button label="all">
                                        全部
                                        <el-tag type="info" size="small" class="count-tag">{{ pushStats.total || 0 }}</el-tag>
                                    </el-radio-button>
                                    <el-radio-button label="0">
                                        有效
                                        <el-tag type="success" size="small" class="count-tag">{{ pushStats.active || 0 }}</el-tag>
                                    </el-radio-button>
                                    <el-radio-button label="1">
                                        已失效
                                        <el-tag type="danger" size="small" class="count-tag">{{ pushStats.inactive || 0 }}</el-tag>
                                    </el-radio-button>
                                </el-radio-group>
                            </div>
                            
                            <!-- 推送单列表 -->
                            <el-table :data="pushOrders" v-loading="pushLoading" border stripe>
                                <el-table-column prop="order_number" label="推送单号" width="180"></el-table-column>
                                <el-table-column prop="target_name" label="推送对象" width="120"></el-table-column>
                                <el-table-column prop="creator_name" label="创建人" width="120"></el-table-column>
                                <el-table-column prop="product_count" label="商品数量" width="100"></el-table-column>
                                <el-table-column prop="status" label="状态" width="100">
                                    <template #default="scope">
                                        <el-tag :type="scope.row.status === 0 ? 'success' : 'danger'">
                                            {{ scope.row.status === 0 ? '有效' : '已失效' }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="created_at" label="创建时间" width="180">
                                    <template #default="scope">
                                        {{ formatDate(scope.row.created_at) }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="200" fixed="right">
                                    <template #default="scope">
                                        <el-button-group>
                                            <el-button size="small" @click="viewPushDetail(scope.row)">查看</el-button>
                                            <el-button v-if="scope.row.status === 0" size="small" type="danger"
                                                @click="handleInvalidatePush(scope.row)">设为失效</el-button>
                                            <el-button v-if="scope.row.status === 1" size="small" type="success"
                                                @click="handleActivatePush(scope.row)">设为有效</el-button>
                                            <el-button size="small" type="danger" @click="handleDeletePush(scope.row)">删除</el-button>
                                        </el-button-group>
                                    </template>
                                </el-table-column>
                            </el-table>
                            
                            <!-- 分页 -->
                            <div class="pagination-container">
                                <el-pagination v-model:current-page="pushPagination.currentPage"
                                    v-model:page-size="pushPagination.pageSize" :total="pushPagination.total"
                                    @current-change="handlePushPageChange" layout="total, prev, pager, next" />
                            </div>
                            
                            <!-- 推送单详情对话框 -->
                            <el-dialog v-model="pushDetailVisible" title="推送单详情" width="60%">
                                <div v-if="currentPushOrder">
                                    <el-descriptions :column="2" border>
                                        <el-descriptions-item label="推送单号">{{ currentPushOrder.order_number }}</el-descriptions-item>
                                        <el-descriptions-item label="推送对象">{{ currentPushOrder.target_name }}</el-descriptions-item>
                                        <el-descriptions-item label="创建人">{{ currentPushOrder.creator_name }}</el-descriptions-item>
                                        <el-descriptions-item label="创建时间">{{ formatDate(currentPushOrder.created_at) }}</el-descriptions-item>
                                        <el-descriptions-item label="状态">
                                            <el-tag :type="currentPushOrder.status === 0 ? 'success' : 'danger'">
                                                {{ currentPushOrder.status === 0 ? '有效' : '已失效' }}
                                            </el-tag>
                                        </el-descriptions-item>
                                    </el-descriptions>
                                    
                                    <el-divider>商品明细</el-divider>
                                    <el-table :data="currentPushOrder.products" border>
                                        <el-table-column prop="name" label="商品名称"></el-table-column>
                                        <el-table-column prop="price" label="价格" width="120">
                                            <template #default="scope">
                                                ¥{{ scope.row.price }}
                                            </template>
                                        </el-table-column>
                                        <el-table-column prop="specs" label="规格" width="200">
                                            <template #default="scope">
                                                <el-tag v-for="spec in scope.row.specs" :key="spec.color" size="small" style="margin: 2px">
                                                    {{ spec.color }}
                                                </el-tag>
                                            </template>
                                        </el-table-column>
                                    </el-table>
                                    
                                    <div v-if="currentPushOrder.qrcode_path" style="margin-top: 20px; text-align: center;">
                                        <el-image :src="getImageUrl(currentPushOrder.qrcode_path)" style="width: 200px; height: 200px;"
                                            :preview-src-list="[getImageUrl(currentPushOrder.qrcode_path)]">
                                        </el-image>
                                    </div>
                                </div>
                            </el-dialog>
                        </div>
                    </div>
                </el-main>
            </el-container>
        </el-container>

    <!-- 个人信息编辑对话框 -->
    <el-dialog v-model="profileDialogVisible" title="编辑个人信息" width="50%">
        <el-form :model="profileForm" :rules="profileFormRules" ref="profileFormRef" label-width="100px">
            <el-form-item label="用户名">
                <el-input v-model="profileForm.username" disabled></el-input>
            </el-form-item>
            <el-form-item label="昵称" prop="nickname">
                <el-input v-model="profileForm.nickname"></el-input>
            </el-form-item>
            <el-form-item label="电话" prop="phone">
                <el-input v-model="profileForm.phone"></el-input>
            </el-form-item>
            <el-form-item label="地址">
                <el-input v-model="profileForm.address" type="textarea"></el-input>
            </el-form-item>
            <el-form-item label="联系人">
                <el-input v-model="profileForm.contact"></el-input>
            </el-form-item>
        </el-form>
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="profileDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="submitProfile">确定</el-button>
            </span>
        </template>
    </el-dialog>

    <!-- 系统管理对话框 -->
    <el-dialog 
        v-model="systemSettingsVisible" 
        title="系统设置" 
        width="500px"
        :close-on-click-modal="false"
        :show-close="true"
        destroy-on-close
    >
        <el-form :model="systemSettings" label-width="120px">
            <el-form-item label="系统名称">
                <el-input v-model="systemSettings.system_name"></el-input>
            </el-form-item>
            <el-form-item label="系统描述">
                <el-input type="textarea" v-model="systemSettings.system_description"></el-input>
            </el-form-item>
            <el-form-item label="系统Logo">
                <el-upload
                    class="avatar-uploader"
                    action="/upload"
                    :show-file-list="false"
                    :on-success="handleLogoSuccess"
                    :before-upload="beforeLogoUpload">
                    <img v-if="systemSettings.logo_url" :src="systemSettings.logo_url" class="avatar">
                    <el-icon v-else><Plus /></el-icon>
                </el-upload>
            </el-form-item>
        </el-form>
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="closeSystemSettings">取消</el-button>
                <el-button type="primary" @click="saveSystemSettings">保存</el-button>
            </span>
        </template>
    </el-dialog>                                                      

    <!-- 商品款式设置对话框 -->
    <el-dialog title="商品款式设置" v-model="styleSettingsVisible" width="600px">
        <el-table :data="product_types" border style="width: 100%">
            <el-table-column prop="id" label="ID" width="80"></el-table-column>
            <el-table-column prop="name" label="款式名称">
                <template #default="scope">
                    <el-input v-model="scope.row.name" placeholder="请输入款式名称"></el-input>
                </template>
            </el-table-column>
            <el-table-column label="操作" width="160">
                <template #default="scope">
                    <el-button-group>
                        <el-button 
                            type="primary" 
                            size="small"
                            :disabled="scope.$index === 0"
                            @click="moveStyle(scope.$index, 'up')">
                            上移
                        </el-button>
                        <el-button 
                            type="primary" 
                            size="small"
                            :disabled="scope.$index === product_types.length - 1"
                            @click="moveStyle(scope.$index, 'down')">
                            下移
                        </el-button>
                        <el-button type="danger" size="small" @click="handleRemoveStyle(scope.$index)">删除</el-button>
                    </el-button-group>
                </template>
            </el-table-column>
        </el-table>
        <div style="margin-top: 20px;">
            <el-button type="primary" @click="handleAddStyle">添加款式</el-button>
        </div>
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="styleSettingsVisible = false">取消</el-button>
                <el-button type="primary" @click="saveStyleSettings">保存</el-button>
            </span>
        </template>
    </el-dialog>

    <!-- 添加推荐商品管理弹窗 -->
    <el-dialog v-model="recommendedProductsVisible" title="推荐商品管理" width="800px">
        <div class="recommended-products-container">
            <div class="search-bar" style="margin-bottom: 20px;">
                <el-input
                    v-model="recommendedSearch.keyword"
                    placeholder="搜索商品名称或ID"
                    clearable
                    @keyup.enter="searchProductsForRecommended"
                >
                    <template #append>
                        <el-button @click="searchProductsForRecommended">搜索</el-button>
                    </template>
                </el-input>
            </div>
            
            <div v-if="searchProductsResults.length > 0" class="search-results">
                <h4>搜索结果</h4>
                <el-table :data="searchProductsResults" border style="margin-bottom: 20px;">
                    <el-table-column prop="id" label="ID" width="80"></el-table-column>
                    <el-table-column prop="name" label="商品名称"></el-table-column>
                    <el-table-column label="图片" width="100">
                        <template #default="scope">
                            <el-image 
                                v-if="scope.row.images && scope.row.images.length > 0"
                                style="width: 50px; height: 50px; cursor: pointer; border-radius: 4px; overflow: hidden;" 
                                :src="handleImageUrl(scope.row.images[0])"
                                :preview-src-list="scope.row.images.map(img => handleImageUrl(img))"
                                fit="cover">
                            </el-image>
                        </template>
                    </el-table-column>
                    <el-table-column label="操作" width="120">
                        <template #default="scope">
                            <el-button 
                                type="primary" 
                                size="small" 
                                @click="addToRecommended(scope.row)"
                                :disabled="isProductRecommended(scope.row.id)">
                                添加
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
            
            <div class="recommended-list">
                <h4>当前推荐商品 ({{recommendedProducts.length}})</h4>
                <el-empty v-if="recommendedProducts.length === 0" description="暂无推荐商品"></el-empty>
                <el-table 
                    v-else 
                    :data="recommendedProducts" 
                    row-key="id"
                    border 
                    style="width: 100%;">
                    <el-table-column type="index" width="50" label="排序"></el-table-column>
                    <el-table-column prop="id" label="ID" width="80"></el-table-column>
                    <el-table-column prop="name" label="商品名称"></el-table-column>
                    <el-table-column label="图片" width="100">
                        <template #default="scope">
                            <el-image 
                                v-if="scope.row.images && scope.row.images.length > 0"
                                style="width: 50px; height: 50px; cursor: pointer; border-radius: 4px; overflow: hidden;" 
                                :src="handleImageUrl(scope.row.images[0])"
                                :preview-src-list="scope.row.images.map(img => handleImageUrl(img))"
                                fit="cover">
                            </el-image>
                        </template>
                    </el-table-column>
                    <el-table-column label="操作" width="200">
                        <template #default="scope">
                            <el-button-group>
                                <el-button 
                                    type="primary" 
                                    size="small"
                                    :disabled="scope.$index === 0"
                                    @click="moveRecommendedProduct(scope.$index, 'up')">
                                    上移
                                </el-button>
                                <el-button 
                                    type="primary" 
                                    size="small"
                                    :disabled="scope.$index === recommendedProducts.length - 1"
                                    @click="moveRecommendedProduct(scope.$index, 'down')">
                                    下移
                                </el-button>
                                <el-button 
                                    type="danger" 
                                    size="small"
                                    @click="removeFromRecommended(scope.$index)">
                                    删除
                                </el-button>
                            </el-button-group>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
        </div>
    </el-dialog>

    <!-- 批量修改状态对话框 -->
    <el-dialog title="批量修改状态" v-model="batchStatusDialogVisible" width="400px">
        <el-form :model="batchStatusForm" label-width="80px">
            <el-form-item label="状态">
                <el-radio-group v-model="batchStatusForm.status">
                    <el-radio :label="1">上架</el-radio>
                    <el-radio :label="0">下架</el-radio>
                </el-radio-group>
            </el-form-item>
        </el-form>
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="batchStatusDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="handleBatchStatusUpdate">确定</el-button>
            </span>
        </template>
    </el-dialog>

    <!-- 批量修改公开状态对话框 -->
    <el-dialog title="批量修改公开状态" v-model="batchPublicDialogVisible" width="400px">
        <el-form :model="batchPublicForm" label-width="80px">
            <el-form-item label="状态">
                <el-radio-group v-model="batchPublicForm.is_public">
                    <el-radio :label="1">公开</el-radio>
                    <el-radio :label="0">私密</el-radio>
                </el-radio-group>
            </el-form-item>
        </el-form>
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="batchPublicDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="handleBatchPublicUpdate">确定</el-button>
            </span>
        </template>
    </el-dialog>

    <!-- 添加暗推产品管理弹窗 -->
    <el-dialog v-model="hiddenProductsVisible" title="暗推产品管理" width="800px">
        <div class="hidden-products-container">
            <div class="search-bar" style="margin-bottom: 20px;">
                <el-input
                    v-model="hiddenSearch.keyword"
                    placeholder="搜索商品名称或ID"
                    clearable
                    @keyup.enter="searchProductsForHidden"
                >
                    <template #append>
                        <el-button @click="searchProductsForHidden">搜索</el-button>
                    </template>
                </el-input>
            </div>
            
            <div v-if="searchProductsResults.length > 0" class="search-results">
                <h4>搜索结果</h4>
                <el-table :data="searchProductsResults" border style="margin-bottom: 20px;">
                    <el-table-column prop="id" label="ID" width="80"></el-table-column>
                    <el-table-column prop="name" label="商品名称"></el-table-column>
                    <el-table-column label="图片" width="100">
                        <template #default="scope">
                            <el-image 
                                v-if="scope.row.images && scope.row.images.length > 0"
                                style="width: 50px; height: 50px; cursor: pointer; border-radius: 4px; overflow: hidden;" 
                                :src="handleImageUrl(scope.row.images[0])"
                                :preview-src-list="scope.row.images.map(img => handleImageUrl(img))"
                                fit="cover">
                            </el-image>
                        </template>
                    </el-table-column>
                    <el-table-column label="操作" width="120">
                        <template #default="scope">
                            <el-button 
                                type="primary" 
                                size="small" 
                                @click="addToHidden(scope.row)"
                                :disabled="isProductHidden(scope.row.id)">
                                添加
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
            
            <div class="hidden-list">
                <h4>当前暗推产品 ({{hiddenProducts.length}})</h4>
                <el-empty v-if="hiddenProducts.length === 0" description="暂无暗推产品"></el-empty>
                <el-table 
                    v-else 
                    :data="hiddenProducts" 
                    row-key="id"
                    border 
                    style="width: 100%;">
                    <el-table-column type="index" width="50" label="排序"></el-table-column>
                    <el-table-column prop="id" label="ID" width="80"></el-table-column>
                    <el-table-column prop="name" label="商品名称"></el-table-column>
                    <el-table-column label="图片" width="100">
                        <template #default="scope">
                            <el-image 
                                v-if="scope.row.images && scope.row.images.length > 0"
                                style="width: 50px; height: 50px; cursor: pointer; border-radius: 4px; overflow: hidden;" 
                                :src="handleImageUrl(scope.row.images[0])"
                                :preview-src-list="scope.row.images.map(img => handleImageUrl(img))"
                                fit="cover">
                            </el-image>
                        </template>
                    </el-table-column>
                    <el-table-column label="操作" width="120">
                        <template #default="scope">
                            <el-button 
                                type="danger" 
                                size="small" 
                                @click="removeFromHidden(scope.$index)">
                                移除
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
        </div>
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="hiddenProductsVisible = false">关闭</el-button>
                <el-button type="primary" @click="saveHiddenProducts">保存</el-button>
            </span>
        </template>
    </el-dialog>

    <!-- 图片预览对话框 -->
    <el-dialog
        v-model="dialogImageVisible"
        width="70%"
        top="5vh"
        :append-to-body="true"
        close-on-click-modal
        center>
        <img 
            :src="dialogImageUrl" 
            alt="预览图片" 
            style="width: 100%; max-height: 70vh; object-fit: contain;" 
        />
    </el-dialog>

    <!-- 视频预览对话框 -->
    <el-dialog
        v-model="videoDialogVisible"
        width="70%"
        top="5vh"
        :append-to-body="true"
        center>
        <video 
            :src="videoPreviewUrl" 
            controls 
            style="width: 100%; max-height: 70vh; object-fit: contain;" 
            autoplay
        ></video>
    </el-dialog>
    
    <!-- 发货单详情对话框 -->
    <el-dialog
        v-model="viewDeliveryVisible" 
        title="发货单详情"
        width="800px"
        destroy-on-close
    >
        <div class="delivery-detail-header">            
            <div class="delivery-detail-content">
                <div class="detail-section">
                    <h3 class="section-title">基本信息</h3>
        <el-descriptions :column="2" border>
                        <el-descriptions-item label="客户名称">{{ currentDeliveryOrder?.order.customerName }}</el-descriptions-item>
                        <el-descriptions-item label="联系电话">{{ currentDeliveryOrder?.order.customerPhone }}</el-descriptions-item>
                        <el-descriptions-item label="发货日期">{{ formatDate(currentDeliveryOrder?.order.deliveryDate) }}</el-descriptions-item>
                        <el-descriptions-item label="创建时间">{{ formatDate(currentDeliveryOrder?.order.createdAt) }}</el-descriptions-item>
        </el-descriptions>
                </div>
                
                <div class="detail-section" v-if="currentDeliveryOrder?.remark">
                    <h3 class="section-title">备注信息</h3>
                    <div class="remark-content">
                        {{ currentDeliveryOrder?.remark }}
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3 class="section-title">商品清单</h3>
                    <el-table :data="currentDeliveryOrder?.items || []" border style="width: 100%">
                        <el-table-column prop="product_id" label="商品ID" width="120" >                          
                        </el-table-column>
                        <el-table-column prop="product_name" label="商品名称" min-width="180" >
                        </el-table-column>
                        <el-table-column prop="color" label="颜色" width="120" >                         
                        </el-table-column>
                        <el-table-column prop="quantity" label="数量" width="100" >                         
                        </el-table-column>
                        <!--el-table-column prop="price" label="单价" width="100" v-if = "userInfo.role === 'admin'"-->                         
                        </el-table-column>
                    </el-table>
                    <div class="total-info" style="margin-top: 20px;" >
                        <div class="section-title">总件数: {{ currentDeliveryOrder?.order.total_quantity }}</div>
                        <div class="section-title" v-if = "userInfo.role === 'admin'">总价: {{ currentDeliveryOrder?.order.totalPrice }}</div>
                    </div>
                </div>
                
                <div class="detail-section" v-if="currentDeliveryOrder?.deliveryImage && currentDeliveryOrder.deliveryImage.length > 0">
                    <h3 class="section-title">打包图片</h3>
                    <div class="image-gallery">
                        <el-image 
                            v-for="(image, index) in currentDeliveryOrder.deliveryImage" 
                            :key="index"
                            :src="image"
                            fit="cover"
                            class="delivery-image"
                            :preview-src-list="currentDeliveryOrder.deliveryImage"
                        />
                    </div>
                </div>
            </div>
        </div>

        <el-divider />

        
    </el-dialog>
    
    <!-- 新建发货单对话框 -->
    <el-dialog 
        v-model="createDeliveryVisible" 
        title="新建发货单" 
        width="900px"
        destroy-on-close
    >
        <el-form :model="deliveryForm" label-width="100px">
            <el-tabs v-model="activeTab">
                <el-tab-pane label="基本信息">
                    <el-form-item label="客户名称" prop="customerName">
                        <el-input v-model="deliveryForm.customerName" placeholder="请输入客户名称" />
                    </el-form-item>                    
                    <el-form-item label="联系电话" prop="customerPhone" >
                        <el-input v-model="deliveryForm.customerPhone" placeholder="请输入联系电话" />
                    </el-form-item>                    
                    <el-form-item label="收货地址" prop="deliveryAddress" >
                        <el-input 
                            v-model="deliveryForm.deliveryAddress" 
                            type="textarea" 
                            :rows="2"
                            placeholder="请输入收货地址"
                        />
                    </el-form-item>
                    
                    <el-form-item label="发货日期" prop="deliveryDate">
                        <el-date-picker 
                            v-model="deliveryForm.deliveryDate" 
                            type="date" 
                            placeholder="选择发货日期"
                            style="width: 100%"
                        />
                    </el-form-item>
                    
                    <el-form-item label="备注" prop="remark">
                        <el-input 
                            v-model="deliveryForm.remark" 
                            type="textarea" 
                            :rows="3"
                            placeholder="请输入备注信息"
                        />
                    </el-form-item>
                                    </el-tab-pane>
                
                <el-tab-pane label="包裹管理">
                    <div class="packages-header">
                        <h3>包裹列表</h3>
                        <el-button type="primary" @click="addPackage">添加包裹</el-button>
                    </div>
                    
                    <div v-for="(pkg, pkgIndex) in deliveryForm.packages" :key="pkgIndex" class="package-card">
                        <div class="package-header">
                            <h4>包裹 #{{ pkgIndex + 1 }}</h4>
                            <el-button 
                                type="danger" 
                                size="small" 
                                @click="deletePackage(pkgIndex)"
                                :disabled="deliveryForm.packages.length <= 1"
                            >删除包裹</el-button>
                        </div>
                        
                        <el-table :data="pkg.items" border style="margin-top: 10px;">
                            <el-table-column prop="productName" label="商品名称" min-width="180">
                    <template #default="scope">
                                    <div>
                                        {{ scope.row.product_name }}
                                        <div class="service-tags">
                                            <el-tag v-if="scope.row.packaging_price > 0" size="small" type="info">包装</el-tag>
                                            <el-tag v-if="scope.row.logo_price > 0" size="small" type="info">打标</el-tag>
                                            <el-tag v-if="scope.row.accessory_price > 0" size="small" type="info">辅料</el-tag>
                                        </div>
                                    </div>
                                        </template>
                </el-table-column>
                            <el-table-column prop="color" label="颜色" width="120" >
                                <template #default="scope">
                                    <el-tag size="small" type="info">{{ scope.row.color }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="quantity" label="数量" width="120">
                                <template #default="scope">
                                    <el-input-number 
                                        v-model="scope.row.quantity" 
                                        :min="1" 
                                        :max="scope.row.max_quantity || 999"
                                        controls-position="right"
                                        size="small"
                                        style="width: 100px;"
                                    />
                                </template>
                            </el-table-column>
                            <el-table-column prop="max_quantity" label="待发数量" width="120" >
                                <template #default="scope">
                                    <el-tag size="small" type="info">{{ scope.row.max_quantity }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" width="100">
                                <template #default="scope">
                                    <el-button 
                                        type="danger" 
                                        size="small" 
                                        @click="removeItem(pkgIndex, scope.$index)"
                                    >删除</el-button>
                                </template>
                            </el-table-column>
            </el-table>
                        
                        <div class="add-item-row">
                            <el-button 
                                type="primary" 
                                size="small" 
                                @click="showAddProductPopup(pkgIndex)"
                            >添加商品</el-button>
        </div>
                    </div>
                </el-tab-pane>
                
                <el-tab-pane label="打包图片">
                    <el-upload
                        action="#"
                        list-type="picture-card"
                        :auto-upload="false"
                        :file-list="deliveryImageFiles"
                        :on-preview="handlePictureCardPreview"
                        :on-remove="handleDeliveryImageRemove"
                    >
                        <i class="el-icon-plus"></i>
                    </el-upload>
                                    </el-tab-pane>
                                </el-tabs>
            
            <div style="text-align: right; margin-top: 20px;">
                <el-button @click="createDeliveryVisible = false">取消</el-button>
                <el-button type="primary" @click="submitDeliveryForm">确定</el-button>
            </div>
        </el-form>
    </el-dialog>
    
    <!-- 添加商品对话框 -->
    <el-dialog v-model="addProductPopupVisible" title="选择商品" width="70%">
        <div class="popup-header">
            <el-button type="primary" @click="addAllProducts">添加全部</el-button>
        </div>
        
        <el-table :data="availableProducts" border @selection-change="handleProductSelectionChange">
            <el-table-column type="selection" width="55" >
                <template #default="scope">
                    <el-checkbox v-model="selectedProducts" :value="scope.row" />
                </template>
            </el-table-column>
            <el-table-column prop="productName" label="商品名称" min-width="180">
                <template #default="scope">
                    <div>
                        {{ scope.row.product_name }}
                        <div class="service-tags">
                            <el-tag v-if="scope.row.packaging_price > 0" size="small" type="info">包装</el-tag>
                            <el-tag v-if="scope.row.logo_price > 0" size="small" type="info">打标</el-tag>
                            <el-tag v-if="scope.row.accessory_price > 0" size="small" type="info">辅料</el-tag>
                        </div>
                    </div>
                </template>
            </el-table-column>
            <el-table-column prop="color" label="颜色" width="120" >
                <template #default="scope">
                    <el-tag size="small" type="info">{{ scope.row.color }}</el-tag>
                </template>
            </el-table-column>
            <el-table-column prop="max_quantity" label="待发数量" width="120" >
                <template #default="scope">
                    <el-tag size="small" type="info">{{ scope.row.max_quantity }}</el-tag>
                </template>
            </el-table-column>
        </el-table>
        
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="addProductPopupVisible = false">取消</el-button>
                <el-button type="primary" @click="confirmAddProducts">确定</el-button>
            </span>
        </template>
    </el-dialog>
    
    <!-- 添加代客下单对话框 -->
    <el-dialog v-model="placeOrderDialogVisible" title="代客下单" width="800px" :class="productSelectorVisible ? 'dialogwangyou' : ''">
        <el-form :model="placeOrderForm" label-width="100px">
            <el-form-item label="选择客户">
                <el-select v-model="placeOrderForm.userId" placeholder="请选择客户（搜索客户）" filterable remote
                    :remote-method="searchUsers" :loading="userSearchLoading" style="width: 100%"
                    @change="handleUserSelect">
                    <el-option v-for="user in userSearchResults" :key="user.id" :label="user.nickname || user.username"
                        :value="user.id">
                        <span>{{ user.nickname || user.username }}</span>
                        <span style="float: right; color: #8492a6; font-size: 13px">{{ user.phone || '无电话' }}</span>
                    </el-option>
                </el-select>
                <div v-if="selectedUserType" style="margin-top: 8px;">
                    客户类型: <el-tag size="small" :type="selectedUserType === 'A类客户' ? 'success' : selectedUserType === 'B类客户' ? 'warning' : selectedUserType === 'C类客户' ? 'info' : 'primary'">{{ selectedUserType }}</el-tag>
                </div>
            </el-form-item>
            
            <el-form-item label="备注">
                <el-input v-model="placeOrderForm.remark" type="textarea" rows="3" placeholder="请输入备注信息"></el-input>
            </el-form-item>
            
            <el-form-item label="商品列表">
                <div class="product-list">
                    <el-table :data="placeOrderForm.items" border stripe>
                        <el-table-column prop="name" label="商品名称" width="200">
                            <template #default="scope">
                                <div>
                                    {{ scope.row.name }}
                                    <div class="service-tags">
                                        <el-tag v-if="scope.row.packaging_price > 0" size="small" type="info">包装</el-tag>
                                        <el-tag v-if="scope.row.logo_price > 0" size="small" type="info">打标</el-tag>
                                    </div>
                                </div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="color" label="颜色" width="120" >
                        </el-table-column>
                        <el-table-column prop="quantity" label="数量" width="110">
                            <template #default="scope">
                                <el-input-number 
                                    v-model="scope.row.quantity" 
                                    :min="1" 
                                    size="small"
                                    controls-position="right"
                                    style="width: 95px;"
                                />
                            </template>
                        </el-table-column>
                        <el-table-column prop="price" label="单价" width="110" v-if = "userInfo.role === 'admin'">
                            <template #default="scope">
                                <el-input-number 
                                    v-model="scope.row.price" 
                                    :min="0" 
                                    size="small"
                                    controls-position="right"
                                    style="width: 95px;"
                                    @change="(value) => handlePriceChange(value, scope.$index)"
                                />
                            </template>
                        </el-table-column>
                        <el-table-column label="操作" width="100">
                            <template #default="scope">
                                <el-button type="danger" size="small" @click="removePlaceOrderItem(scope.$index)">删除</el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                    
                    <div class="add-product-button" style="margin-top: 10px;">
                        <el-button type="primary" @click="showProductSelector">添加商品</el-button>
                                    </div>
                </div>
            </el-form-item>
        </el-form>
        
        <template #footer>
            <div class="dialog-footer">
                <el-button @click="placeOrderDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="submitPlaceOrder">提交订单</el-button>
                                </div>
                            </template>
    </el-dialog>

    <!-- 采购单详情对话框 -->
    <purchase-order-detail
    v-model:visible="purchaseDetailVisible"
    :order-data="currentPurchaseOrder"
    :is-admin="userInfo.role === 'admin'"
    @accept="handleAcceptPurchase"
    @cancel="handleCancelPurchase"
    @save="handleSavePurchaseEdit"
    @view-delivery="viewDeliveryDetail"
></purchase-order-detail>

    <!-- 使用商品选择组件 -->
    <product-selector 
        v-model="productSelectorVisible" 
        title="选择商品" 
        @add-product="addPlaceOrderItem"
        @close="productSelectorVisible = false"
        :user-type="placeOrderForm.userType"
    >
    </product-selector>
    </div>



    <!-- 引入依赖 -->
    <script src="/admin/lib/vue/vue.global.min.js"></script>
    <script src="/admin/lib/element-plus/index.full.min.js"></script>
    <script src="/admin/lib/axios/axios.min.js"></script>
    <script>

        const { createApp, computed } = Vue
        
        
        // 设置 axios 默认配置
        const isDevelopment = window.location.hostname === 'localhost' || 
                             window.location.hostname === '127.0.0.1';
        
        axios.defaults.baseURL = isDevelopment ? 'http://127.0.0.1' : '';
        
        // 请求拦截器
        axios.interceptors.request.use(config => {
            console.log('准备发送请求:', {
                url: config.url,
                method: config.method,
                params: config.params,
                data: config.data
            });

            const token = localStorage.getItem('token');
            if (token) {
            //    console.log('添加token到请求头:', `Bearer ${token}`);
                config.headers['Authorization'] = `Bearer ${token}`;
            } else {
                console.warn('未找到token');
            }
            config.headers['Cache-Control'] = 'no-cache';
            config.headers['Pragma'] = 'no-cache';
            return config;
        }, error => {
            console.error('请求拦截器错误:', error);
            return Promise.reject(error);
        });

        // 响应拦截器
        axios.interceptors.response.use(response => {
            // console.log('收到响应:', {
            //     url: response.config.url,
            //     status: response.status,
            //     data: response.data
            // });
            return response;
        }, error => {
            console.group('请求失败详情');
            console.error('请求失败:', {
                url: error.config?.url,
                method: error.config?.method,
                headers: error.config?.headers,
                params: error.config?.params,
                data: error.config?.data
            });

            if (error.response) {
                console.error('服务器响应:', {
                    status: error.response.status,
                    data: error.response.data,
                    headers: error.response.headers
                });

                switch (error.response.status) {
                    case 401:
                        console.warn('认证失败，需要重新登录');
                        ElementPlus.ElMessage.error('登录已过期，请重新登录');
                localStorage.removeItem('token');
                        localStorage.removeItem('userInfo');
                window.location.href = '/admin/index.html';
                        break;
                    case 403:
                        console.warn('权限不足');
                        ElementPlus.ElMessage.error('没有权限访问');
                        break;
                    default:
                        console.error('其他错误:', error.response.data.error || '请求失败');
                        ElementPlus.ElMessage.error(error.response.data.error || '请求失败');
                }
            } else if (error.request) {
                console.error('未收到响应:', error.request);
                ElementPlus.ElMessage.error('网络错误，请稍后重试');
            } else {
                console.error('请求配置错误:', error.message);
                ElementPlus.ElMessage.error('请求配置错误');
            }

            console.groupEnd();
            return Promise.reject(error);
        });

        const app = Vue.createApp({
            data() {
                return {
                    activeTab: '1',
                    userInfo: JSON.parse(localStorage.getItem('userInfo') || '{}'),
                    productSearch: {
                        keyword: '',
                        sortField: '',
                        sortOrder: ''
                    },
                    productLoading: false,
                    currentPage: '1',
                    uploadedFiles: 0,
                    userDialogStatus: 'edit',
                    products: [],
                    pagination: {
                        currentPage: 1,
                        pageSize: 20,
                        total: 0
                    },
                    pageSizeOptions: [10, 25, 50],
                    dialogVisible: false,
                    dialogType: 'add',
                    editingProductId: '',
                    uploadHeaders: {
                        Authorization: `Bearer ${localStorage.getItem('token')}`
                    },
                    fileList: [],
                    styleOptions: [
                        { value: 1, label: '披肩' },
                        { value: 2, label: '围巾' },
                        { value: 3, label: '帽子' },
                        { value: 4, label: '三角巾' },
                        { value: 5, label: '其他' }
                    ],
                    tempUploadData:[],
                    productForm: {
                        id: '',
                        name: '',
                        price: 0,
                        cost_price: 0,
                        price_b: 0,
                        price_c: 0,
                        price_d: 0,
                        style: 1,
                        colors: ['灰色', '黑色'],  // 默认颜色
                        specs: [                 // 初始化 specs 数组
                            { color: '灰色', stock: 0 },
                            { color: '黑色', stock: 0 }
                        ],
                        images: [],
                        description: '暂时没有',
                        stock: 0,
                        stock_warning: 10,
                        size: '',               // 尺寸
                        weight: 0,              // 克重
                        yarn: '',               // 材质
                        composition: '',         // 成分
                        status: 1,          // 默认上架
                        is_public: 0            // 默认私密
                    },
                    productRules: {
                        id: [
                            { 
                                validator: (rule, value, callback) => {
                                    if (this.dialogType === 'edit') {
                                        callback();
                                        return;
                                    }
                                    
                                    if (!value) {
                                        callback(new Error('请输入款号'));
                                        return;
                                    }
                                    if (!/^\d+$/.test(value)) {
                                        callback(new Error('款号必须为数字'));
                                        return;
                                    }
                                    if (value.toString().length < 2 || value.toString().length > 20) {
                                        callback(new Error('长度在 2 到 20 个数字'));
                                        return;
                                    }
                                    callback();
                                },
                                trigger: 'blur'
                            }
                        ],
                        name: [
                            { required: true, message: '请输入商品名称', trigger: 'blur' },
                            { min: 2, max: 50, message: '长度在 2 到 50 个字符', trigger: 'blur' }
                        ],
                        price: [
                            { required: true, message: '请输入商品价格', trigger: 'blur' }
                        ],
                        cost_price: [
                            { required: true, message: '请输入成本价', trigger: 'blur' }
                        ],
                        price_b: [
                            { required: true, message: '请输入价格B', trigger: 'blur' }
                        ],
                        price_c: [
                            { required: true, message: '请输入价格C', trigger: 'blur' }
                        ],
                        price_d: [
                            { required: true, message: '请输入价格D', trigger: 'blur' }
                        ],
                        style: [
                            { required: true, message: '请选择款式', trigger: 'change' }
                        ],
                        description: [
                            { required: true, message: '请输入商品描述', trigger: 'blur' }
                        ],
                        size: [
                            { max: 50, message: '尺寸长度不能超过50个字符', trigger: 'blur' }
                        ],
                        weight: [
                            { type: 'number', min: 0, message: '克重不能小于0', trigger: 'blur' }
                        ],
                        yarn: [
                            { max: 100, message: '材质长度不能超过100个字符', trigger: 'blur' }
                        ],
                        composition: [
                            { max: 500, message: '成分长度不能超过500个字符', trigger: 'blur' }
                        ]
                    },
                    tempProductId: '',
                    presetTags: [],
                    selectedPresetTags: [],
                    presetColors: ['黑色', '白色', '灰色', '红色', '蓝色', '粉色', '米色', '卡其色', '藏青色', '酒红色'],
                    selectedPresetColors: [],
                    customColorInput: [],
                    customColorOptions: [],
                    customTagInput: [],
                    customTagOptions: [],
                    timeRange: 'all',
                    purchaseDetailstatus: 'add',
                    statistics: {
                        summary: {
                            total_views: 0,
                            viewed_products: 0,
                            total_orders: 0,
                            total_quantity: 0
                        },
                        top_viewed: [],
                        top_purchased: []
                    },
                    users: [],
                    userPagination: {
                        currentPage: 1,
                        pageSize: 25,
                        total: 0
                    },
                    userDialogVisible: false,
                    userForm: {
                        id: null,
                        nickname: '',
                        phone: '',
                        address: '',
                        contact: '',
                        status: 1
                    },
                    userFormRules: {
                        nickname: [
                            { required: true, message: '请输入昵称', trigger: 'blur' },
                            { min: 2, max: 20, message: '长度在 2 到 20 个字符', trigger: 'blur' }
                        ],
                        phone: [
                            { pattern: /^1[3-9]\d{9}$/, message: '请输入正确的手机号码', trigger: 'blur' }
                        ]
                    },
                    profileDialogVisible: false,
                    profileForm: {
                        nickname: '',
                        phone: '',
                        address: '',
                        contact: '',
                        avatar: ''
                    },
                    profileFormRules: {
                        nickname: [
                            { required: true, message: '请输入昵称', trigger: 'blur' },
                            { min: 2, max: 20, message: '长度在 2 到 20 个字符', trigger: 'blur' }
                        ],
                        phone: [
                            { pattern: /^1[3-9]\d{9}$/, message: '请输入正确的手机号码', trigger: 'blur' }
                        ]
                    },
                    // 采购单相关数据
                    purchaseSearch: {
                        keyword: '',
                        start_date: '',
                        end_date: ''
                    },
                    purchaseLoading: false,
                    purchaseOrders: [],
                    purchasePagination: {
                        currentPage: 1,
                        pageSize: 15,
                        total: 0
                    },
                    purchaseDetailVisible: false,
                    currentPurchaseOrder: null,
                    // 配送单相关数据
                    deliverySearch: {
                        keyword: '',
                        timeRange: '',
                        dateRange: null
                    },
                    deliveryTabs: [
                        { name: '待发货', status: 0, type: 'normal' },
                        { name: '已发货', status: 1, type: 'normal' },
                        { name: '已完成', status: 2, type: 'normal' },
                        { name: '已取消', status: 3, type: 'normal' }
                    ],
                    currentDeliveryTab: 0,
                    deliveryLoading: false,
                    deliveryOrders: [],
                    deliveryPagination: {
                        currentPage: 1,
                        pageSize: 15,
                        total: 0
                    },
                    createDeliveryVisible: false,
                    viewDeliveryVisible: false,
                    currentDeliveryOrder: null,
                    deliveryForm: {
                        customerName: '',
                        customerPhone: '',
                        deliveryAddress: '',
                        deliveryDate: '',
                        deliveryTimeSlot: '',
                        remark: '',
                        items: [],
                        packages:[]
                    },
                    selectedOrder: null,  // 添加selectedOrder初始化
                    addItemDialogVisible: false,
                    addItemForm: {
                        productName: '',
                        color: '',
                        quantity: ''
                    },
                    itemSearch: {
                        keyword: ''
                    },
                    searchProducts: [],
                    productSearch: {
                        keyword: ''
                    },
                    productLoading: false,
                    batchStockDialogVisible: false,
                    batchStockForm: {
                        mode: 'set',
                        value: 0
                    },
                    imagesLoading: null,
                    selectedProducts: [],
                    deliveryStats: {
                        total: 0,
                        pending: 0,    // 待配送
                        delivering: 0, // 配送中
                        completed: 0,  // 已完成
                        cancelled: 0   // 已取消
                    },
                    purchaseListVisible: false,
                    pushSearch: {
                        keyword: '',
                        status: 'all'
                    },
                    pushStats: {
                        total: 0,
                        active: 0,
                        inactive: 0
                    },
                    pushOrders: [],
                    pushLoading: false,
                    pushPagination: {
                        currentPage: 1,
                        pageSize: 15,
                        total: 0
                    },
                    pushDetailVisible: false,
                    currentPushOrder: null,
                    uploadUrl: '', // 存储上传URL
                    uploadKey: '', // 存储cos key
                    uploadSignature: '', // 存储cos security token
                    uploadxcossecuritytoken: '', // 存储cos key time
                    uploadFileId: '', // 存储file id
                    cloudBaseUrl: 'cloud://prod-9gd4jllic76d4842.7072-prod-9gd4jllic76d4842-1348936510', // 替换为您的云存储域名
                    httpsBaseUrl: 'https://7072-prod-9gd4jllic76d4842-1348936510.tcb.qcloud.la/', // 替换为您的云存储域名
                    uploadProgress: 0, // 上传进度
                    uploadProductData: {}, // 添加这个属性
                    fileUploadInfo: new Map(), // 用于存储每个文件的上传信息
                    productFilter: {
                        type: '', // 款式筛选值
                        keyword: '', // 搜索关键词
                        spec_info: '' // 规格筛选值
                    },
                    batchStyleDialogVisible: false,
                    batchStyleForm: {
                        type: ''
                    },
                    systemSettingsVisible: false,
                    systemSettings: {},
                    styleSettingsVisible: false,
                    product_types: [], // 修改为 product_types
                    imageViewerConfig: {
                        zIndex: 2050,
                        maskClosable: true,
                        onClose: () => {
                            console.log('图片预览关闭');
                        },
                        onSwitch: (index) => {
                            console.log('切换到图片:', index);
                        }
                    },
                    sizeFilters: [],
                    weightFilters: [],
                    yarnFilters: [],
                    compositionFilters: [],
                    filterOptions: {
                        types: [],
                        sizes: [],
                        weights: [],
                        yarns: [],
                        compositions: []
                    },
                    filterVisible: {
                        type: false,
                        size: false,
                        weight: false,
                        yarn: false,
                        composition: false,
                        status: false,
                        is_public: false
                    },
                    selectedFilters: {
                        type: null,
                        size: null,
                        weight: null,
                        yarn: null,
                        composition: null,
                        status: 1,
                        is_public: null
                    },
                    colorImageDialogVisible: false,
                    selectedImageUrl: '',
                    currentColorIndex: -1,
                    isEditMode: false,
                    previewSrcList: [],
                    videoFileList: [],
                    videoPreviewUrl: '',
                    videoPreviewVisible: false,
                    recommendedProductsVisible: false,
                    recommendedSearch: {
                        keyword: ''
                    },
                    searchProductsResults: [],
                    recommendedProducts: [],
                    batchStatusDialogVisible: false,
                    batchStatusForm: {
                        status: 1
                    },
                    batchPublicDialogVisible: false,
                    batchPublicForm: {
                        is_public: 1
                    },
                    hiddenProductsVisible: false,
                    hiddenProducts: [],
                    hiddenSearch: {
                        keyword: ''
                    },
                    dialogImageUrl: '',
                    tagDialogVisible: false,
                    dialogImageVisible: false,
                    videoDialogVisible: false,
                    pendingOrdersVisible: false,
                    pendingOrdersLoading: false,
                    pendingOrders: [],
                    pendingOrdersSearch: {
                        keyword: ''
                    },
                    pendingOrdersPagination: {
                        currentPage: 1,
                        pageSize: 10,
                        total: 0
                    },
                    selectedPurchaseOrder: null,
                    deliveryImageFiles: [],
                    itemSearchLoading: false,
                    selectedDeliveries: [],
                    canBatchShip: false,
                    canBatchComplete: false,
                    canBatchDelete: false,
                    submitting: false,
                    printData: {
                        orderNumber: '',
                        customerName: '',
                        customerPhone: '',
                        deliveryAddress: '',
                        deliveryDate: '',
                        items: []
                    },
                    printPreviewVisible: false,
                    tableHeight: '400px',
                    addProductPopupVisible: false,  // 添加这个属性
                    currentPackageIndex: -1,        // 添加这个属性
                    availableProducts: [],           // 添加这个属性
                    
                    // 代客下单相关数据
                    placeOrderDialogVisible: false,
                    placeOrderForm: {
                        userId: null,
                        remark: '',
                        items: []
                    },
                    userSearchResults: [],
                    userSearchLoading: false,
                    productSelectorVisible: false,
                    selectedUserType: '', // 添加选中用户类型
                    dateShortcuts: [
                        {
                            text: '当天',
                            value: () => {
                                const today = new Date();
                                const end = new Date(today.getFullYear(), today.getMonth(),today.getDate() + 1);
                                return [today, end];
                            }
                        },
                        {
                            text: '本月',
                            value: () => {
                                const today = new Date();
                                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                                return [firstDay, today];
                            }
                        },
                        {
                            text: '本年',
                            value: () => {
                                const today = new Date();
                                const firstDay = new Date(today.getFullYear(), 0, 1);
                                return [firstDay, today];
                            }
                        }
                    ]
                }
            },
            created() {
                // 检查登录状态
                const token = localStorage.getItem('token');
                if (!token) {
                    ElementPlus.ElMessage.warning('请先登录');
                    window.location.href = '/admin/index.html';
                    return;
                }

                // 获取当前用户信息并初始化数据
                this.getCurrentUserInfo();
                // 加载款式选项
                this.loadStyleOptions();
                this.loadFilterOptions();
                
                // 初始化加载
                this.loadProducts();
                this.$nextTick(() => {
                    this.initSortable();
                });
            },
            methods: {
                handleSelect(index) {
                    this.currentPage = index;
                    if (index === '1') {
                        this.loadProducts();
                    } else if (index === '2') {
                        this.loadUsers();
                    } else if (index === '3') {
                        this.loadPurchaseOrders();
                    } else if (index === '4') {
                        this.loadDeliveryOrders();
                    } else if (index === '5') {
                        // 加载系统设置
                    } else if (index === '6') {
                        this.loadStatistics();
                    } else if (index === '7') {
                        this.loadPushOrders();
                    }
                },
                calculateTotalPendingQuantity(order) {
                    if (!order || !order.items || !Array.isArray(order.items)) {
                        return 0;
                    }
                    
                    let totalPending = 0;
                    for (const item of order.items) {
                        if (item.specs && Array.isArray(item.specs)) {
                            // 如果有规格，计算所有规格的总数量
                            for (const spec of item.specs) {
                                // 如果有已发数量，则用总数量减去已发数量
                                const pendingQty = spec.pending_quantity !== undefined 
                                    ? spec.pending_quantity 
                                    : (spec.quantity - (spec.shipped_quantity || 0));
                                totalPending += pendingQty;
                            }
                        } else {
                            // 没有规格，直接计算商品的待发数量
                            const pendingQty = item.pending_quantity !== undefined 
                                ? item.pending_quantity 
                                : (item.quantity - (item.shipped_quantity || 0));
                            totalPending += pendingQty;
                        }
                    }
                    return totalPending;
                },
                handleLogout() {
                    // 清除登录信息
                    localStorage.removeItem('token');
                    localStorage.removeItem('userInfo');
                    window.location.href = '/admin/index.html';
                },
                async loadProducts() {
                    try {
                        this.productLoading = true;
                        const params = {
                            page: this.pagination.currentPage,
                            page_size: this.pagination.pageSize,
                            keyword: this.productSearch.keyword
                        };
                        if (this.productFilter.type) {
                            params.type = this.productFilter.type;
                        }
                        if (this.selectedFilters.size) {
                            params.size = this.selectedFilters.size;
                        }
                        if (this.selectedFilters.weight) {
                            params.weight = this.selectedFilters.weight;
                        }
                        if (this.selectedFilters.yarn) {
                            params.yarn = this.selectedFilters.yarn;
                        }
                        if (this.selectedFilters.composition) {
                            params.composition = this.selectedFilters.composition;
                        }
                        if (this.selectedFilters.status !== null) {
                            params.status = this.selectedFilters.status;
                        }
                        if (this.selectedFilters.is_public !== null) {
                            params.is_public = this.selectedFilters.is_public;
                        }
                        // 添加排序参数
                        if (this.productSearch.sortField) {
                            params.sort_field = this.productSearch.sortField;
                        }
                        if (this.productSearch.sortOrder) {
                            params.sort_order = this.productSearch.sortOrder;
                        }
                        
                        const response = await axios.get('/products', { 
                            params
                        });
                        console.log('搜索商品结果:', response.data);
                        if (response.status === 200) {
                            this.products = response.data.products;
                            this.pagination.total = response.data.total;
                        }
                        
                        // 数据加载完成后更新筛选选项
                        this.updateFilters();
                    } catch (error) {
                        console.error('加载商品列表失败:', error);
                        ElementPlus.ElMessage.error('加载商品列表失败');
                    } finally {
                        this.productLoading = false;
                        }
                },
                handleDateRangeChange(value) {
                    this.deliverySearch.start_date = value[0]
                    this.deliverySearch.end_date = value[1]
                    console.log('this.deliverySearch:', this.deliverySearch.start_date, this.deliverySearch.end_date);
                    this.loadDeliveryOrders();
                    
                },
                handlePurchaseDateRangeChange(value) {
                    this.purchaseSearch.start_date = value[0]
                    this.purchaseSearch.end_date = value[1]
                    console.log('this.purchaseSearch:', this.purchaseSearch.start_date, this.purchaseSearch.end_date);
                    this.loadPurchaseOrders();
                },
                handleDateShortcut(shortcut) {
                    if (shortcut === '当天') {
                        this.deliverySearch.dateRange = [new Date(), new Date()];
                    } else if (shortcut === '本月') {
                        const today = new Date();
                        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                        this.deliverySearch.dateRange = [firstDay, today];
                    } else if (shortcut === '本年') {
                        const today = new Date();
                        const firstDay = new Date(today.getFullYear(), 0, 1);
                        this.deliverySearch.dateRange = [firstDay, today];
                    }
                    this.loadDeliveryOrders();
                },
                showAddProductDialog() {
                    this.dialogType = 'add'
                    this.productForm = {
                        id: '',
                        name: '',
                        price: 0,
                        cost_price: 0,
                        price_b: 0,
                        price_c: 0,
                        price_d: 0,
                        style: 1,
                        colors: ['灰色', '黑色'],  // 默认颜色
                        specs: [                 // 初始化 specs 数组
                            { color: '灰色', stock: 0 },
                            { color: '黑色', stock: 0 }
                        ],
                        images: [],
                        description: '暂时没有',
                        stock: 0,
                        stock_warning: 10,
                        size: '',               // 尺寸
                        weight: 0,              // 克重
                        yarn: '',               // 材质
                        composition: '',         // 成分
                        status: 1,          // 默认上架
                        is_public: 0            // 默认私密
                    }
                    // 清空文件列表
                    if (this.$refs.uploadRef) {
                        this.$refs.uploadRef.clearFiles()
                    }
                    this.dialogVisible = true
                    this.selectedPresetColors = [];
                    this.customColorInput = [];
                    this.customColorOptions = [];
                    
                    // 延迟初始化排序功能，确保DOM已更新
                    setTimeout(() => {
                        this.initSortable();
                    }, 300);
                },
                
                // 加载待发货订单
                async loadPendingOrders() {
                    try {
                        this.pendingOrdersLoading = true;
                        const response = await axios.get('/purchase_orders', {
                            params: {
                                status: [0, 1], // 状态0表示待处理，1表示待发货
                                page: this.pendingOrdersPagination.currentPage,
                                pageSize: this.pendingOrdersPagination.pageSize,
                                keyword: this.pendingOrdersSearch.keyword
                            }
                        });
                        
                        if (response.status === 200) {
                            this.pendingOrders = response.data.orders;
                            this.pendingOrdersPagination.total = response.data.total;
                        } else {
                            throw new Error('加载待发货订单失败');
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '加载待发货订单失败');
                    } finally {
                        this.pendingOrdersLoading = false;
                    }
                },
                
                // 待发货订单搜索
                handlePendingOrdersSearch() {
                    this.pendingOrdersPagination.currentPage = 1;
                    this.loadPendingOrders();
                },
                
                // 待发货订单分页
                handlePendingOrdersPageChange(page) {
                    this.pendingOrdersPagination.currentPage = page;
                    this.loadPendingOrders();
                },
                
                // 从订单创建发货单
                async createDeliveryFromOrder(order) {
                    try {
                        // 获取订单详情，确保有完整数据
                        const response = await axios.get(`/purchase_orders/${order.id}`);
                        this.handleOrderSelect(order);
                        console.log('response:', response);
                        if (response.status === 200) {
                            const orderDetail = response.data.order;
                            
                            // 跳转到创建发货单页面
                            this.pendingOrdersVisible = false;
                            
                            // 准备发货单表单数据
                            this.createDeliveryVisible = true;
                            this.deliveryForm = {
                                customerName: orderDetail.user?.nickname || '无',
                                customerPhone: orderDetail.user?.phone || '',
                                deliveryAddress: orderDetail.user?.address || '',
                                deliveryDate: new Date().toISOString().split('T')[0],
                                deliveryName: '',
                                remark: '',
                                items: [],
                                packages: [{
                                    items: []
                                }],
                                orderNumber: orderDetail.order_number // 关联原订单号
                            };

                            console.log("deliveryForm:",this.deliveryForm);
                            console.log("orderDetail:",orderDetail);
                            const firstPackage = this.deliveryForm.packages[0];
                            // 自动添加所有商品到第一个包裹
                            if (orderDetail.items && orderDetail.items.length > 0) {
                                
                                orderDetail.items.forEach(item => {
                                    if (item.specs && item.specs.length > 0) {
                                        item.specs.forEach(spec => {
                                            console.log("spec:",spec);
                                            if ((spec.quantity - spec.shipped_quantity) > 0) {
                                                firstPackage.items.push({
                                                    product_id: item.product_id,
                                                    product_name: item.product_name,
                                                    color: spec.color,
                                                    quantity: spec.quantity,
                                                    max_quantity: spec.quantity - spec.shipped_quantity,
                                                    price: spec.price,
                                                    spec_id: spec.id,
                                                    packaging_price: spec.packaging_price || item.packaging_price || 0,
                                                    logo_price: spec.logo_price || item.logo_price || 0,
                                                    accessory_price: spec.accessory_price || item.accessory_price || 0
                                                });
                                            }
                                        });
                                    } else if (item.pending_quantity > 0) {
                                        firstPackage.items.push({
                                            product_id: item.product_id,
                                            product_name: item.product_name,
                                            color: '',
                                            quantity: item.pending_quantity,
                                            max_quantity: item.pending_quantity,
                                            price: item.price,
                                            packaging_price: item.packaging_price || 0,
                                            logo_price: item.logo_price || 0,
                                            accessory_price: item.accessory_price || 0
                                        });
                                    }
                                });
                                console.log("firstPackage:",firstPackage);
                            }
                            this.deliveryForm.packages[0] = firstPackage;
                            
                            // 初始化空的发货单表单
                            // 之后用户需要手动添加要发货的商品
                        } else {
                            throw new Error('获取订单详情失败');
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '创建发货单失败');
                    }
                },

                handleDeliveryPageChange(page, pageSize) {
                    this.deliveryPagination.currentPage = page;
                    this.deliveryPagination.pageSize = pageSize;
                    this.loadDeliveryOrders();
                },

                async handleDelete(row) {
                    try {
                        await ElementPlus.ElMessageBox.confirm(
                            '确定要删除这个商品吗？',
                            '警告',
                            {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'warning',
                            }
                        );

                        const response = await axios.delete(`/products/${row.id}`);
                        console.log('response:', response);
                        if (response.status === 200 || response.status === 201) {
                            ElementPlus.ElMessage.success('删除成功');
                            await this.loadProducts(); // 重新加载商品列表
                        } else {
                            throw new Error(response.data.error || '删除失败');
                        }
                    } catch (error) {
                        console.error('删除失败:', error);
                        ElementPlus.ElMessage.error(
                            error.response?.data?.error || error.message || '删除失败，请重试'
                        );
                    }
                },

                handleTagsChange(value) {
                    // 将输入的字符串转换为数组
                    this.productForm.tags = value.split(',')
                        .map(tag => tag.trim())
                        .filter(tag => tag !== '');
                },
                // 添加图片压缩方法
                async compressImage(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = (event) => {
                            const img = new Image();
                            img.src = event.target.result;
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                
                                // 计算压缩后的尺寸
                                let width = img.width;
                                let height = img.height;
                                const maxSize = 1920; // 最大尺寸
                                
                                if (width > height && width > maxSize) {
                                    height = Math.round((height * maxSize) / width);
                                    width = maxSize;
                                } else if (height > maxSize) {
                                    width = Math.round((width * maxSize) / height);
                                    height = maxSize;
                                }
                                
                                canvas.width = width;
                                canvas.height = height;
                                
                                // 绘制图片
                                ctx.drawImage(img, 0, 0, width, height);
                                
                                // 转换为Blob
                                canvas.toBlob((blob) => {
                                    // 创建新的File对象
                                    const compressedFile = new File([blob], file.name, {
                                        type: 'image/jpeg',
                                        lastModified: Date.now()
                                    });
                                    resolve(compressedFile);
                                }, 'image/jpeg', 0.7); // 0.7是压缩质量
                            };
                            img.onerror = reject;
                        };
                        reader.onerror = reject;
                    });
                },

                async handleBeforeUpload(file) {
                    this.totalFiles++;
                    this.imagesLoading = ElementPlus.ElLoading.service({
                        lock: true,
                        text: '图片上传中...',
                        background: 'rgba(0, 0, 0, 0.7)'
                    });
                   // console.log('准备上传文件:', file);
                    try {
                        let processedFile = file;
                        if (file.size > 1024 * 1024) {
                            processedFile = await this.compressImage(file);
                        }
                        // 使用时间戳和随机数生成唯一文件名，避免中文路径问题
                        const timestamp = Date.now();
                        const random = Math.random().toString(36).substr(2, 6);
                        const ext = file.name.split('.').pop();
                        const fileName = `${timestamp}_${random}.${ext}`;
                        const path = `products/${this.productForm.id ? this.productForm.id : this.tempProductId}/${fileName}`;
                        
                        const uploadResponse = await axios.post('/get_uploadfileUrl', {
                            path: path
                        });                 
                        const uploadData = uploadResponse.data;
                        //console.log('获取到上传链接:', uploadData);
                        if (uploadData.errcode !== 0) {
                            throw new Error(uploadData.errmsg);
                        }
                        // 将上传信息存储在Map中，使用文件的uid作为key
                        this.fileUploadInfo.set(file.uid, {
                            ...uploadData,
                            path: path,
                            file: processedFile
                        });

                        return true; // 允许文件被添加到上传列表
                    } catch (error) {
                        console.error('准备上传失败:', error);
                        this.$message.error('文件准备失败：' + error.message);
                        return false;
                    }
                },

                checkUploadComplete() {
                    console.log('this.uploadedFiles:', this.uploadedFiles);
                    console.log('this.totalFiles:', this.totalFiles);
                    if (
                        this.uploadedFiles >= this.totalFiles) {
                        this.$message.success('所有文件上传完成');
                        //this.dialogVisible = false;
                        this.loadProducts();
                    } else {
                        console.log('有图片上传失败');
                    }
                },

                handlePictureCardPreview(file) {
                    console.log('预览图片:', file);
                    this.dialogImageUrl = this.handleImageUrl(file.url);
                    this.dialogImageVisible = true;
                },

                handleCancel() {
                    // 清空表单
                    this.productForm = {id: '', 
                        name: '',
                        price: 0,
                        cost_price: 0,
                        price_b: 0,
                        price_c: 0,
                        price_d: 0,
                        style: 1,
                        colors: ['灰色', '黑色'],
                        specs: [
                            { color: '灰色', stock: 0 },
                            { color: '黑色', stock: 0 }
                        ],
                        images: [],
                        description: '暂时没有',
                        stock: 0,
                        stock_warning: 10,
                        size: '',
                        weight: 0,
                        yarn: '',
                        composition: '',
                        status: 1,
                        is_public: 0

                    };
                    
                    // 清空文件列表
                    if (this.$refs.uploadRef) {
                        this.$refs.uploadRef.clearFiles();
                    }
                    
                    // 重置其他相关状态
                    this.selectedPresetColors = [];
                    this.customColorInput = [];
                    this.customColorOptions = [];
                    
                    // 关闭对话框
                   
                    this.dialogVisible = false;
                    this.loadProducts();
                },

                async submitProduct() {
                    try {
                        await this.$refs.productFormRef.validate(); // 验证表单

                        // 处理规格数据
                        const specs = this.productForm.specs.map(spec => ({
                            color: spec.color,
                            stock: parseInt(spec.stock) || 0,
                            image: spec.image || ''
                        }));

                        const submitData = {
                            id: this.productForm.id,
                            name: this.productForm.name.trim(),
                            description: this.productForm.description.trim(),
                            price: parseFloat(this.productForm.price) || 0,
                            cost_price: parseFloat(this.productForm.cost_price) || 0,
                            price_b: parseFloat(this.productForm.price_b) || 0,
                            price_c: parseFloat(this.productForm.price_c) || 0,
                            price_d: parseFloat(this.productForm.price_d) || 0,
                            specs: specs,
                            images: this.productForm.images || [],
                            type: parseInt(this.productForm.style) || 1,
                            stock: specs.reduce((sum, spec) => sum + (parseInt(spec.stock) || 0), 0),
                            stock_warning: parseInt(this.productForm.stock_warning) || 10,
                            created_at: this.dialogType === 'add' ? new Date().toISOString() : this.productForm.created_at,
                            size: (this.productForm.size || '').trim(),
                            weight: parseFloat(this.productForm.weight) || 0,
                            yarn: (this.productForm.yarn || '').trim(),
                            composition: (this.productForm.composition || '').trim(),
                            status: this.productForm.status,
                            is_public: this.productForm.is_public
                        };
                        const url = `/products`;
                        const method = 'post';
                        const response = await axios[method](url, submitData);
                        

                        if (response.status === 200 || response.status === 201) {
                            ElementPlus.ElMessage.success(this.dialogType === 'add' ? '添加成功' : '更新成功');
                            if (this.dialogType === 'add') {
                            const uploadComponent = this.$refs.uploadRef;
                            this.totalFiles = 0;
                            this.uploadedFiles = 0;
                            console.log('商品创建/更新成功返回:', response.data.product_id);
                            this.tempProductId = response.data.product_id;
                            await new Promise(resolve => setTimeout(resolve, 500));
                            await uploadComponent.submit();   
                            console.log('商品创建/更新成功返回:', this.tempProductId);
                        }
                            this.dialogVisible = false;
                            this.loadProducts();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '保存商品失败');
                    }
                },
                
                getSpecs(specs) {
                    if (!specs) return [];
                    // 处理可能是字符串的情况
                    if (typeof specs === 'string') {
                        try {
                            return JSON.parse(specs);
                        } catch (e) {
                            return [];
                        }
                    }
                    return Array.isArray(specs) ? specs : [];
                },

                handlePresetTagsChange(value) {
                    // 更新预设标签的选中状态
                    this.selectedPresetTags = value;
                    // 合并预设标签和自定义标签，更新到 productForm.tags
                    const customTags = this.productForm.tags.filter(tag => !this.presetTags.includes(tag));
                    this.productForm.tags = [...value, ...customTags];
                },
                handlePurchaseSizeChange(size) {
                    this.purchasePagination.pageSize = size;
                    this.purchasePagination.currentPage = 1; // 切换每页大小时重置为第一页
                    this.loadPurchaseOrders();
                },

                handleCustomTagChange(value) {
                    // value 现在包含所有标签（预设和自定义）
                    // 分离预设标签和自定义标签
                    const presetTags = value.filter(tag => this.presetTags.includes(tag));
                    const customTags = value.filter(tag => !this.presetTags.includes(tag));
                    
                    // 更新预设标签的选中状态
                    this.selectedPresetTags = presetTags;
                    
                    // 更新所有标签
                    this.productForm.tags = value;
                },

                handlePresetColorsChange(value) {
                    // 获取当前自定义颜色（非预设颜色）
                    const customColors = this.productForm.colors.filter(
                        color => !this.presetColors.includes(color)
                    );
                    
                    // 合并预设颜色和自定义颜色
                    this.productForm.colors = [...value, ...customColors];

                    // 更新 specs 数组
                    this.productForm.specs = this.productForm.colors.map(color => ({
                        color: color,
                        stock: this.productForm.specs.find(s => s.color === color)?.stock || 0
                    }));

                    // 同步更新 customColorInput
                    this.customColorInput = this.productForm.colors;
                    // 更新自定义颜色选项
                    this.customColorOptions = customColors;
                },

                handleCustomColorChange(value) {
                    // 保持预设颜色的选中状态
                    const selectedPreset = value.filter(color => this.presetColors.includes(color));
                    this.selectedPresetColors = selectedPreset;
                    
                    // 更新商品颜色列表
                    this.productForm.colors = value;

                    // 更新 specs 数组
                    this.productForm.specs = value.map(color => ({
                        color: color,
                        stock: this.productForm.specs.find(s => s.color === color)?.stock || 0
                    }));
                    
                    // 更新自定义颜色选项（只保留非预设颜色）
                    this.customColorOptions = value.filter(
                        color => !this.presetColors.includes(color)
                    );
                },

                formatDate(dateStr) {
                    if (!dateStr) return '';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        }).replace(/\//g, '-');
                    } catch (e) {
                        console.error('日期格式化错误:', e);
                        return dateStr;
                    }
                },

                beforeImportUpload(file) {
                    // 更新上传请求头
                    this.updateUploadHeaders();
                    const isExcel = file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                        file.type === 'application/vnd.ms-excel';
                    if (!isExcel) {
                        ElementPlus.ElMessage.error('只能上传 Excel 文件!');
                        return false;
                    }
                    return true;
                },

                handleImportSuccess(response, uploadFile, uploadFiles) {
                    ElementPlus.ElMessage.success('导入成功');
                    this.loadProducts();  // 重新加载商品列表
                },

                handleImportError(err) {
                    console.error('导入失败:', err);
                    ElementPlus.ElMessage.error('导入失败，请检查文件格式是否正确');
                },

                async downloadTemplate() {
                    try {
                        const response = await axios.get('/static/templates/products_template.xlsx', {
                            responseType: 'blob',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        });
                        // ... 下载处理代码
                    } catch (error) {
                        this.handleAxiosError(error, '下载模板失败');
                    }
                },

                handleSizeChange(newSize) {
                    this.pagination.pageSize = newSize;
                    this.pagination.currentPage = 1;
                this.loadProducts();
                },

                handleCurrentChange(newPage) {
                    this.pagination.currentPage = newPage;
                    this.loadProducts();
                },

                async loadStatistics() {
                    try {
                        const response = await axios.get('/statistics', {
                            params: { range: this.timeRange }
                        });

                        if (response.status === 200) {
                            this.statistics = response.data;
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '加载统计数据失败');
                    }
                },

                async loadUsers() {
                    try {
                        const response = await axios.get('/users', {
                            params: {
                                page: this.userPagination.currentPage,
                                page_size: this.userPagination.pageSize
                            }
                        });

                        if (response.status === 200) {
                            console.log('用户列表:', response.data);
                            this.users = response.data.users;
                            this.userPagination.total = response.data.total;
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '加载用户列表失败');
                    }
                },

                handleAddUser() {
                    this.userDialogStatus = 'add';
                    this.userForm = {
                        username: '',
                        password: '',
                        confirmPassword: '',
                        nickname: '',
                        phone: '',
                        contact: '',
                        address: '',
                        user_type: 2,
                        role: 'customer'
                    };
                    this.userDialogVisible = true;
                },

                handleEditUser(user) {
                    this.userDialogStatus = 'edit';
                    this.userForm = { ...user };
                    this.userDialogVisible = true;
                },
                async handleDeleteUser(user) {
                    try {
                        // 确认删除
                        await ElementPlus.ElMessageBox.confirm(
                            `确定要删除用户 "${user.username}" 吗？`,
                            '警告',
                            {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'warning'
                            }
                        );
                        
                        const response = await axios.post('/users/delete', {
                            user_id: user.id
                        });
                        
                        if (response.data.code === 200) {
                            ElementPlus.ElMessage.success('用户删除成功');
                            this.loadUsers();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            if (error.response) {
                                ElementPlus.ElMessage.error(error.response.data.error);
                            } else {
                                ElementPlus.ElMessage.error('删除用户失败');
                            }
                        }
                    }
                },

                async handleToggleUserStatus(user) {
                    try {
                        const newStatus = user.status === 1 ? 0 : 1;
                        const response = await axios.put(`/users/${user.id}`, {
                            ...user,
                            status: newStatus
                        });

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success(newStatus === 1 ? '用户已启用' : '用户已禁用');
                            // 直接修改本地数据
                            user.status = newStatus;
                            // 可选：重新加载用户列表以确保数据同步
                            // await this.loadUsers();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '更新用户状态失败');
                    }
                },

                async submitUserForm() {
                    try {
                        console.log('提交用户表单:', this.userForm);

                        if (this.userForm.user_type === 6) {
                            this.userForm.role = 'normalAdmin';
                        }else if (this.userForm.user_type === 5) {
                            this.userForm.role = 'STAFF';
                        }else {
                            this.userForm.role = 'customer';
                        }

                        const response = await axios.put(`/users/${this.userForm.id}`, {
                            ...this.userForm,  // 包含所有字段
                            status: parseInt(this.userForm.status)  // 确保状态是数字
                        });

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('更新成功');
                            this.userDialogVisible = false;
                            await this.loadUsers();  // 重新加载列表
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '更新用户信息失败');
                    }
                },

                handleUserSizeChange(newSize) {
                    this.userPagination.pageSize = newSize;
                    this.loadUsers();
                },

                handleUserCurrentChange(newPage) {
                    this.userPagination.currentPage = newPage;
                    this.loadUsers();
                },

                // 获取当前用户信息
                getCurrentUser() {
                    this.getCurrentUserInfo();
                },
                async handleAddUserSubmit() {
                    try {
                        await this.$refs.userFormRef.validate();
                        const response = await axios.post('/register', this.userForm);
                        if (response.data.code === 200) {
                            ElementPlus.ElMessage.success('用户创建成功');
                            this.userDialogVisible = false;
                            this.loadUsers();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '新增用户失败');
                    }
                },

                // 修改获取用户信息的方法
                async getCurrentUserInfo() {
                    try {
                        const response = await axios.get('/user/profile');
                        if (response.status === 200 && response.data.user) {
                            this.userInfo = response.data.user;
                            console.log('当前用户信息:', this.userInfo);
                            // 更新本地存储
                            localStorage.setItem('userInfo', JSON.stringify(response.data.user));

                            // 检查是否是管理员
                            if (this.userInfo.user_type != 1 && this.userInfo.user_type != 5) {
                                ElementPlus.ElMessage.error('您没有管理员权限');
                                window.location.href = '/admin/index.html';
                                return;
                            }

                            // 加载初始数据
                            this.loadProducts();
                            this.updateUploadHeaders();  // 初始化 headers
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '获取用户信息失败');
                    }
                },

                // 修改个人信息更新方法
                async submitProfile() {
                    try {
                        await this.$refs.profileFormRef.validate();
                        const response = await axios.put('/user/profile', this.profileForm);

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('个人信息更新成功');
                            this.profileDialogVisible = false;
                            // 更新用户信息
                            if (response.data.user) {
                                this.userInfo = response.data.user;
                                localStorage.setItem('userInfo', JSON.stringify(response.data.user));
                            }
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '更新个人信息失败');
                    }
                },

                // 添加全局错误处理
                handleAxiosError(error, customMessage = '操作失败') {
                    console.group('操作失败详情');
                    console.error('错误信息:', error.message);
                    console.error('错误详情:', error);

                    if (error.response) {
                        console.error('服务器响应:', {
                            status: error.response.status,
                            data: error.response.data
                        });

                        if (error.response.status === 401) {
                            console.warn('Token已过期或无效，准备跳转登录页面');
                            ElementPlus.ElMessage.error('登录已过期，请重新登录');
                            this.handleLogout();
                            return;
                        }
                        ElementPlus.ElMessage.error(error.response.data.error || customMessage);
                    } else {
                        console.error('网络错误或请求被取消');
                        ElementPlus.ElMessage.error('网络错误，请稍后重试');
                    }

                    console.groupEnd();
                },

                // 添加下拉菜单命令处理
                handleCommand(command) {
                    switch (command) {
                        case 'profile':
                            this.showProfileDialog();
                            break;
                        case 'logout':
                            this.handleLogout();
                            break;
                    }
                },

                // 更新 uploadHeaders 的方法
                updateUploadHeaders() {
                    this.uploadHeaders = {
                        Authorization: `Bearer ${localStorage.getItem('token')}`
                    };
                },

                // 显示个人信息编辑对话框
                showProfileDialog() {
                    this.profileForm = { ...this.userInfo };
                    this.profileDialogVisible = true;
                },

                // 获取用户显示信息
                getUserInfo() {
                    return {
                        username: this.userInfo?.username || '',
                        nickname: this.userInfo?.nickname || '',
                        avatar: this.userInfo?.avatar || 'https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png'
                    };
                },

                // 加载采购单列表
                async loadPurchaseOrders() {
                    try {
                        this.purchaseLoading = true;
                        const response = await axios.get('/purchase_orders', {
                            params: {
                                page: this.purchasePagination.currentPage,
                                page_size: this.purchasePagination.pageSize,
                                keyword: this.purchaseSearch.keyword,
                                start_date: this.purchaseSearch.start_date,
                                end_date: this.purchaseSearch.end_date
                            }
                        });

                        if (response.status === 200) {
                            this.purchaseOrders = response.data.orders;
                            this.purchasePagination.total = response.data.total;
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '加载采购单列表失败');
                    } finally {
                        this.purchaseLoading = false;
                    }
                },

                // 搜索采购单
                handlePurchaseSearch() {
                    this.purchasePagination.currentPage = 1;
                    this.loadPurchaseOrders();
                },

                // 获取采购单状态类型
                getPurchaseStatusType(status) {
                    const typeMap = {
                        0: 'info',
                        1: 'warning',
                        2: 'success',
                        3: 'danger'
                    };
                    return typeMap[status] || '';
                },

                // 获取采购单状态文本
                getPurchaseStatusText(status) {
                    const statusMap = {
                        0: '待处理',
                        1: '待发货',
                        2: '已完成',
                        3: '已取消'
                    };
                    return statusMap[status] || '未知状态';
                },

                // 查看采购单详情
                async viewPurchaseDetail(order) {
                    this.purchaseDetailstatus = 'view';
                    if (order.orderNumber) {
                        order.id = order.orderNumber;
                    }
                    
                    try {
                        const response = await axios.get(`/purchase_orders/${order.id}`);
                        if (response.status === 200 && this.purchaseDetailstatus === 'view') {
                            console.log('采购单详情:', response.data);
                            this.currentPurchaseOrder = response.data;
                            this.purchaseDetailVisible = true;
                            console.log('采购单窗口显示状态:', this.purchaseDetailVisible);
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '获取采购单详情失败');
                    }
                },

                // 接受采购单
                async handleAcceptPurchase(order) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('确定要接受这个采购单吗？');
                        const response = await axios.put(`/purchase_orders/${order.id}/accept`, {
                            status: 1
                        });

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('采购单已接受');
                            this.purchaseDetailVisible = false;
                            this.loadPurchaseOrders();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.handleAxiosError(error, '接受采购单失败');
                        }
                    }
                },

                // 从采购单生成配送单
                async createFromPurchase(purchaseId) {
                    try {
                        const response = await axios.post(`/delivery_orders/from_purchase/${purchaseId}`);
                        console.log('生成配送单结果:', response);

                        if (response.status === 200) {
                            // 使用采购单数据填充配送单表单 
                            ElementPlus.ElMessage.success('配送单生成成功');
                            this.loadDeliveryOrders(); // 刷新配送单列表
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '生成配送单失败');
                    }
                },

                // 取消采购单
                async handleCancelPurchase(order) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('确定要取消这个采购单吗？', '警告', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });

                        const response = await axios.put(`/purchase_orders/${order.id}/cancel`, {
                            status: 2
                        });

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('采购单已取消');
                            this.purchaseDetailVisible = false;
                            this.loadPurchaseOrders();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.handleAxiosError(error, '取消采购单失败');
                        }
                    }
                },

                // 加载发货单列表
                async loadDeliveryOrders() {
                    try {
                        this.deliveryLoading = true; // 显示加载状态
                        
                        // 根据当前标签页状态决定要请求的数据类型
                        const currentTab = this.deliveryTabs[this.currentDeliveryTab];
                        console.log('加载发货单数据，当前标签:', currentTab.name, '状态:', currentTab.status);
                        console.log('当前页码:', this.deliveryPagination.currentPage);
                        console.log('每页数量:', this.deliveryPagination.pageSize);
                        
                        let response;
                        
                        // 判断是否需要从采购单获取数据（待发货状态）
                        if (currentTab.status === 0) {
                            // 加载采购单作为待发货数据
                            console.log('从采购单接口获取待发货数据');
                            response = await axios.get('/purchase_orders', {
                                params: {
                                    status: 1, // 状态1表示待发货
                                    page: this.deliveryPagination.currentPage,
                                    pageSize: this.deliveryPagination.pageSize,
                                    keyword: this.deliverySearch.keyword,
                                    start_date: this.deliverySearch.start_date,
                                    end_date: this.deliverySearch.end_date
                                    
                                }
                            });
                            console.log('采购单数据结果:', response.data);
                        } else if (currentTab.status === 2) {
                            console.log('从采购单接口获取已完成数据');
                            response = await axios.get('/purchase_orders', {
                                params: {
                                    status: 2, // 状态2表示已完成
                                    page: this.deliveryPagination.currentPage,
                                    pageSize: this.deliveryPagination.pageSize,
                                    keyword: this.deliverySearch.keyword,
                                    start_date: this.deliverySearch.start_date,
                                    end_date: this.deliverySearch.end_date
                                }
                            });
                            console.log('采购单数据结果:', response.data);
                        } else if (currentTab.status === 3) {
                            console.log('从采购单接口获取已取消数据');
                            response = await axios.get('/purchase_orders', {
                                params: {
                                    status: 3, // 状态2表示已完成
                                    page: this.deliveryPagination.currentPage,
                                    pageSize: this.deliveryPagination.pageSize,
                                    keyword: this.deliverySearch.keyword,
                                    start_date: this.deliverySearch.start_date,
                                    end_date: this.deliverySearch.end_date
                                }
                            });
                            console.log('采购单数据结果:', response.data);
                        }else {
                            // 加载常规发货单数据
                            const params = {
                                page: this.deliveryPagination.currentPage,
                                pageSize: this.deliveryPagination.pageSize,
                                keyword: this.deliverySearch.keyword,
                                status: 1,
                                start_date: this.deliverySearch.start_date,
                                end_date: this.deliverySearch.end_date
                            };
                            
                            console.log('请求发货单数据，参数:', params);
                            response = await axios.get('/delivery_orders', { params });
                            response.data
                            console.log('发货单数据结果:', response.data);
                        }
                        
                        // 处理响应结果
                        if (response.status === 200) {
                            this.deliveryOrders = response.data.orders || [];
                            this.deliveryPagination.total = response.data.total || 0;
                        }
                        
                        // 同时加载待发货数量统计（如果不是在待发货标签页）
                        if (currentTab.status !== 0) {
                            this.loadPendingOrdersCount();
                        }
                        
                    } catch (error) {
                        console.error('加载发货单列表失败:', error);
                        this.handleAxiosError(error, '加载发货单列表失败');
                    } finally {
                        this.deliveryLoading = false; // 停止加载中状态
                    }
                },
                
                // 加载待发货订单数量
                async loadPendingOrdersCount() {
                    console.log('加载待发货订单数量');
                    try {
                        const response = await axios.get('/purchase_orders', {
                            params: {
                                status: 1, // 状态0表示待处理，1表示待发货
                                pageSize: 1,
                                page: 1
                            }
                        });
                        
                        if (response.status === 200) {
                            this.deliveryStats.pending = response.data.total || 0;
                        }
                    } catch (error) {
                        console.error('加载待发货订单数量失败:', error);
                    }
                },

                // 切换发货单标签页
                switchDeliveryTab(index) {
                    const tabIndex = parseInt(index);
                    console.log('开始切换标签页，当前索引:', tabIndex);
                    console.log('切换到标签页:', this.deliveryTabs[tabIndex].name);
                    this.currentDeliveryTab = tabIndex;
                    this.deliveryPagination.currentPage = 1;
                    this.deliveryOrders = []; // 清空数据
                    this.deliveryLoading = true; // 显示加载中
                    
                    console.log('开始加载新标签页数据');
                    this.loadDeliveryOrders();
                },

                // 搜索配送单
                handleDeliverySearch() {
                    this.deliveryPagination.currentPage = 1;
                    this.loadDeliveryOrders();
                },

                // 获取配送单状态类型
                getDeliveryStatusType(status) {
                    const types = {
                        0: 'warning',   // 待发货
                        1: 'success',   // 已发货
                        2: 'success',   // 已完成
                        3: 'info'       // 已取消
                    };
                    return types[status] || 'info';
                },

                // 获取配送单状态文本
                getDeliveryStatusText(status) {
                    const texts = {
                        0: '待发货',
                        1: '已发货',
                        2: '已完成',
                        3: '已取消'
                    };
                    return texts[status] || '未知';
                },

                // 开始配送
                async handleStartDelivery(order) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('确定要标记这个发货单为已发货吗？');
                        const response = await axios.put(`/delivery_orders/${order.id}/status`, {
                            status: 1
                        });

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('发货单已标记为已发货');
                            this.loadDeliveryOrders();
                        }   
                    } catch (error) {
                        this.handleAxiosError(error, '标记已发货失败');
                    }
                },  

                // 完成配送
                async handleCompleteDelivery(order) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('确定要标记这个发货单为已完成吗？');
                        const response = await axios.put(`/delivery_orders/${order.id}/status`, {
                            status: 2
                        });

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('发货单已标记为已完成');
                            this.loadDeliveryOrders();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '标记已完成失败');
                    }   
                },

                // 查看配送单详情
                async viewDeliveryDetail(order) {
                    try {
                        const response = await axios.get(`/purchase_orders/${order.id}`);
                        console.log('获取发货单详情',response);
                        if (response.status === 200) {
                            this.currentDeliveryOrder = response.data;
                            this.viewDeliveryVisible = true;
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '获取发货单详情失败');
                    }
                },

                // 接受配送单
                async handleAcceptDelivery(order) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('确定要接受这个发货单吗？');
                        const response = await axios.put(`/delivery_orders/${order.id}/status`, {
                            status: 1
                        });

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('发货单已接受');
                            this.deliveryDetailVisible = false;
                            this.loadDeliveryOrders();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.handleAxiosError(error, '接受发货单失败');
                        }
                    }
                },

                // 删除配送单
                async handleDeleteDelivery(order) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('确定要删除这个发货单吗？', '警告', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });

                        const response = await axios.delete(`/delivery_orders/${order.id}`);
                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('发货单删除成功');
                            this.loadDeliveryOrders();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '删除发货单失败');
                    }
                },

                // 取消配送单
                async handleCancelDelivery(order) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('确定要取消这个发货单吗？', '警告', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });

                        const response = await axios.put(`/delivery_orders/${order.id}/status`, {
                            status: 3
                        });

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('发货单已取消');
                            this.deliveryDetailVisible = false;
                            this.loadDeliveryOrders();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.handleAxiosError(error, '取消发货单失败');
                        }
                    }
                },            

                // 提交配送单表单
                async submitDeliveryForm() {
                    try {
                        // 检查是否有商品数量超过待发数量10%
                        let hasExceededQuantity = false;
                        let exceededItems = [];
                        
                        this.deliveryForm.packages.forEach((pkg, pkgIndex) => {
                            pkg.items.forEach(item => {
                                const qty = parseInt(item.quantity);
                                const maxQty = parseInt(item.max_quantity);
                                const exceedPercentage = ((qty - maxQty) / maxQty) * 100;
                                
                                if (exceedPercentage > 10) {
                                    hasExceededQuantity = true;
                                    exceededItems.push({
                                        packageIndex: pkgIndex + 1,
                                        productName: item.productName,
                                        color: item.color || '默认',
                                        quantity: qty,
                                        maxQuantity: maxQty,
                                        exceedPercentage: exceedPercentage.toFixed(1)
                                    });
                                }
                            });
                        });
                        
                        // 如果有超过待发数量10%的商品，显示确认对话框
                        if (hasExceededQuantity) {
                            let message = '以下商品数量超过待发数量10%：\n\n';
                            exceededItems.forEach(item => {
                                message += `包裹${item.packageIndex} - ${item.productName}${item.color ? `(${item.color})` : ''}\n`;
                                message += `数量: ${item.quantity}, 待发: ${item.maxQuantity}, 超出: ${item.exceedPercentage}%\n\n`;
                            });
                            message += '是否确认提交？';
                            
                            await ElementPlus.ElMessageBox.confirm(message, '数量超出提示', {
                                confirmButtonText: '确认提交',
                                cancelButtonText: '返回修改',
                                type: 'warning'
                            });
                        }
                        
                        // 按包裹ID分组商品
                        const packageArrays = this.deliveryForm.packages.map(pkg => {
                            return pkg.items
                                .filter(item => parseInt(item.quantity) > 0)
                                .map(item => ({
                                    product_id: item.product_id,
                                    quantity: parseInt(item.quantity),
                                    color: item.color || '',
                                    package_id: pkg.packageId,
                                }));
                        }).filter(items => items.length > 0);
                        
                        const deliveryData = {
                            customer_name: this.deliveryForm.customerName,
                            customer_id: this.selectedOrder.user.id,
                            customer_phone: this.deliveryForm.customerPhone || '',
                            customer_address: this.deliveryForm.deliveryAddress || '',
                            order_number: this.deliveryForm.orderNumber,
                            delivery_date: this.deliveryForm.deliveryDate,
                            status: 1,
                            remark: this.deliveryForm.remark || '',
                            packages: packageArrays
                        };
                        
                        const response = await axios.post('/delivery_orders', deliveryData);
                        if (response.status === 201 || response.status === 200) {
                            ElementPlus.ElMessage.success('发货单已提交成功');
                            this.createDeliveryVisible = false;
                            this.loadDeliveryOrders();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.handleAxiosError(error, '提交发货单失败');
                        }
                    }
                },
                // 处理商品选择
                handleProductSelectionChange(selection) {
                    this.selectedProducts = selection;
                },

                async handleBatchDelete() {
                    try {
                        await ElementPlus.ElMessageBox.confirm(
                            `确定要删除选中的 ${this.selectedProducts.length} 个商品吗？`,
                            '警告',
                            {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'warning'
                            }
                        );
                        
                        const productIds = this.selectedProducts.map(p => p.id);
                        const response = await axios.post('/products/batch/delete', {
                            product_ids: productIds
                        });
                        
                        if (response.data.code === 200) {
                            ElementPlus.ElMessage.success(response.data.message);
                            this.loadProducts();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.handleAxiosError(error, '批量删除失败');
                        }
                    }
                },
                async loadPushOrders() {
                    try {
                        this.pushLoading = true;
                        const response = await axios.get('/push_orders', {
                            params: {
                                keyword: this.pushSearch.keyword,
                                status: this.pushSearch.status
                            }
                        });
                        if (response.status === 200) {
                            this.pushOrders = response.data.orders;
                            this.pushPagination.total = response.data.total;
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '加载推送单列表失败');
                    } finally {
                        this.pushLoading = false;
                    }
                },
                handlePushSearch() {
                    this.pushPagination.currentPage = 1;
                    this.loadPushOrders();
                },
                handlePushPageChange(page, pageSize) {
                    this.pushPagination.currentPage = page;
                    this.pushPagination.pageSize = pageSize;
                    this.loadPushOrders();
                },
                viewPushDetail(order) {
                    this.pushDetailVisible = true;
                    this.currentPushOrder = order;
                },
                handleInvalidatePush(order) {
                    this.handleAxiosError(new Error('推送单已失效'));
                    this.loadPushOrders();
                },
                handleActivatePush(order) {
                    this.handleAxiosError(new Error('推送单已激活'));
                    this.loadPushOrders();
                },
                handleDeletePush(order) {
                    this.handleAxiosError(new Error('推送单已删除'));
                    this.loadPushOrders();
                },
                getImageUrl(path) {
                    return this.httpsBaseUrl + path;

                },          
             
                // 处理图片链接
                handleImageUrl(url) {
                    if (!url) return '';
                    try {
                        if (url.startsWith('http')) {
                            return url;
                        }
                    if (url.startsWith('cloud://')) {
                            return url.replace(
                                this.cloudBaseUrl,
                                this.httpsBaseUrl
                            );
                        }
                        return `http://127.0.0.1/${url}`;
                    } catch (error) {
                        console.error('处理图片URL失败:', error);
                        return '';
                    }
                },
               

                // 处理文件变化
                handleFileChange(file, fileList) {
                    console.log('文件改变:', file, fileList);
                    this.fileList = fileList;
                    
                },

                // 处理超出限制
                handleExceed(files, fileList) {
                    this.$message.warning(`最多只能上传 9 张图片`);
                },
                // 处理文件移除
                async handleRemove(file) {
                    try {
                        console.log('删除前文件列表长度:', this.fileList.length);
                        console.log('删除文件:', file);
                        
                        // 使用uid查找更准确，因为Element Plus的on-remove事件是在用户点击删除按钮后调用的
                        // 此时文件已经从fileList中移除
                        const fileIndex = this.fileList.findIndex(item => item.uid === file.uid);
                        console.log('找到的文件索引:', fileIndex);
                        
                        // 检查fileList中是否已有要删除的文件（可能已经被组件本身移除）
                        const fileExists = fileIndex !== -1;
                        
                        if (fileExists) {
                            // 如果文件还在fileList中，手动删除
                            this.fileList.splice(fileIndex, 1);
                        }
                        
                        console.log('删除后文件列表长度:', this.fileList.length);
                        
                        // 无论如何都更新商品图片列表
                        this.productForm.images = this.fileList.map(file => this.httpstocloud(file.url));
                        
                        // 如果是编辑模式，直接更新商品信息
                        if (this.dialogType === 'edit' && this.productForm.id) {
                            const specs = this.productForm.specs.map(spec => ({
                                color: spec.color,
                                stock: parseInt(spec.stock) || 0
                            }));
                            
                            const submitData = {
                                id: this.productForm.id,
                                name: this.productForm.name.trim(),
                                description: this.productForm.description.trim(),
                                price: parseFloat(this.productForm.price) || 0,
                                cost_price: parseFloat(this.productForm.cost_price) || 0,
                                price_b: parseFloat(this.productForm.price_b) || 0,
                                price_c: parseFloat(this.productForm.price_c) || 0,
                                price_d: parseFloat(this.productForm.price_d) || 0,
                                specs: specs,
                                images: this.productForm.images,
                                type: parseInt(this.productForm.style) || 1,
                                stock: specs.reduce((sum, spec) => sum + (parseInt(spec.stock) || 0), 0),
                                stock_warning: parseInt(this.productForm.stock_warning) || 10,
                                size: (this.productForm.size || '').trim(),
                                weight: parseFloat(this.productForm.weight) || 0,
                                yarn: (this.productForm.yarn || '').trim(),
                                composition: (this.productForm.composition || '').trim()

                            };
                            console.log('提交数据:', submitData.images);
                            const response = await axios.post(`/products`, submitData);
                            if (response.status === 200) {
                                this.$message.success('商品信息更新成功');
                            }
                        }
                    } catch (error) {
                        console.error('更新商品信息失败:', error);
                        this.$message.error('更新商品信息失败：' + error.message);
                        // 如果更新失败，恢复文件列表
                        this.fileList = [...this.fileList, file];
                        this.productForm.images = this.fileList.map(file => this.httpstocloud(file.url));
                    }
                },
                async customUpload({ file }) {
                    try {
                        const uploadInfo = this.fileUploadInfo.get(file.uid);
                        if (!uploadInfo) {
                            ElementPlus.ElMessage.error('未找到文件上传信息');
                            throw new Error('未找到文件上传信息');
                        }
                        const formData = new FormData();
                        formData.append('key', uploadInfo.path);
                        formData.append('Signature', uploadInfo.authorization);
                        formData.append('x-cos-security-token', uploadInfo.token);
                        formData.append('x-cos-meta-fileid', uploadInfo.cos_file_id);
                        formData.append('file', file);
                        const response = await axios.post(uploadInfo.url, formData);
                        console.log('上传成功:', response);

                        // 构建完整的文件URL
                        const fileUrl = `${this.httpsBaseUrl}/${uploadInfo.path}`;
                        
                        // 清理该文件的上传信息
                        this.fileUploadInfo.delete(file.uid);
                        
                        // 更新productForm.images数组
                        if (!this.productForm.images) { this.productForm.images = []; }
                        this.productForm.images.push(uploadInfo.file_id);
                        
                        // 同步更新fileList
                        const fileIndex = this.fileList.findIndex(item => item.uid === file.uid);
                        if (fileIndex > -1) {
                            this.fileList[fileIndex].url = fileUrl;
                            this.fileList[fileIndex].status = 'success';
                        } else {
                            this.fileList.push({
                                name: file.name,
                                url: fileUrl,
                                status: 'success',
                                uid: file.uid
                            });
                        }
                        
                        if (this.productForm.id) {
                            this.tempProductId = this.productForm.id;
                        }
                        if (this.tempProductId) {
                            const productsResponse = await axios.post('/products', {
                                id: this.tempProductId,  // 商品ID
                                images: this.productForm.images  // 图片列表
                            });
                            
                            if (productsResponse.status === 200 || productsResponse.status === 201) {
                                console.log('更新商品图片成功:', productsResponse);   
                                this.uploadedFiles++;
                                console.log('已上传文件数:', this.uploadedFiles);
                                
                                // 修改这里的逻辑
                                if (this.uploadedFiles >= this.totalFiles && this.imagesLoading) {
                                    try {
                                        this.imagesLoading.close();
                                    } catch (e) {
                                        console.warn('关闭loading失败:', e);
                                    }
                                    this.imagesLoading = null;  // 清空引用
                                    this.loadProducts();
                                }
                                ElementPlus.ElMessage.success('图片上传成功');
                            }
                        } else {
                            ElementPlus.ElMessage.error('未找到商品ID');
                            
                            throw new Error('未找到商品ID');
                        }
                        
                        console.log('上传成功:', fileUrl);
                        return {
                            url: fileUrl // 返回完整的文件URL
                        };
                    } catch (error) {
                        console.error('上传失败:', error);
                        // 确保在出错时也能正确关闭loading
                        if (this.imagesLoading) {
                            try {
                                this.imagesLoading.close();
                            } catch (e) {
                                console.warn('关闭loading失败:', e);
                            }
                            this.imagesLoading = null;
                        }
                        ElementPlus.ElMessage.error('图片上传失败：' + error.message);
                        throw error;
                    }
                },
                handleDialogClose() {
                    this.loadProducts(); // 刷新商品列表数据
                    this.fileList = []; // 清空文件列表
                    this.productForm = { // 重置表单
                        size: '',
                        weight: 0,
                        yarn: '',
                        composition: '',
                        specs: [],
                        status: 1,
                        is_public: 0
                    };
                },
                showBatchStyleDialog() {
                    console.log('打开批量修改款式对话框');
                    this.batchStyleDialogVisible = true;
                    this.batchStyleForm.type = '';
                },
                async handleBatchStyleUpdate() {
                    if (!this.batchStyleForm.type) {
                        ElementPlus.ElMessage.warning('请选择款式');
                        return;
                    }
                    const loading = ElementPlus.ElLoading.service({
                        lock: true,
                        text: '正在更新...',
                        background: 'rgba(0, 0, 0, 0.7)'
                    });
                    try {
                        const productIds = this.selectedProducts.map(product => product.id);
                        const response = await axios.post('/products/batch-update', {
                            ids: productIds,
                            type: this.batchStyleForm.type
                        });
                        
                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('批量更新成功');
                            this.batchStyleDialogVisible = false;
                            this.loadProducts();
                            this.$refs.productTable.clearSelection();
                        }
                    } catch (error) {
                        console.error('批量更新失败:', error);
                        ElementPlus.ElMessage.error('批量更新失败：' + error.message);
                    } finally {
                        loading.close();
                    }
                },
                handleSelectionChange(selection) {
                    console.log('选中的商品：', selection);
                    this.selectedProducts = selection;
                },
                // 系统管理相关方法
                showSystemSettings() {
                    this.loadSystemSettings().then(() => {
                        this.systemSettingsVisible = true;
                    }).catch(error => {
                        this.$message.error('加载系统设置失败：' + error.message);
                    });
                },
                closeSystemSettings() {
                    this.systemSettingsVisible = false;
                    // 延迟一段时间再重置数据，确保对话框已完全关闭
                    setTimeout(() => {
                        this.systemSettings = {};
                    }, 300);
                },
                async loadSystemSettings() {
                    try {
                        const response = await axios.get('/system/settings');
                        if (response.status === 200) {
                            this.systemSettings = response.data.settings || {};
                            return Promise.resolve(this.systemSettings);
                        }
                        return Promise.reject(new Error('加载系统设置失败'));
                    } catch (error) {
                        console.error('加载系统设置失败:', error);
                        return Promise.reject(error);
                    }
                },
                async saveSystemSettings() {
                    try {
                        const response = await axios.post('/system/settings', this.systemSettings);
                        if (response.status === 200) {
                            this.$message.success('保存成功');
                            this.systemSettingsVisible = false;
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '保存系统设置失败');
                    }
                },
                // 商品款式管理
                showStyleSettings() {
                    this.styleSettingsVisible = true;
                    this.loadStyleSettings();
                },
                async loadStyleSettings() {
                    try {
                        const response = await axios.get('/system/settings');
                        if (response.status === 200) {
                            this.product_types = response.data.product_types || [];
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '加载款式设置失败');
                    }
                },
                async saveStyleSettings() {
                    try {
                        const response = await axios.put('/system/settings', {
                            product_types: this.product_types
                        });
                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('保存成功');
                            this.styleSettingsVisible = false;
                            // 重新加载款式选项
                            await this.loadStyleOptions();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '保存款式设置失败');
                    }
                },
                handleAddStyle() {
                    const maxId = Math.max(...this.product_types.map(type => type.id), 0);
                    this.product_types.push({
                        id: maxId + 1,
                        name: ''
                    });
                },
                handleRemoveStyle(index) {
                    this.product_types.splice(index, 1);
                },
                // 移动款式位置
                moveStyle(index, direction) {
                    if (direction === 'up' && index > 0) {
                        // 上移
                        const temp = this.product_types[index];
                        this.product_types[index] = this.product_types[index - 1];
                        this.product_types[index - 1] = temp;
                    } else if (direction === 'down' && index < this.product_types.length - 1) {
                        // 下移
                        const temp = this.product_types[index];
                        this.product_types[index] = this.product_types[index + 1];
                        this.product_types[index + 1] = temp;
                    }
                },
                // 加载款式选项
                async loadStyleOptions() {
                    try {
                        const response = await axios.get('/system/settings');
                        if (response.status === 200) {
                            this.styleOptions = response.data.product_types || [];
                            this.styleOptions.unshift({
                                id: null,
                                name: '全部'
                            });
                            console.log('加载款式选项成功:', this.styleOptions);
                        }
                    } catch (error) {
                        console.error('加载款式选项失败:', error);
                        this.handleAxiosError(error, '加载款式选项失败');
                    }
                },
                // 上传成功的回调
                handleUploadSuccess(response, file, fileList) {
                    console.log('上传成功:', response);
                    this.fileList = fileList;
                    
                    // 检查是否所有文件都上传完成
                    const allFilesUploaded = fileList.every(file => 
                        file.status === 'success' || file.status === 'fail'
                    );
                    
                    if (allFilesUploaded) {
                        this.closeLoading(); // 所有文件上传完成，关闭 loading
                    }
                },
                // 上传出错的回调
                handleUploadError(error, file, fileList) {
                    console.error('上传出错:', error);
                    this.$message.error('上传失败');
                    
                    // 检查是否所有文件都处理完成
                    const allFilesProcessed = fileList.every(file => 
                        file.status === 'success' || file.status === 'fail'
                    );
                    
                    if (allFilesProcessed) {
                        this.closeLoading(); // 所有文件处理完成，关闭 loading
                    }
                },
                
                // 关闭 loading
                closeLoading() {
                    if (this.imagesLoading) {
                        this.imagesLoading.close();
                        this.imagesLoading = null;
                    }
                },
                onImageLoad(e) {
                    console.log('图片加载完成', e);
                },
                // 更新筛选选项
                updateFilters() {
                    // 获取所有不重复的尺寸
                    const sizes = new Set(this.products.map(p => p.size).filter(Boolean));
                    this.sizeFilters = Array.from(sizes).map(size => ({ text: size, value: size }));

                    // 获取所有不重复的克重并排序
                    const weights = new Set(this.products.map(p => p.weight).filter(Boolean));
                    this.weightFilters = Array.from(weights).sort((a, b) => a - b)
                        .map(weight => ({ text: `${weight}g`, value: weight }));

                    // 获取所有不重复的材质
                    const yarns = new Set(this.products.map(p => p.yarn).filter(Boolean));
                    this.yarnFilters = Array.from(yarns).map(yarn => ({ text: yarn, value: yarn }));

                    // 获取所有不重复的成分
                    const compositions = new Set(this.products.map(p => p.composition).filter(Boolean));
                    this.compositionFilters = Array.from(compositions).map(comp => ({ text: comp, value: comp }));
                },

                // 款式筛选方法
                filterType(value, row) {
                    return row.type === value;
                },

                // 尺寸筛选方法
                filterSize(value, row) {
                    return row.size === value;
                },

                // 克重筛选方法
                filterWeight(value, row) {
                    return row.weight === value;
                },

                // 材质筛选方法
                filterYarn(value, row) {
                    return row.yarn === value;
                },

                // 成分筛选方法
                filterComposition(value, row) {
                    return row.composition === value;
                },

                // 加载筛选选项
                async loadFilterOptions() {
                    try {
                        const response = await axios.get('/products/filter-options');
                        if (response.data.code === 0) {
                            // 为每个筛选选项添加"全部"选项
                            this.filterOptions = {
                                sizes: [{ text: '全部', value: null }, ...response.data.data.sizes],
                                weights: [{ text: '全部', value: null }, ...response.data.data.weights],
                                yarns: [{ text: '全部', value: null }, ...response.data.data.yarns],
                                compositions: [{ text: '全部', value: null }, ...response.data.data.compositions]
                            };
                            console.log( "规格筛选值：",this.filterOptions);
                        }
                    } catch (error) {
                        console.error('加载筛选选项失败:', error);
                        ElementPlus.ElMessage.error('加载筛选选项失败');
                    }
                },

                // 重置特定筛选条件
                resetSpecificFilter(filterType) {
                    this.selectedFilters[filterType] = null;
                    this.filterVisible[filterType] = false;
                    this.handleProductSearch();
                },

                // 处理筛选搜索
                handleProductSearch() {
                    // 更新筛选条件
                    this.productFilter.type = this.selectedFilters.type;
                    this.productFilter.size = this.selectedFilters.size;
                    this.productFilter.weight = this.selectedFilters.weight;
                    this.productFilter.yarn = this.selectedFilters.yarn;
                    this.productFilter.composition = this.selectedFilters.composition;
                    // 关闭所有筛选弹窗
                    Object.keys(this.filterVisible).forEach(key => {
                        this.filterVisible[key] = false;
                    });
                    
                    // 重置到第一页
                    this.productFilter.page = 1;
                    // 重新加载数据
                    this.loadProducts();
                },

                selectImage(file) {
                    this.selectedImageUrl = file.url;
                    this.confirmColorImage();
                },

                confirmColorImage() {
                    
                    if (this.currentColorIndex >= 0 && this.selectedImageUrl) {
                        // 替换图片URL中的域名
                        if (this.selectedImageUrl.startsWith(this.httpsBaseUrl)) {
                            this.selectedImageUrl = this.httpstocloud(this.selectedImageUrl);
                        }
                        this.productForm.specs[this.currentColorIndex].image = this.selectedImageUrl;
                    }

                    console.log('确认颜色图片', this.productForm.specs);
                    this.colorImageDialogVisible = false;
                    this.currentColorIndex = -1;
                    this.selectedImageUrl = '';
                },

                cloudtohttps(url) {
                    return url.replace(
                        this.cloudBaseUrl,
                        this.httpsBaseUrl
                    );
                },
                httpstocloud(url) {
                    return url.replace(
                        this.httpsBaseUrl,
                        this.cloudBaseUrl
                    );
                },

                handleColorImageClick(index) {
                    this.currentColorIndex = index;
                    this.selectedImageUrl = this.productForm.specs[index].image || '';
                    this.colorImageDialogVisible = true;
                },
                toggleEditMode() {
                    this.isEditMode = !this.isEditMode;
                },

                async handleSpecsSave(row) {
                    try {

                        const response = await axios.post(`/products`, {
                            id: row.id,
                            size: row.size || '',
                            weight: row.weight || null,
                            yarn: row.yarn || '',
                            composition: row.composition || '',                           
                        });
                        console.log('保存规格', response);

                        if (response.status === 200) {
                            this.$message.success('保存成功');
                        } else {
                            this.$message.error(response.data.message || '保存失败');
                            await this.loadProducts();
                        }
                    } catch (error) {
                        console.error('保存失败:', error);
                        this.$message.error('保存失败');
                        await this.loadProducts();
                    }
                },
                
                // 初始化拖拽排序功能
                initSortable() {
                    this.$nextTick(() => {
                        const el = document.querySelector('.el-upload-list--picture-card');
                        if (el) {
                            this.sortable = Sortable.create(el, {
                                animation: 150,
                                ghostClass: 'sortable-ghost',
                                onEnd: (evt) => {
                                    // 更新文件列表顺序
                                    const itemEl = evt.item;
                                    const newIndex = evt.newIndex;
                                    const oldIndex = evt.oldIndex;
                                    
                                    if (newIndex !== oldIndex) {
                                        // 从旧位置移除，在新位置插入
                                        const movedItem = this.fileList.splice(oldIndex, 1)[0];
                                        this.fileList.splice(newIndex, 0, movedItem);
                                        
                                        // 更新预览图片列表
                                        this.previewSrcList = this.fileList.map(file => file.url);
                                        
                                        // 更新表单数据中的图片顺序
                                        if (this.productForm.images) {
                                            this.productForm.images = this.fileList.map(file => file.url);
                                        }
                                        
                                        ElementPlus.ElMessage.success('图片顺序已更新');
                                    }
                                }
                            });
                        }
                    });
                },
                async handleBeforeVideoUpload(file) {
                    // 检查文件类型
                    const isVideo = ['video/mp4', 'video/quicktime', 'video/avi', 'video/webm'].includes(file.type);
                    if (!isVideo) {
                        ElementPlus.ElMessage.error('请上传MP4/MOV/AVI/WebM格式的视频');
                        return false;
                    }
                    
                    // 检查文件大小 (50MB)
                    const isLessThan50MB = file.size / 1024 / 1024 < 50;
                    if (!isLessThan50MB) {
                        ElementPlus.ElMessage.error('视频大小不能超过50MB');
                        return false;
                    }
                    
                    this.imagesLoading = ElementPlus.ElLoading.service({
                        lock: true,
                        text: '视频上传中...',
                        background: 'rgba(0, 0, 0, 0.7)'
                    });
                    
                    try {
                        // 使用时间戳和随机数生成唯一文件名
                        const timestamp = Date.now();
                        const random = Math.random().toString(36).substr(2, 6);
                        const ext = file.name.split('.').pop();
                        const fileName = `${timestamp}_${random}.${ext}`;
                        const path = `videos/${fileName}`;
                        
                        const uploadResponse = await axios.post('/get_uploadfileUrl', {
                            path: path
                        });
                        
                        const uploadData = uploadResponse.data;
                        if (uploadData.errcode !== 0) {
                            throw new Error(uploadData.errmsg);
                        }
                        
                        // 存储上传信息
                        this.fileUploadInfo.set(file.uid, {
                            ...uploadData,
                            path: path,
                            file: file
                        });
                        
                        return true;
                    } catch (error) {
                        console.error('准备视频上传失败:', error);
                        ElementPlus.ElMessage.error('视频准备失败：' + error.message);
                        if (this.imagesLoading) {
                            this.imagesLoading.close();
                        }
                        return false;
                    }
                },
                
                async customVideoUpload({ file }) {
                    try {
                        const uploadInfo = this.fileUploadInfo.get(file.uid);
                        if (!uploadInfo) {
                            ElementPlus.ElMessage.error('未找到视频上传信息');
                            throw new Error('未找到视频上传信息');
                        }
                        
                        const formData = new FormData();
                        formData.append('key', uploadInfo.path);
                        formData.append('Signature', uploadInfo.authorization);
                        formData.append('x-cos-security-token', uploadInfo.token);
                        formData.append('x-cos-meta-fileid', uploadInfo.cos_file_id);
                        formData.append('file', file);
                        
                        const response = await axios.post(uploadInfo.url, formData);
                        
                        // 构建完整的文件URL
                        const fileUrl = `${this.httpsBaseUrl}/${uploadInfo.path}`;
                        
                        // 清理该文件的上传信息
                        this.fileUploadInfo.delete(file.uid);
                        
                        // 更新产品表单
                        this.productForm.video_url = uploadInfo.file_id;
                        this.videoPreviewUrl = fileUrl;
                        
                        // 同步更新videoFileList
                        this.videoFileList = [{
                            name: file.name,
                            url: fileUrl,
                            status: 'success',
                            uid: file.uid
                        }];
                        
                        // 如果是编辑模式并且已有商品ID，更新商品信息
                        if (this.productForm.id) {
                            await axios.post('/products', {
                                id: this.productForm.id,
                                video_url: this.productForm.video_url
                            });
                        }
                        
                        if (this.imagesLoading) {
                            this.imagesLoading.close();
                        }
                        
                        ElementPlus.ElMessage.success('视频上传成功');
                        
                        return {
                            url: fileUrl
                        };
                    } catch (error) {
                        console.error('视频上传失败:', error);
                        ElementPlus.ElMessage.error('视频上传失败：' + error.message);
                        if (this.imagesLoading) {
                            this.imagesLoading.close();
                        }
                        throw error;
                    }
                },
                
                handleVideoUploadSuccess(response, file) {
                    this.videoPreviewUrl = response.url;
                    this.videoFileList = [file];
                },
                
                handleVideoRemove() {
                    this.videoPreviewUrl = '';
                    this.productForm.video_url = '';
                    this.videoFileList = [];
                },
                
                removeVideo() {
                    this.handleVideoRemove();
                    ElementPlus.ElMessage.success('视频已删除');
                },
                
                openVideoPreview() {
                    this.videoDialogVisible = true;
                },
                
                // 修改商品编辑方法，加载视频信息
                handleEdit(row) {
                    this.dialogType = 'edit';
                    this.editingProductId = row.id;
                    
                    // 解析数据
                    const images = typeof row.images === 'string' ? JSON.parse(row.images) : (row.images || []);
                    const specs = typeof row.specs === 'string' ? JSON.parse(row.specs) : (row.specs || []);
                    const tags = typeof row.tags === 'string' ? JSON.parse(row.tags) : (row.tags || []);
                    
                    // 设置文件列表
                    this.fileList = images.map(url => ({
                        name: url.split('/').pop(),
                        url: this.handleImageUrl(url),
                        status: 'success'
                    }));
                    
                    // 更新预览图片列表
                    this.previewSrcList = this.fileList.map(file => file.url);
                    
                    // 处理视频文件
                    if (row.video_url) {
                        const videoUrl = this.handleImageUrl(row.video_url);
                        this.videoPreviewUrl = videoUrl;
                        this.videoFileList = [{
                            name: row.video_url.split('/').pop(),
                            url: videoUrl,
                            status: 'success'
                        }];
                    } else {
                        this.videoPreviewUrl = '';
                        this.videoFileList = [];
                    }
                    
                    // 设置表单数据
                    this.productForm = {
                        id: row.id,
                        name: row.name,
                        price: parseFloat(row.price) || 0,
                        cost_price: parseFloat(row.cost_price) || 0,
                        price_b: parseFloat(row.price_b) || 0,
                        price_c: parseFloat(row.price_c) || 0,
                        price_d: parseFloat(row.price_d) || 0,
                        description: row.description || '',
                        style: parseInt(row.type) || 1,
                        colors: specs.map(spec => spec.color),  // 提取颜色列表
                        specs: specs,  // 保存完整的规格数据（包含库存）
                        tags: tags,
                        images: images,
                        video_url: row.video_url || '',
                        stock: parseInt(row.stock) || 0,
                        stock_warning: parseInt(row.stock_warning) || 10,
                        created_at: row.created_at,
                        size: row.size || '',
                        weight: parseFloat(row.weight) || 0,
                        yarn: row.yarn || '',
                        composition: row.composition || '',
                        status: row.status || 1,
                        is_public: row.is_public || 0
                    };

                    // 解析标签数据
                    const uniqueTags = [...new Set(tags)];
                    
                    // 更新预设标签的选中状态
                    this.selectedPresetTags = uniqueTags.filter(tag => this.presetTags.includes(tag));
                    
                    // 设置预设颜色的选中状态
                    this.selectedPresetColors = specs
                        .map(spec => spec.color)
                        .filter(color => this.presetColors.includes(color));

                    // 设置自定义颜色
                    this.customColorInput = specs.map(spec => spec.color);
                    this.customColorOptions = specs
                        .map(spec => spec.color)
                        .filter(color => !this.presetColors.includes(color));

                    // 直接设置所有标签到 productForm.tags
                    this.productForm.tags = uniqueTags;

                    // 最后再打开对话框
                    this.$nextTick(() => {
                        this.dialogVisible = true;
                        // 延迟初始化排序功能，确保DOM已更新
                        setTimeout(() => {
                            this.initSortable();
                        }, 300);
                    });
                },
                
                // 修改商品添加对话框初始化方法，重置视频相关字段
                showAddProductDialog() {
                    this.dialogType = 'add';
                    this.productForm = {
                        id: '',
                        name: '',
                        price: 0,
                        cost_price: 0,
                        price_b: 0,
                        price_c: 0,
                        price_d: 0,
                        style: 1,
                        colors: ['灰色', '黑色'],  // 默认颜色
                        specs: [                 // 初始化 specs 数组
                            { color: '灰色', stock: 0 },
                            { color: '黑色', stock: 0 }
                        ],
                        images: [],
                        video_url: '',
                        description: '暂时没有',
                        stock: 0,
                        stock_warning: 10,
                        size: '',               // 尺寸
                        weight: 0,              // 克重
                        yarn: '',               // 材质
                        composition: '',         // 成分
                        status: 1,          // 默认上架
                        is_public: 0            // 默认私密
                    };
                    // 清空文件列表
                    if (this.$refs.uploadRef) {
                        this.$refs.uploadRef.clearFiles();
                    }
                    // 清空视频文件
                    this.videoPreviewUrl = '';
                    this.videoFileList = [];
                    
                    this.dialogVisible = true;
                    this.selectedPresetColors = [];
                    this.customColorInput = [];
                    this.customColorOptions = [];
                    
                    // 延迟初始化排序功能，确保DOM已更新
                    setTimeout(() => {
                        this.initSortable();
                    }, 300);
                },
                
                // 修改提交方法，添加视频URL
                async submitProduct() {
                    try {
                        await this.$refs.productFormRef.validate(); // 验证表单

                        // 处理规格数据
                        const specs = this.productForm.specs.map(spec => ({
                            color: spec.color,
                            stock: parseInt(spec.stock) || 0,
                            image: spec.image || ''
                        }));

                        const submitData = {
                            id: this.productForm.id,
                            name: this.productForm.name.trim(),
                            description: this.productForm.description.trim(),
                            price: parseFloat(this.productForm.price) || 0,
                            cost_price: parseFloat(this.productForm.cost_price) || 0,
                            price_b: parseFloat(this.productForm.price_b) || 0,
                            price_c: parseFloat(this.productForm.price_c) || 0,
                            price_d: parseFloat(this.productForm.price_d) || 0,
                            specs: specs,
                            images: this.productForm.images || [],
                            video_url: this.productForm.video_url || '',
                            type: parseInt(this.productForm.style) || 1,
                            stock: specs.reduce((sum, spec) => sum + (parseInt(spec.stock) || 0), 0),
                            stock_warning: parseInt(this.productForm.stock_warning) || 10,
                            created_at: this.dialogType === 'add' ? new Date().toISOString() : this.productForm.created_at,
                            size: (this.productForm.size || '').trim(),
                            weight: parseFloat(this.productForm.weight) || 0,
                            yarn: (this.productForm.yarn || '').trim(),
                            composition: (this.productForm.composition || '').trim(),
                            status: this.productForm.status,
                            is_public: this.productForm.is_public
                        };
                        
                        const url = `/products`;
                        const method = 'post';
                        const response = await axios[method](url, submitData);
                        

                        if (response.status === 200 || response.status === 201) {
                            ElementPlus.ElMessage.success(this.dialogType === 'add' ? '添加成功' : '更新成功');
                            if (this.dialogType === 'add') {
                                const uploadComponent = this.$refs.uploadRef;
                                this.totalFiles = 0;
                                this.uploadedFiles = 0;
                                console.log('商品创建/更新成功返回:', response.data.product_id);
                                this.tempProductId = response.data.product_id;
                                
                                await new Promise(resolve => setTimeout(resolve, 200));
                                await uploadComponent.submit();   
                                console.log('商品创建/更新成功返回:', this.tempProductId);
                            }
                            this.dialogVisible = false;
                            this.loadProducts();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '保存商品失败');
                    }
                },
                showRecommendedProducts() {
                    this.recommendedProductsVisible = true;
                    this.loadRecommendedProducts();
                },
                async loadRecommendedProducts() {
                    try {
                        const response = await axios.get('/recommended/products');
                        if (response.data.code === 0) {
                            this.recommendedProducts = response.data.data || [];
                            console.log('推荐商品列表:', this.recommendedProducts);
                        } else {
                            this.$message.error('加载推荐商品失败: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('加载推荐商品失败:', error);
                        this.$message.error('加载推荐商品失败');
                    }
                },
                async searchProductsForRecommended() {
                    if (!this.recommendedSearch.keyword.trim()) {
                        this.$message.warning('请输入搜索关键词');
                        return;
                    }
                    
                    try {
                        const response = await axios.get('/products', {
                            params: {
                                keyword: this.recommendedSearch.keyword,
                                page: 1,
                                page_size: 10
                            }
                        });
                        console.log('搜索商品结果:', response.data);
                        
                        if (response.status === 200) {
                            this.searchProductsResults = response.data.products || [];
                            if (this.searchProductsResults.length === 0) {
                                this.$message.info('未找到相关商品');
                            }
                        }
                    } catch (error) {
                        console.error('搜索商品失败:', error);
                        this.$message.error('搜索商品失败');
                    }
                },
                isProductRecommended(productId) {
                    return this.recommendedProducts.some(p => p.id === productId);
                },
                async addToRecommended(product) {
                    if (this.isProductRecommended(product.id)) {
                        this.$message.warning('该商品已经在推荐列表中');
                        return;
                    }
                    
                    try {
                        // 构建新的推荐列表
                        const newRecommendedList = [...this.recommendedProducts, product];
                        const productIds = newRecommendedList.map(p => p.id);
                        
                        const response = await axios.post('/recommended/products', {
                            product_ids: productIds
                        });
                        
                        if (response.data.code === 0) {
                            this.$message.success('添加推荐商品成功');
                            await this.loadRecommendedProducts();
                            // 清空搜索结果
                            this.recommendedSearch.keyword = '';
                            this.searchProductsResults = [];
                        } else {
                            this.$message.error('添加推荐商品失败: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('添加推荐商品失败:', error);
                        this.$message.error('添加推荐商品失败');
                    }
                },
                async moveRecommendedProduct(index, direction) {
                    if (direction === 'up' && index > 0) {
                        // 向上移动
                        const temp = this.recommendedProducts[index];
                        this.recommendedProducts[index] = this.recommendedProducts[index - 1];
                        this.recommendedProducts[index - 1] = temp;
                    } else if (direction === 'down' && index < this.recommendedProducts.length - 1) {
                        // 向下移动
                        const temp = this.recommendedProducts[index];
                        this.recommendedProducts[index] = this.recommendedProducts[index + 1];
                        this.recommendedProducts[index + 1] = temp;
                    } else {
                        return; // 无效的移动
                    }
                    
                    // 保存新的顺序
                    await this.saveRecommendedProducts();
                },
                async removeFromRecommended(index) {
                    try {
                        // 构建新的推荐列表
                        const newRecommendedList = [...this.recommendedProducts];
                        newRecommendedList.splice(index, 1);
                        
                        const productIds = newRecommendedList.map(p => p.id);
                        
                        const response = await axios.post('/recommended/products', {
                            product_ids: productIds
                        });
                        
                        if (response.data.code === 0) {
                            this.$message.success('移除推荐商品成功');
                            await this.loadRecommendedProducts();
                        } else {
                            this.$message.error('移除推荐商品失败: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('移除推荐商品失败:', error);
                        this.$message.error('移除推荐商品失败');
                    }
                },
                async saveRecommendedProducts() {
                    try {
                        const productIds = this.recommendedProducts.map(p => p.id);
                        
                        const response = await axios.post('/recommended/products', {
                            product_ids: productIds
                        });
                        
                        if (response.data.code === 0) {
                            this.$message.success('更新推荐商品顺序成功');
                        } else {
                            this.$message.error('更新推荐商品顺序失败: ' + response.data.message);
                            // 如果失败，重新加载列表
                            await this.loadRecommendedProducts();
                        }
                    } catch (error) {
                        console.error('更新推荐商品顺序失败:', error);
                        this.$message.error('更新推荐商品顺序失败');
                        // 如果失败，重新加载列表
                        await this.loadRecommendedProducts();
                    }
                },
                // 添加处理状态变更的方法
                async handleStatusChange(row, field) {
                    try {
                        const response = await axios.post(`/products`, {
                            id: row.id,
                            [field]: row[field] === 1 ? 0 : 1
                        });
                        
                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('状态更新成功');
                            this.loadProducts();
                        } else {
                            ElementPlus.ElMessage.error('状态更新失败');
                            // 更新失败时恢复原状态
                            row[field] = row[field] === 1 ? 0 : 1;
                        }
                    } catch (error) {
                        console.error('状态更新失败:', error);
                        ElementPlus.ElMessage.error('状态更新失败');
                        // 更新失败时恢复原状态
                        row[field] = row[field] === 1 ? 0 : 1;
                    }
                },
                handleBatchCommand(command) {
                    switch(command) {
                        case 'delete':
                            this.handleBatchDelete();
                            break;
                        case 'style':
                            this.showBatchStyleDialog();
                            break;
                        case 'status':
                            this.batchStatusDialogVisible = true;
                            break;
                        case 'public':
                            this.batchPublicDialogVisible = true;
                            break;
                    }
                },

                async handleBatchStatusUpdate() {
                    try {
                        const productIds = this.selectedProducts.map(p => p.id);
                        const response = await axios.post('/products/batch/status', {
                            product_ids: productIds,
                            status: this.batchStatusForm.status
                        });
                        
                        if (response.data.code === 200) {
                            ElementPlus.ElMessage.success('批量更新状态成功');
                            this.batchStatusDialogVisible = false;
                            this.loadProducts();
                            this.$refs.productTable.clearSelection();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '批量更新状态失败');
                    }
                },

                async handleBatchPublicUpdate() {
                    try {
                        const productIds = this.selectedProducts.map(p => p.id);
                        const response = await axios.post('/products/batch/public', {
                            product_ids: productIds,
                            is_public: this.batchPublicForm.is_public
                        });
                        
                        if (response.data.code === 200) {
                            ElementPlus.ElMessage.success('批量更新公开状态成功');
                            this.batchPublicDialogVisible = false;
                            this.loadProducts();
                            this.$refs.productTable.clearSelection();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '批量更新公开状态失败');
                    }
                },
                showHiddenProducts() {
                    this.hiddenProductsVisible = true;
                    this.loadHiddenProducts();
                },
                async loadHiddenProducts() {
                    try {
                        const response = await axios.get('/api/hidden_products');
                        if (response.data.code === 0) {
                            this.hiddenProducts = response.data.data || [];
                            console.log('暗推产品列表:', this.hiddenProducts);
                        } else {
                            this.$message.error('加载暗推产品失败: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('加载暗推产品失败:', error);
                        this.$message.error('加载暗推产品失败');
                    }
                },
                async searchProductsForHidden() {
                    if (!this.hiddenSearch.keyword.trim()) {
                        this.$message.warning('请输入搜索关键词');
                        return;
                    }
                    
                    try {
                        const response = await axios.get('/products', {
                            params: {
                                keyword: this.hiddenSearch.keyword,
                                page: 1,
                                page_size: 10
                            }
                        });
                        console.log('搜索商品结果:', response.data);
                        
                        if (response.status === 200) {
                            this.searchProductsResults = response.data.products || [];
                            if (this.searchProductsResults.length === 0) {
                                this.$message.info('未找到相关商品');
                            }
                        }
                    } catch (error) {
                        console.error('搜索商品失败:', error);
                        this.$message.error('搜索商品失败');
                    }
                },
                isProductHidden(productId) {
                    return this.hiddenProducts.some(p => p.id === productId);
                },
                async addToHidden(product) {
                    if (this.isProductHidden(product.id)) {
                        this.$message.warning('该商品已经在暗推列表中');
                        return;
                    }
                    
                    try {
                        // 构建新的暗推列表
                        const newHiddenList = [...this.hiddenProducts, product];
                        const productIds = newHiddenList.map(p => p.id);
                        
                        const response = await axios.post('/api/hidden_products', {
                            product_ids: productIds
                        });
                        
                        if (response.data.code === 0) {
                            this.$message.success('添加暗推产品成功');
                            await this.loadHiddenProducts();
                            // 清空搜索结果
                            this.hiddenSearch.keyword = '';
                            this.searchProductsResults = [];
                        } else {
                            this.$message.error('添加暗推产品失败: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('添加暗推产品失败:', error);
                        this.$message.error('添加暗推产品失败');
                    }
                },
                async removeFromHidden(index) {
                    try {
                        // 构建新的暗推列表
                        const newHiddenList = [...this.hiddenProducts];
                        newHiddenList.splice(index, 1);
                        
                        const productIds = newHiddenList.map(p => p.id);
                        
                        const response = await axios.post('/api/hidden_products', {
                            product_ids: productIds
                        });
                        
                        if (response.data.code === 0) {
                            this.$message.success('移除暗推产品成功');
                            await this.loadHiddenProducts();
                        } else {
                            this.$message.error('移除暗推产品失败: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('移除暗推产品失败:', error);
                        this.$message.error('移除暗推产品失败');
                    }
                },
                async saveHiddenProducts() {
                    try {
                        const productIds = this.hiddenProducts.map(p => p.id);
                        
                        const response = await axios.post('/api/hidden_products', {
                            product_ids: productIds
                        });
                        
                        if (response.data.code === 0) {
                            this.$message.success('更新暗推产品顺序成功');
                        } else {
                            this.$message.error('更新暗推产品顺序失败: ' + response.data.message);
                            // 如果失败，重新加载列表
                            await this.loadHiddenProducts();
                        }
                    } catch (error) {
                        console.error('更新暗推产品顺序失败:', error);
                        this.$message.error('更新暗推产品顺序失败');
                        // 如果失败，重新加载列表
                        await this.loadHiddenProducts();
                    }
                },
                handleStatusFilterChange(value) {
                    this.selectedFilters.status = value;
                    this.handleProductSearch();
                },
                handleSortChange(column) {
                    // 处理排序逻辑
                    if (column.order === null) {
                        // 取消排序
                        this.productSearch.sortField = '';
                        this.productSearch.sortOrder = '';
                    } else {
                        this.productSearch.sortField = column.prop;
                        this.productSearch.sortOrder = column.order === 'ascending' ? 'asc' : 'desc';
                    }
                    this.handleProductSearch();
                },
                // 获取发货单对应状态的数量
                getDeliveryCount(status) {
                    if (status === 0) return this.deliveryStats.pending || 0;
                    if (status === 1) return this.deliveryStats.delivering || 0;
                    if (status === 2) return this.deliveryStats.completed || 0;
                    if (status === 3) return this.deliveryStats.cancelled || 0;
                    return 0;
                },

                // 获取发货单状态对应的徽章类型
                getDeliveryBadgeType(status) {
                    const types = {
                        0: 'warning',
                        1: 'success',
                        2: 'primary',
                        3: 'info'
                    };
                    return types[status] || 'info';
                },

                // 处理发货单页面大小变更
                handleDeliverySizeChange(size) {
                    this.deliveryPagination.pageSize = size;
                    this.loadDeliveryOrders();
                },

                // 计算订单商品总数
                getOrderItemsCount(order) {
                    if (!order || !order.items || !Array.isArray(order.items)) {
                        return 0;
                    }
                    
                    let totalItems = 0;
                    for (const item of order.items) {
                        totalItems += parseInt(item.quantity) || 0;
                    }
                    return totalItems;
                },

                // 处理发货单选择变化
                handleDeliverySelectionChange(selection) {
                    this.selectedDeliveries = selection;
                    
                    // 判断是否可以进行批量操作
                    this.canBatchShip = selection.some(item => item.status === 0);
                    this.canBatchComplete = selection.some(item => item.status === 1);
                    this.canBatchDelete = selection.some(item => [0, 3].includes(item.status));
                },

                // 批量标记为已发货
                async batchMarkAsShipped() {
                    try {
                        const eligibleOrders = this.selectedDeliveries.filter(order => order.status === 0);
                        if (eligibleOrders.length === 0) {
                            ElementPlus.ElMessage.warning('没有可标记为已发货的订单');
                            return;
                        }
                        
                        await ElementPlus.ElMessageBox.confirm(
                            `确定要将选中的 ${eligibleOrders.length} 个订单标记为已发货吗？`,
                            '批量操作'
                        );
                        
                        let successCount = 0;
                        let failCount = 0;
                        
                        for (const order of eligibleOrders) {
                            try {
                                const response = await axios.put(`/delivery_orders/${order.id}/status`, {
                                    status: 1
                                });
                                
                                if (response.status === 200) {
                                    successCount++;
                                } else {
                                    failCount++;
                                }
                            } catch (error) {
                                console.error(`标记订单 ${order.id} 失败:`, error);
                                failCount++;
                            }
                        }
                        
                        if (successCount > 0) {
                            ElementPlus.ElMessage.success(`成功标记 ${successCount} 个订单为已发货`);
                            this.loadDeliveryOrders();
                        }
                        
                        if (failCount > 0) {
                            ElementPlus.ElMessage.warning(`${failCount} 个订单标记失败`);
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('批量标记失败:', error);
                            ElementPlus.ElMessage.error('批量标记失败');
                        }
                    }
                },

                // 批量标记为已完成
                async batchMarkAsCompleted() {
                    try {
                        const eligibleOrders = this.selectedDeliveries.filter(order => order.status === 1);
                        if (eligibleOrders.length === 0) {
                            ElementPlus.ElMessage.warning('没有可标记为已完成的订单');
                            return;
                        }
                        
                        await ElementPlus.ElMessageBox.confirm(
                            `确定要将选中的 ${eligibleOrders.length} 个订单标记为已完成吗？`,
                            '批量操作'
                        );
                        
                        let successCount = 0;
                        let failCount = 0;
                        
                        for (const order of eligibleOrders) {
                            try {
                                const response = await axios.put(`/delivery_orders/${order.id}/status`, {
                                    status: 2
                                });
                                
                                if (response.status === 200) {
                                    successCount++;
                                } else {
                                    failCount++;
                                }
                            } catch (error) {
                                console.error(`标记订单 ${order.id} 失败:`, error);
                                failCount++;
                            }
                        }
                        
                        if (successCount > 0) {
                            ElementPlus.ElMessage.success(`成功标记 ${successCount} 个订单为已完成`);
                            this.loadDeliveryOrders();
                        }
                        
                        if (failCount > 0) {
                            ElementPlus.ElMessage.warning(`${failCount} 个订单标记失败`);
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('批量标记失败:', error);
                            ElementPlus.ElMessage.error('批量标记失败');
                        }
                    }
                },

                // 批量删除
                async batchDelete() {
                    try {
                        const eligibleOrders = this.selectedDeliveries.filter(order => [0, 3].includes(order.status));
                        if (eligibleOrders.length === 0) {
                            ElementPlus.ElMessage.warning('没有可删除的订单');
                            return;
                        }
                        
                        await ElementPlus.ElMessageBox.confirm(
                            `确定要删除选中的 ${eligibleOrders.length} 个订单吗？此操作不可恢复！`,
                            '批量操作',
                            {
                                confirmButtonText: '确定删除',
                                cancelButtonText: '取消',
                                type: 'warning'
                            }
                        );
                        
                        let successCount = 0;
                        let failCount = 0;
                        
                        for (const order of eligibleOrders) {
                            try {
                                const response = await axios.delete(`/delivery_orders/${order.id}`);
                                
                                if (response.status === 200) {
                                    successCount++;
                                } else {
                                    failCount++;
                                }
                            } catch (error) {
                                console.error(`删除订单 ${order.id} 失败:`, error);
                                failCount++;
                            }
                        }
                        
                        if (successCount > 0) {
                            ElementPlus.ElMessage.success(`成功删除 ${successCount} 个订单`);
                            this.loadDeliveryOrders();
                        }
                        
                        if (failCount > 0) {
                            ElementPlus.ElMessage.warning(`${failCount} 个订单删除失败`);
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('批量删除失败:', error);
                            ElementPlus.ElMessage.error('批量删除失败');
                        }
                    }
                },

                // 批量打印
                batchPrint() {
                    if (this.selectedDeliveries.length === 0) {
                        ElementPlus.ElMessage.warning('请先选择要打印的订单');
                        return;
                    }
                    
                    // 如果只选择了一个订单，直接打开打印预览
                    if (this.selectedDeliveries.length === 1) {
                        this.printDeliveryOrder(this.selectedDeliveries[0]);
                        return;
                    }
                    
                    // TODO: 实现批量打印功能
                    ElementPlus.ElMessage.info('批量打印功能正在开发中...');
                },

                // 处理商品单价变更
                async handlePriceChange(newPrice, currentIndex) {
                    const currentItem = this.placeOrderForm.items[currentIndex];
                    const sameNameItems = this.placeOrderForm.items.filter((item, index) => 
                        index !== currentIndex && item.name === currentItem.name
                    );
                    
                    if (sameNameItems.length > 0) {
                        try {
                            await ElementPlus.ElMessageBox.confirm(
                                `发现${sameNameItems.length}个相同商品"${currentItem.name}"，是否要一并修改它们的单价？`,
                                '修改单价',
                                {
                                    confirmButtonText: '是',
                                    cancelButtonText: '否',
                                    type: 'warning'
                                }
                            );
                            
                            // 用户点击"是"，更新所有相同商品的单价
                            this.placeOrderForm.items.forEach((item, index) => {
                                if (item.name === currentItem.name) {
                                    item.price = newPrice;
                                }
                            });
                            
                            ElementPlus.ElMessage.success('已更新所有相同商品的单价');
                        } catch (e) {
                                    // 用户点击"否"或关闭对话框，不做任何操作
                                    console.log('用户取消批量修改单价');
                                }
                            }
                        },

                // 打印发货单
                printDeliveryOrder(order) {
                    // 设置打印数据
                    this.printData = {
                        orderNumber: order.orderNumber,
                        customerName: order.customerName || order.user?.nickname || '未知客户',
                        customerPhone: order.customerPhone || order.user?.phone || '无',
                        deliveryAddress: order.deliveryAddress || '无',
                        deliveryDate: order.deliveryDate || order.createdAt,
                        items: order.items || [],
                        remark: order.remark || ''
                    };
                    
                    // 打开打印预览对话框
                    this.printPreviewVisible = true;
                },

                // 执行打印操作
                printDocument() {
                    this.$nextTick(() => {
                        const printContents = this.$refs.printContainer.innerHTML;
                        const originalContents = document.body.innerHTML;
                        
                        // 创建一个新窗口进行打印
                        const printWindow = window.open('', '_blank');
                        printWindow.document.open();
                        printWindow.document.write(`
                            <html>
                                <head>
                                    <title>发货单打印</title>
                                    <style>
                                        @media print {
                                            body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
                                            .print-header { text-align: center; margin-bottom: 20px; }
                                            .print-header h2 { margin: 0; padding: 0; }
                                            .print-order-number { margin-top: 5px; font-size: 14px; }
                                            .print-info { margin-bottom: 20px; }
                                            .print-info-item { margin-bottom: 8px; }
                                            .print-label { font-weight: bold; min-width: 60px; display: inline-block; }
                                            .print-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                                            .print-table th, .print-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                            .print-table th { background-color: #f2f2f2; }
                                            .print-footer { margin-top: 30px; }
                                            .print-remark { margin-bottom: 20px; }
                                            .print-signatures { display: flex; justify-content: space-between; margin-top: 50px; }
                                            .print-signature { width: 45%; }
                                            .signature-line { border-bottom: 1px solid #000; display: inline-block; width: 150px; }
                                        }
                                    </style>
                                </head>
                                <body>
                                    ${printContents}
                                </body>
                            </html>
                        `);
                        printWindow.document.close();
                        
                        // 等待内容加载完成后打印
                        printWindow.onload = function() {
                            printWindow.print();
                            printWindow.close();
                        };
                        
                        this.printPreviewVisible = false;
                    });
                },

                // 导出发货单数据
                exportDeliveryData() {
                    try {
                        // 根据当前过滤条件准备数据
                        const currentTab = this.deliveryTabs[this.currentDeliveryTab];
                        const statusText = this.getDeliveryStatusText(currentTab.status);
                        const fileName = `发货单数据_${statusText}_${new Date().toLocaleDateString()}.csv`;
                        
                        // 如果没有数据，提示用户
                        if (this.deliveryOrders.length === 0) {
                            ElementPlus.ElMessage.warning('没有可导出的数据');
                            return;
                        }
                        
                        // 准备CSV内容
                        const headers = ['发货单号', '客户名称', '联系电话', '收货地址', '商品数量', '状态', '创建时间'];
                        let csvContent = headers.join(',') + '\n';
                        
                        for (const order of this.deliveryOrders) {
                            const row = [
                                order.orderNumber,
                                `"${order.customerName || order.user?.nickname || '未知'}"`,
                                `"${order.customerPhone || order.user?.phone || '无'}"`,
                                `"${order.deliveryAddress || '无'}"`,
                                this.getOrderItemsCount(order),
                                this.getDeliveryStatusText(order.status),
                                formatDate(order.createdAt || order.created_at)
                            ];
                            csvContent += row.join(',') + '\n';
                        }
                        
                        // 创建并下载CSV文件
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.setAttribute('download', fileName);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        ElementPlus.ElMessage.success('数据导出成功');
                    } catch (error) {
                        console.error('导出数据失败:', error);
                        ElementPlus.ElMessage.error('导出数据失败');
                    }
                },

                // 处理发货单操作
                handleDeliveryAction(command, order) {
                    switch (command) {
                        case 'view':
                            this.viewDeliveryDetail(order);
                            break;
                        case 'start':
                            this.handleStartDelivery(order);
                            break;
                        case 'complete':
                            this.handleCompleteDelivery(order);
                            break;
                        case 'cancel':
                            this.handleCancelDelivery(order);
                            break;
                        case 'print':
                            this.printDeliveryOrder(order);
                            break;
                        case 'delete':
                            this.handleDeleteDelivery(order);
                            break;
                    }
                },

                // 处理发货单图片变更
                handleDeliveryImageChange(file, fileList) {
                    this.deliveryImageFiles = fileList;
                },

                // 移除发货单图片
                handleDeliveryImageRemove(file, fileList) {
                    this.deliveryImageFiles = fileList;
                },

                // 计算订单总数量
                calculateTotalQuantity() {
                    let total = 0;
                    if (this.deliveryForm.items && this.deliveryForm.items.length > 0) {
                        for (const item of this.deliveryForm.items) {
                            total += parseInt(item.quantity) || 0;
                        }
                    }
                    return total;
                },

                // 显示创建发货单对话框
                showCreateDeliveryDialog() {
                    this.deliveryForm = {
                        customerName: '',
                        customerPhone: '',
                        deliveryAddress: '',
                        deliveryDate: new Date().toISOString().split('T')[0],
                        remark: '',
                        packages: [{
                            items: []
                        }]
                    };
                    this.deliveryImageFiles = [];
                    this.createDeliveryVisible = true;
                },
                
                // 添加包裹
                addPackage() {
                    // 初始化 deliveryForm 如果不存在
                    if (!this.deliveryForm) {
                        this.deliveryForm = {
                            customerName: '',
                            customerPhone: '',
                            deliveryAddress: '',
                            deliveryDate: new Date().toISOString().split('T')[0],
                            remark: '',
                            packages: []
                        };
                    }
                    
                    // 初始化 packages 数组如果不存在
                    if (!this.deliveryForm.packages) {
                        this.deliveryForm.packages = [];
                    }
                    
                    // 创建新包裹并添加到数组中
                    const newPackage = {
                        items: []
                    };
                    this.deliveryForm.packages.push(newPackage);
                    
                    // 显示成功消息
                    ElementPlus.ElMessage.success('新包裹已添加');
                },
                
                // 删除包裹
                deletePackage(index) {
                    if (this.deliveryForm.packages.length <= 1) {
                        ElementPlus.ElMessage.warning('至少保留一个包裹');
                        return;
                    }
                    
                    ElementPlus.ElMessageBox.confirm('确定要删除此包裹吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        this.deliveryForm.packages.splice(index, 1);
                    }).catch(() => {});
                },
                
                // 从包裹中移除商品
                removeItem(packageIndex, itemIndex) {
                    this.deliveryForm.packages[packageIndex].items.splice(itemIndex, 1);
                },
                
                // 打开添加商品弹窗
                showAddProductPopup(packageIndex) {   
                    
                    // 更新当前包裹索引
                    this.currentPackageIndex = packageIndex;
                    
                    // 打开弹窗
                    this.addProductPopupVisible = true;
                    
                    // 加载可选商品
                    this.loadAvailableProducts();
                    
                },
                
                // 隐藏添加商品弹窗
                hideAddProductPopup() {
                    this.addProductPopupVisible = false;
                },
                
                // 加载可选商品
                async loadAvailableProducts() {
                    try {
                        // 获取当前包裹
                        const currentPackage = this.deliveryForm.packages[this.currentPackageIndex];
                        if (!currentPackage) {
                            this.availableProducts = [];
                            return;
                        }

                        // 创建一个Map来跟踪每个商品ID和颜色组合已分配的数量
                        const allocatedQuantities = new Map();
                        
                        // 遍历所有包裹，统计已分配的商品数量
                        this.deliveryForm.packages.forEach(pkg => {
                            pkg.items.forEach(item => {
                                const key = `${item.product_id}-${item.color}`;
                                allocatedQuantities.set(
                                    key, 
                                    (allocatedQuantities.get(key) || 0) + item.quantity
                                );
                            });
                        });

                        // 从订单中筛选出可选商品
                        const available = [];
                        
                        this.selectedOrder.items.forEach(orderItem => {
                            if (orderItem.specs && orderItem.specs.length > 0) {
                                // 处理有规格的商品
                                orderItem.specs.forEach(spec => {
                                    const key = `${orderItem.product_id}-${spec.color}`;
                                    const allocatedQty = allocatedQuantities.get(key) || 0;
                                    const pendingQuantity = spec.quantity - (spec.shipped_quantity || 0) - allocatedQty;
                                    
                                    if (pendingQuantity > 0) {
                                        available.push({
                                            product_id: orderItem.product_id,
                                            product_name: orderItem.product_name,
                                            color: spec.color,
                                            max_quantity: pendingQuantity,
                                            quantity: pendingQuantity,  // 添加quantity字段
                                            price: spec.price,
                                            packaging_price: spec.packaging_price || orderItem.packaging_price || 0,
                                            logo_price: spec.logo_price || orderItem.logo_price || 0,
                                            accessory_price: spec.accessory_price || orderItem.accessory_price || 0
                                        });
                                    }
                                });
                            } else {
                                // 处理没有规格的商品
                                const key = `${orderItem.product_id}-`;
                                const allocatedQty = allocatedQuantities.get(key) || 0;
                                const pendingQuantity = orderItem.quantity - (orderItem.shipped_quantity || 0) - allocatedQty;
                                
                                if (pendingQuantity > 0) {
                                    available.push({
                                        product_id: orderItem.product_id,
                                        product_name: orderItem.product_name,
                                        color: '',
                                        max_quantity: pendingQuantity,
                                        quantity: pendingQuantity,  // 添加quantity字段
                                        price: orderItem.price,
                                        packaging_price: orderItem.packaging_price || 0,
                                        logo_price: orderItem.logo_price || 0,
                                        accessory_price: orderItem.accessory_price || 0
                                    });
                                }
                            }
                        });

                        this.availableProducts = available;
                        
                    } catch (error) {
                        console.error('加载可选商品失败:', error);
                        ElementPlus.ElMessage.error('加载商品失败');
                        this.availableProducts = [];
                    }
                },
                
                // 添加所有可选商品
                addAllProducts() {
                    if (this.currentPackageIndex >= 0 && this.currentPackageIndex < this.deliveryForm.packages.length) {
                        const currentPackage = this.deliveryForm.packages[this.currentPackageIndex];
                        
                        this.availableProducts.forEach(product => {
                            currentPackage.items.push({
                                ...product,
                                quantity: product.max_quantity,
                                packaging_price: product.packaging_price || 0,
                                logo_price: product.logo_price || 0,
                                accessory_price: product.accessory_price || 0
                            });
                        });
                        
                        this.addProductPopupVisible = false;
                    }
                },
                
                // 确认添加选中的商品
                confirmAddProducts() {
                    if (this.currentPackageIndex >= 0 && this.currentPackageIndex < this.deliveryForm.packages.length) {
                        const currentPackage = this.deliveryForm.packages[this.currentPackageIndex];
                        
                        if (!this.selectedProducts || this.selectedProducts.length === 0) {
                            ElementPlus.ElMessage.warning('请选择要添加的商品');
                            return;
                        }
                        
                        this.selectedProducts.forEach(product => {
                            currentPackage.items.push({
                                product_id: product.product_id,
                                product_name: product.product_name,
                                color: product.color || '',
                                quantity: product.max_quantity,
                                max_quantity: product.max_quantity,
                                price: product.price,
                                packaging_price: product.packaging_price || 0,
                                logo_price: product.logo_price || 0,
                                accessory_price: product.accessory_price || 0
                            });
                        });
                        
                        this.addProductPopupVisible = false;
                        this.selectedProducts = []; // 清空选择
                        ElementPlus.ElMessage.success('商品添加成功');
                    }
                },
                
                getDeliveryStatusTextWithPartial(order) {
                    const status = this.currentDeliveryTab;
                    if (status === 0 || status === null) {
                        // 如果是待发货状态，检查是否部分发货
                        if (order.total_shipped_quantity > 0 && order.total_shipped_quantity < order.total_quantity) {
                            return '已部分发货';
                        }
                        return '待发货';
                    } else if (status === 1) {
                        return '已发货';
                    } else if (status === 2) {
                        return '已完成';
                    } else if (status === 3) {
                        return '已取消';
                    } else {
                        return '未知状态';
                    }
                },
                hideAddProductPopup() {
                    this.addProductPopupVisible = false;
                },
                // 处理选择订单
                handleOrderSelect(order) {
                    this.selectedOrder = order;
                    // 重置包裹列表
                    this.deliveryForm.packages = [];
                    // 创建第一个包裹
                    this.deliveryForm.packages.push({
                        items: []
                    });
                    // 关闭订单选择弹窗
                    this.purchaseListVisible = false;
                },
                handleDelivery(order) {
                    // 处理发货的逻辑
                    console.log('发货:', order);
                },
                cancelDelivery(order) {
                    // 处理取消发货的逻辑
                    console.log('取消发货:', order);
                },
                completeDelivery(order) {
                    // 处理完成发货的逻辑
                    console.log('完成发货:', order);
                },
                printDelivery(order) {
                    // 处理打印发货单的逻辑
                    console.log('打印发货单:', order);
                },
                
                // 显示代客下单对话框
                showPlaceOrderDialog() {
                    this.placeOrderForm = {
                        userId: null,
                        remark: '',
                        items: []
                    };
                    this.placeOrderDialogVisible = true;
                },
                
                // 搜索用户
                async searchUsers(query) {
                    if (query.length < 1) {
                        this.userSearchResults = [];
                        return;
                    }
                    
                    try {
                        this.userSearchLoading = true;
                        const response = await axios.get('/users/search', {
                            params: {
                                keyword: query
                            }
                        });
                        
                        if (response.status === 200) {
                            this.userSearchResults = response.data.users;
                        }
                    } catch (error) {
                        console.error('搜索用户失败:', error);
                        ElementPlus.ElMessage.error('搜索用户失败');
                    } finally {
                        this.userSearchLoading = false;
                    }
                },
                
                // 显示商品选择器
                showProductSelector() {
                    //如果没有选择用户，则提示用户选择用户
                    if (!this.placeOrderForm.userId) {
                        ElementPlus.ElMessage.warning('请先选择客户');
                        return;
                    }
                    

                    this.productSelectorVisible = true;
                },
                
                // 添加商品到代客下单表单
                addPlaceOrderItem(product) {
                    // 检查是否已存在相同商品
                    const existingItem = this.placeOrderForm.items.find(item => 
                        item.name === product.name && 
                        item.color === product.color && 
                        item.packaging === product.packaging && 
                        item.logo === product.logo
                    );
                    
                    if (existingItem) {
                        // 如果存在相同商品，更新数量
                        existingItem.quantity += product.quantity;
                    } else {
                        // 如果不存在，添加新商品
                        this.placeOrderForm.items.push({
                            product_id: product.id,
                            name: product.name,
                            color: product.color,
                            quantity: parseInt(product.quantity),
                            price: parseFloat(product.price),
                            packaging_price: parseFloat(product.packaging_price),
                            logo_price: parseFloat(product.logo_price),
                            packaging: product.packaging,
                            logo: product.logo
                        });
                        console.log('placeOrderForm.items',this.placeOrderForm.items)
                    }
                },
                
                // 从代客下单表单中移除商品
                removePlaceOrderItem(index) {
                    this.placeOrderForm.items.splice(index, 1);
                },

                // 处理用户选择
                handleUserSelect(userId) {
                    const user_type  = this.userSearchResults.find(user => user.id === userId).user_type
                    this.placeOrderForm.userType = user_type
                    console.log(user_type);
                    if (user_type === 2) {
                        this.selectedUserType = 'A类客户';
                    } else if (user_type === 3) {
                        this.selectedUserType = 'B类客户';
                    } else if (user_type === 4) {
                        this.selectedUserType = 'C类客户';
                    } else {
                        this.selectedUserType = '零售客户';
                    }
                },
                
                // 提交代客下单
                async submitPlaceOrder() {
                    if (!this.placeOrderForm.userId) {
                        ElementPlus.ElMessage.warning('请选择客户');
                        return;
                    }
                    
                    if (this.placeOrderForm.items.length === 0) {
                        ElementPlus.ElMessage.warning('请添加至少一个商品');
                        return;
                    }
                    
                    try {
                        const response = await axios.post('/purchase_orders', {
                            user_id: this.placeOrderForm.userId,
                            remark: this.placeOrderForm.remark,
                            items: this.placeOrderForm.items,
                            status: 1
                        });
                        console.log(response);
                        if (response.status === 200 || response.status === 201) {
                            ElementPlus.ElMessage.success('代客下单成功');
                            this.placeOrderDialogVisible = false;  // 关闭窗口
                            this.placeOrderForm = {  // 重置表单
                                userId: null,
                                remark: '',
                                items: []
                            };
                            this.loadPurchaseOrders();  // 刷新采购单列表
                        } else {
                            throw new Error(response.data.error || '提交失败');
                        }
                    } catch (error) {
                        console.error('代客下单失败:', error);
                        ElementPlus.ElMessage.error(error.response?.data?.error || error.message || '代客下单失败，请重试');
                    }
                },
                async handleSavePurchaseEdit(order) {
                    try {
                        // 转换数据格式以适配接口
                        const items = order.items.flatMap(item => 
                            item.specs.map(spec => ({
                                product_id: item.product_id,
                                quantity: spec.quantity,
                                color: spec.color,
                                price: item.price || 0,
                                logo_price: item.logo_price || 0,
                                accessory_price: item.accessory_price || 0,
                                packaging_price: item.packaging_price || 0
                            }))
                        );

                        const response = await axios.put(`/purchase_orders/${order.id}/items`, {
                            items: items
                        });

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('采购单更新成功');
                            // 重新加载采购单列表
                            await this.loadPurchaseOrders();
                            return Promise.resolve();
                        } else {
                            return Promise.reject(new Error('保存失败'));
                        }
                    } catch (error) {
                        console.error('保存采购单失败:', error);
                        ElementPlus.ElMessage.error(error.response?.data?.error || '保存失败');
                        return Promise.reject(error);
                    }
                },
                handlePurchasePageChange(page) {
                    this.purchasePagination.currentPage = page;
                    this.loadPurchaseOrders();
                },
            }
        })
        
        // 注册所有图标组件
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component)
        }

        // 使用 Element Plus
        app.use(ElementPlus, {
            size: 'default',
            zIndex: 3000,
            locale: ElementPlusLocaleZhCn
        })

        // 注册商品选择器组件
        app.component('product-selector', window.ProductSelector);
        // 注册采购单详情组件
        app.component('purchase-order-detail', window.PurchaseOrderDetail);

        app.mount('#app')
    </script>
</body>
</html>