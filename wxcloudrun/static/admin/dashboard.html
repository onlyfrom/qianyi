<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仟艺服饰管理后台</title>
    <link rel="icon" type="image/x-icon" href="https://7072-prod-9gd4jllic76d4842-1348936510.tcb.qcloud.la/system/logo.png?sign=013420464d5c9d73dd11b8a00bbcc674&t=1742838676">
    <!-- 引入 Element Plus 相关文件 -->
    <link rel="stylesheet" href="//unpkg.com/element-plus/dist/index.css" />
    <script src="//unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="//unpkg.com/element-plus"></script>
    <script src="//unpkg.com/@element-plus/icons-vue"></script>
    <script src="//unpkg.com/axios/dist/axios.min.js"></script>
    <script src="//unpkg.com/sortablejs/Sortable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
        }

        #app {
            height: 100%;
        }

        .layout-container {
            height: 100%;
        }

        .el-header {
            background-color: #545c64;
            color: #fff;
            line-height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .el-aside {
            background-color: #545c64;
            color: #fff;
            height: 100%;
        }

        .color-stock-form-item {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
        }

        .color-stock-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border: 1px solid #ebeef5;
            border-radius: 4px;
            width: calc(33.33% - 10px);
            width: 250px;
            background-color: #fff;
        }

        .color-tag {
            width: 80px;
            text-align: center;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .stock-input {
            flex: 1;
            min-width: 100px;
        }

        /* 确保图片预览显示在最上层 */
        .el-image-viewer__wrapper {
            z-index: 2100 !important;
        }

        .el-image-viewer__mask {
            z-index: 2099 !important;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .left-tools {
            display: flex;
            gap: 10px;
        }

        .excel-uploader {
            display: inline-block;
        }

        /* 自定义分页文本 */
        .el-pagination {
            --el-pagination-total-text: "总计";
        }

        /* 自定义每页显示数量的下拉框文本 */
        .custom-page-sizes .el-select-dropdown__item {
            &::before {
                content: "每页 ";
            }

            &::after {
                content: " 条";
            }
        }

        .statistics-container {
            padding: 20px;
        }

        .filter-bar {
            margin-bottom: 20px;
        }

        .summary-cards {
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-value {
            font-size: 24px;
            font-weight: bold;
            color: #409EFF;
            text-align: center;
        }

        .rank-lists .el-card {
            margin-bottom: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .el-dropdown-link {
            display: flex;
            align-items: center;
            color: #fff;
            cursor: pointer;
        }

        .el-dropdown-link:hover {
            opacity: 0.8;
        }

        .search-bar {
            flex: 1;
            max-width: 600px;
        }


        /* ... 其他样式保持不变 ... */
        .status-tabs {
            margin-bottom: 20px;
        }
        
        .count-tag {
            margin-left: 5px;
            transform: scale(0.8);
        }
        
        .el-radio-button__inner {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .filter-container {
            display: flex;
            width: 100rpx            ;
        }

        .my-select-dropdown {
            width: auto !important;
            min-width: 200px !important;
        }

        .my-select-dropdown .el-select-dropdown__item {
            width: 100%;
            min-width: 200px;
        }

        .el-select {
            display: block;
        }

        .el-select .el-input {
            width: 100%;
        }

        .el-select-dropdown {
            width: auto !important;
        }
        
        /* 自定义图片预览样式 */
        :root {
            --el-image-viewer-mask-color: rgba(0, 0, 0, 0.9);
        }

        .el-image-viewer__wrapper {
            position: fixed;
            z-index: 2050 !important;
        }

        .el-image-viewer__btn {
            opacity: 0.8;
            color: #fff;
            font-size: 24px;
        }

        .el-image-viewer__close {
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            font-size: 24px;
        }

        .el-image-viewer__canvas {
            user-select: none;
        }

        .el-image-viewer__actions {
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
        }

        .el-image-viewer__actions__inner {
            gap: 15px;
        }

        .el-image {
            .el-image__inner {
                transition: all 0.3s;
            }
            
            &:hover .el-image__inner {
                transform: scale(1.05);
            }
        }

        /* 调整图片预览组件的层级关系 */
        .el-image-viewer__wrapper {
            position: fixed !important;
            z-index: 2999 !important;
        }

        .el-image-viewer__mask {
            position: fixed !important;
            z-index: 2998 !important;
            background-color: rgba(0, 0, 0, 0.9);
        }

        .el-image-viewer__btn {
            z-index: 3000 !important;
        }

        .el-image-viewer__close {
            z-index: 3000 !important;
        }

        .el-image-viewer__canvas {
            z-index: 2999 !important;
        }

        .el-image-viewer__actions {
            z-index: 3000 !important;
        }

        /* 图片预览器内的操作按钮样式 */
        .el-image-viewer__actions__inner i {
            color: #fff !important;
            font-size: 18px !important;
            margin: 0 10px !important;
            cursor: pointer !important;
        }

        /* 预览图片容器样式 */
        .el-image-viewer__img {
            background-color: transparent !important;
            max-width: 90vw !important;
            max-height: 90vh !important;
            user-select: none !important;
        }

        /* 缩略图样式 */
        .el-image {
            border-radius: 4px;
            overflow: hidden;
            
            .el-image__inner {
                transition: all 0.3s;
            }
            
            &:hover .el-image__inner {
                transform: scale(1.05);
            }
        }

        /* 占位符和错误状态样式 */
        .image-placeholder,
        .image-error {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #f5f7fa;
            color: #909399;
            font-size: 12px;
        }

        .image-error {
            .el-icon {
                font-size: 20px;
                margin-bottom: 8px;
            }
        }

        /* 重新调整图片预览组件的层级和样式 */
        :root {
            --el-image-viewer-mask-color: rgba(0, 0, 0, 0.85);
        }

        .el-image-viewer__wrapper {
            position: fixed !important;
            z-index: 2100 !important;
        }

        .el-image-viewer__mask {
            position: fixed !important;
            z-index: 2000 !important;
            backdrop-filter: blur(2px);
        }

        .el-image-viewer__img {
            z-index: 2200 !important;
            position: relative !important;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
        }

        .el-image-viewer__prev,
        .el-image-viewer__next,
        .el-image-viewer__close {
            z-index: 2300 !important;
            background-color: rgba(0, 0, 0, 0.3) !important;
            border-radius: 50%;
            width: 44px !important;
            height: 44px !important;
            line-height: 44px !important;
            
            &:hover {
                background-color: rgba(0, 0, 0, 0.5) !important;
            }
        }

        .el-image-viewer__actions {
            z-index: 2300 !important;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 8px 20px;
            
            .el-image-viewer__actions__inner {
                gap: 20px;
                
                i {
                    font-size: 20px;
                    transition: all 0.3s;
                    
                    &:hover {
                        transform: scale(1.2);
                        color: #fff;
                    }
                }
            }
        }

        .el-image-viewer__canvas {
            z-index: 2200 !important;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        /* 优化图片加载和错误状态的显示 */
        .image-placeholder,
        .image-error {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #f5f7fa;
            border-radius: 4px;
            
            .el-icon {
                font-size: 20px;
                margin-bottom: 8px;
                color: #909399;
            }
        }

        .filter-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 4px;
        }

        .filter-option-item {
            padding: 6px 12px;
            border: 1px solid #DCDFE6;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: #fff;
            font-size: 13px;
            color: #606266;
        }

        .filter-option-item:hover {
            border-color: #409EFF;
            color: #409EFF;
        }

        .filter-option-item.is-active {
            background: #409EFF;
            border-color: #409EFF;
            color: #fff;
        }

        .dialog-footer {
            padding-top: 20px;
            text-align: right;
        }

        .el-select {
            width: 100%;
        }

        .el-dialog {
            border-radius: 8px;
        }

        .el-dialog__header {
            margin-right: 0;
            padding: 20px;
            border-bottom: 1px solid #dcdfe6;
        }

        .el-dialog__body {
            padding: 20px;
        }

        .el-dialog__footer {
            padding: 10px 20px 20px;
            border-top: 1px solid #dcdfe6;
        }
        .batch-style-dialog {
            width: 400px;
            height: 400px;
        }

        /* 添加新样式 */
        .color-images-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .color-image-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #EBEEF5;
            border-radius: 4px;
        }

        .selected-images {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .image-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            padding: 10px;
        }

        .image-select-item {
            width: 100px;
            height: 100px;
            border: 2px solid transparent;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-select-item:hover {
            transform: scale(1.05);
        }

        .image-select-item.selected {
            border-color: #409EFF;
        }

        .color-image-preview {
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .color-image-preview:hover {
            opacity: 0.8;
        }

        .image-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            padding: 10px;
        }

        .image-select-item {
            width: 100px;
            height: 100px;
            border: 2px solid transparent;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-select-item:hover {
            transform: scale(1.05);
        }

        .image-select-item.selected {
            border-color: #409EFF;
        }

        /* 添加图片选择相关样式 */
        .image-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .image-select-item {
            width: 100px;
            height: 100px;
            border: 2px solid transparent;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-select-item:hover {
            transform: scale(1.05);
        }

        .image-select-item.selected {
            border-color: #409EFF;
        }

        .color-image-preview {
            margin-left: 10px;
            cursor: pointer;
        }

        .color-image-preview:hover {
            opacity: 0.8;
        }

        /* 添加行内编辑样式 */
        .editable-cell {
            padding: 2px 0;
        }

        .editable-cell .el-input.is-small .el-input__wrapper {
            padding: 1px 5px;
        }

        .editable-cell .el-input-number.is-small {
            width: 50px;
        }

        .el-table .cell {
            padding: 5px;
        }

        /* 添加到已有的 style 标签中 */
        .spec-form-container {
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 16px;
            display: flex;
            flex-direction: row;
            gap: 12px;
        }

        .spec-form-title {
            font-size: 14px;
            color: #606266;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .spec-form-title::before {
            content: '';
            width: 3px;
            height: 14px;
            background-color: #409EFF;
            margin-right: 8px;
            border-radius: 2px;
        }

        .spec-form-row {
            display: flex;
            width: 200rpx;
            gap: 16px;
            margin-bottom: 12px;
        }

        .spec-form-item {
            display: flex;
            flex-direction: row;
            width: 200rpx;
            gap: 12px;
        }

        .spec-form-item .el-form-item__label {
            font-size: 13px;
            color: #606266;
            margin-bottom: 4px;
        }

        .recommended-products-container {
            padding: 10px;
        }

        .recommended-list {
            margin-top: 20px;
        }

        .recommended-list h4,
        .search-results h4 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #409EFF;
            padding-left: 10px;
            border-left: 3px solid #409EFF;
        }

        .search-results {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px dashed #EBEEF5;
        }

        /* 修改分页组件 */
        .pagination-container {
            margin-top: 20px;
            text-align: right;
        }

        .pagination-dropdown .el-select-dropdown__item {
            display: flex;
        }

        .pagination-dropdown .el-select-dropdown__item::before {
            content: "每页 ";
        }

        .pagination-dropdown .el-select-dropdown__item::after {
            content: " 条";
        }

    </style>
</head>

<body>
    <div id="app">
        <el-container class="layout-container">
            <el-header>
                <div class="header-title">杭州仟艺服饰后台管理系统</div>
                <div class="user-info">
                    <el-dropdown @command="handleCommand">
                        <span class="el-dropdown-link">
                            <el-avatar :size="32" :src="getUserInfo().avatar"></el-avatar>
                            <span style="margin-left: 8px">{{ getUserInfo().nickname || getUserInfo().username }}</span>
                            <el-icon class="el-icon--right"><arrow-down /></el-icon>
                        </span>
                        <template #dropdown>
                            <el-dropdown-menu>
                                <el-dropdown-item command="profile">个人信息</el-dropdown-item>
                                <el-dropdown-item command="logout">退出登录</el-dropdown-item>
                            </el-dropdown-menu>
                        </template>
                    </el-dropdown>
                </div>
            </el-header>

            <el-container>
                <el-aside width="200px">
                    <el-menu default-active="1" background-color="#545c64" text-color="#fff" active-text-color="#ffd04b"
                        @select="handleSelect">

                        <el-menu-item index="1">
                            <el-icon>
                                <Document />
                            </el-icon>
                            <span>商品管理</span>
                        </el-menu-item>

                        <el-menu-item index="2">
                            <el-icon><User /></el-icon>
                            <span>用户管理</span>
                        </el-menu-item>

                        <el-menu-item index="3">
                            <el-icon><List /></el-icon>
                            <span>采购单管理</span>
                        </el-menu-item>

                        <el-menu-item index="4">
                            <el-icon>
                                <List />
                            </el-icon>
                            <span>配送单管理</span>
                        </el-menu-item>
                        <el-menu-item index="7">
                            <el-icon><share /></el-icon>
                            <span>推送单管理</span>
                        </el-menu-item>
                        <el-menu-item index="5">
                            <el-icon>
                                <Setting />
                            </el-icon>
                            <span>系统设置</span>
                        </el-menu-item>

                        <el-menu-item index="6">
                            <el-icon><Histogram /></el-icon>
                            <span>数据统计</span>
                        </el-menu-item>

                        
                    </el-menu>
                </el-aside>

                <el-main>
                    <div class="content-container">
                        <!-- 商品管理内容 -->
                        
                        <div v-if="currentPage === '1'">
                             <!-- 批量修改款式对话框 -->
                            <!-- 批量修改款式对话框 -->
                            <el-dialog title="批量修改款式" v-model="batchStyleDialogVisible" width="400px">
                                <el-form :model="batchStyleForm" label-width="80px">
                                    <el-form-item label="款式">
                                        <el-select v-model="batchStyleForm.type" placeholder="请选择款式">
                                            <el-option
                                                v-for="item in styleOptions"
                                                :key="item.id"
                                                :label="item.name"
                                                :value="item.id">
                                            </el-option>
                                        </el-select>
                                    </el-form-item>
                                </el-form>
                                <template #footer>
                                    <span class="dialog-footer">
                                        <el-button @click="batchStyleDialogVisible = false">取消</el-button>
                                        <el-button type="primary" @click="handleBatchStyleUpdate">确定</el-button>
                                    </span>
                                </template>
                            </el-dialog>
                            
                            <div class="toolbar">
                                <div class="left-tools">
                                    <el-button type="primary" @click="showAddProductDialog">添加商品</el-button>
                                    <el-button type="primary" @click="toggleEditMode">
                                        {{ isEditMode ? '退出编辑' : '开启编辑' }}
                                    </el-button>
                                    <el-dropdown @command="handleBatchCommand" :disabled="!selectedProducts.length">
                                        <el-button type="primary">
                                            批量操作 <el-icon class="el-icon--right"><arrow-down /></el-icon>
                                            <span v-if="selectedProducts.length">({{selectedProducts.length}})</span>
                                        </el-button>
                                        <template #dropdown>
                                            <el-dropdown-menu>
                                                <el-dropdown-item command="delete">批量删除</el-dropdown-item>
                                                <el-dropdown-item command="style">批量修改款式</el-dropdown-item>
                                                <el-dropdown-item command="status">批量修改状态</el-dropdown-item>
                                                <el-dropdown-item command="public">批量修改公开状态</el-dropdown-item>
                                            </el-dropdown-menu>
                                        </template>
                                    </el-dropdown>
                                </div>
                                
                                <div class="search-bar">
                                    <el-input
                                        v-model="productSearch.keyword"
                                        placeholder="搜索商品名称/款号"
                                        clearable
                                        @clear="handleProductSearch"
                                        @keyup.enter="handleProductSearch"
                                    >
                                        <template #append>
                                            <el-button @click="handleProductSearch">搜索</el-button>
                                        </template>
                                    </el-input>
                                </div>
                                
                                
                                </el-switch>
                                <!-- 筛选区域 -->
                                <el-upload class="excel-uploader" action="/products/import" :headers="uploadHeaders"
                                    :on-success="handleImportSuccess" :on-error="handleImportError"
                                    :before-upload="beforeImportUpload" accept=".xlsx,.xls" :show-file-list="false">
                                    <el-button type="success">Excel导入</el-button>
                                </el-upload>
                                <el-button type="info" @click="downloadTemplate">下载模板</el-button>
                                <el-switch v-model="selectedFilters.status"
                                :active-value="1"
                                :inactive-value="0"
                                :active-text="selectedFilters.status === 1 ? '在售' : '下架'"
                                @change="handleStatusFilterChange"
                                >
                            </div>
                            <!-- 商品列表 -->
                            <el-table 
                                :data="products" 
                                style="width: 100%;" 
                                v-loading="productLoading"
                                ref="productTable"
                                max-height="calc(100vh - 200px)"
                                @selection-change="handleSelectionChange"
                                @sort-change="handleSortChange">
                                <el-table-column type="selection" width="55"></el-table-column>
                                <!-- 货号 -->
                                <el-table-column prop="id" label="货号" width="80" sortable="custom"></el-table-column>
                                <el-table-column label="图片"  width="65">
                                    <template #default="scope">
                                        <el-image 
                                            v-if="scope.row.images && scope.row.images.length > 0"
                                            style="width: 50px; height: 50px; cursor: pointer; border-radius: 4px; overflow: hidden;" 
                                            :src="handleImageUrl(scope.row.images[0])"
                                            :preview-src-list="scope.row.images.map(img => handleImageUrl(img))"
                                            :initial-index="0"
                                            :zoom-rate="1.2"
                                            :preview-teleported="true"
                                            :close-on-press-escape="true"
                                            :infinite="true"
                                            fit="cover"
                                            @load="onImageLoad">
                                            <template #placeholder>
                                                <div class="image-placeholder">
                                                    <el-icon><Picture /></el-icon>
                                                </div>
                                            </template>
                                            <template #error>
                                                <div class="image-error">
                                                    <el-icon><Picture /></el-icon>
                                                    <span>加载失败</span>
                                                </div>
                                            </template>
                                        </el-image>
                                    </template>
                                </el-table-column>
                                
                                <el-table-column prop="is_public" label="是否公开" width="80">
                                    <template #header>
                                        <el-popover placement="bottom" :width="120" trigger="click" v-model:visible="filterVisible.is_public">
                                            <template #reference>
                                                <span :style="{ color: selectedFilters.is_public !== null ? '#inherit' : 'inherit' }" style="cursor: pointer">
                                                    {{ selectedFilters.is_public === 1 ? '公开' : selectedFilters.is_public === 0 ? '私密' : '全部' }}
                                                    <el-icon v-if="selectedFilters.is_public !== null"></el-icon>
                                                </span>
                                            </template>
                                            <div class="filter-options">
                                                <div class="filter-option-item"
                                                    :class="{ 'is-active': selectedFilters.is_public === 1 }"
                                                    @click="selectedFilters.is_public = null">
                                                    全部
                                                </div>
                                                <div class="filter-option-item"
                                                    :class="{ 'is-active': selectedFilters.is_public === 1 }"
                                                    @click="selectedFilters.is_public = 1">
                                                    公开
                                                </div>
                                                <div class="filter-option-item"
                                                    :class="{ 'is-active': selectedFilters.is_public === 0 }"
                                                    @click="selectedFilters.is_public = 0">
                                                    私密
                                                </div>
                                            </div>
                                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #EBEEF5; text-align: right">
                                                <el-button size="small" @click="resetSpecificFilter('is_public')">重置</el-button>
                                                <el-button size="small" type="primary" @click="handleProductSearch">确定</el-button>
                                            </div>
                                        </el-popover>
                                    </template>
                                    <template #default="scope">
                                        <el-tag :type="scope.row.is_public === 1 ? 'info' : 'success'" @click="handleStatusChange(scope.row, 'is_public')">
                                            {{ scope.row.is_public === 1 ? '公开' : '私密' }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="name" label="商品名称" width="200" sortable @sort-change="handleSortChange"></el-table-column>
                                <el-table-column prop="price_b" label="价格" width="80" v-if="userInfo.user_type === 1">
                                    <template #default="scope">
                                        {{ scope.row.price_b === 0 ? '讯价' : '¥' + scope.row.price_b }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="款式" width="80" prop="type" >
                                    <template #header>
                                        <el-popover placement="bottom" :width="120" trigger="click" v-model:visible="filterVisible.type">
                                            <template #reference>
                                                <span :style="{ color: selectedFilters.type !== null ? '#ADD8E6' : 'inherit' }" style="cursor: pointer">
                                                    款式
                                                    <el-icon v-if="selectedFilters.type !== null"></el-icon>
                                                </span>
                                            </template>
                                            <div class="filter-options">
                                                <div v-for="item in styleOptions" 
                                                    :key="item.id" 
                                                    class="filter-option-item"
                                                    :class="{ 'is-active': selectedFilters.type === item.id }"
                                                    @click="selectedFilters.type = item.id">
                                                    {{ item.name }}
                                                </div>
                                            </div>
                                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #EBEEF5; text-align: right">
                                                <el-button size="small" @click="resetSpecificFilter('type')">重置</el-button>
                                                <el-button size="small" type="primary" @click="handleProductSearch">确定</el-button>
                                            </div>
                                        </el-popover>
                                    </template>
                                    <template #default="scope">
                                        <span>{{ styleOptions.find(item => item.id === scope.row.type)?.name || '未知' }}</span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="尺寸" prop="size" width="80">
                                    <template #header>
                                        <el-popover placement="bottom" :width="200" trigger="click" v-model:visible="filterVisible.size">
                                            <template #reference>
                                                <span :style="{ color: selectedFilters.size !== null ? '#ADD8E6' : 'inherit' }" style="cursor: pointer">
                                                    尺寸(cm)
                                                    <el-icon v-if="selectedFilters.size !== null" class="el-icon--right"></el-icon>
                                                </span>
                                            </template>
                                            <div class="filter-options">
                                                <div v-for="item in filterOptions.sizes" 
                                                    :key="item.value" 
                                                    class="filter-option-item"
                                                    :class="{ 'is-active': selectedFilters.size === item.value }"
                                                    @click="selectedFilters.size = item.value">
                                                    {{ item.text }}
                                                </div>
                                            </div>
                                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #EBEEF5; text-align: right">
                                                <el-button size="small" @click="resetSpecificFilter('size')">重置</el-button>
                                                <el-button size="small" type="primary" @click="handleProductSearch">确定</el-button>
                                            </div>
                                        </el-popover>
                                    </template>
                                    <template #default="{ row }">
                                        <div v-if="isEditMode" class="editable-cell">
                                            <el-input
                                                v-model="row.size"
                                                size="small"
                                                @keyup.enter="handleSpecsSave(row)"
                                                placeholder="输入尺寸">
                                            </el-input>
                                        </div>
                                        <span v-else>{{ row.size || '-' }}</span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="克重" prop="weight" :width="isEditMode ? '135px' : '80px'">
                                    <template #header>
                                        <el-popover placement="bottom" :width="200" trigger="click" v-model:visible="filterVisible.weight">
                                            <template #reference>
                                                <span :style="{ color: selectedFilters.weight !== null ? '#ADD8E6' : 'inherit' }" style="cursor: pointer">
                                                    克重(g)
                                                    <el-icon v-if="selectedFilters.weight !== null" class="el-icon--right"></el-icon>
                                                </span>
                                            </template>
                                            <div class="filter-options">
                                                <div v-for="item in filterOptions.weights" 
                                                    :key="item.value" 
                                                    class="filter-option-item"
                                                    :class="{ 'is-active': selectedFilters.weight === item.value }"
                                                    @click="selectedFilters.weight = item.value">
                                                    {{ item.text }}
                                                </div>
                                            </div>
                                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #EBEEF5; text-align: right">
                                                <el-button size="small" @click="resetSpecificFilter('weight')">重置</el-button>
                                                <el-button size="small" type="primary" @click="handleProductSearch">确定</el-button>
                                            </div>
                                        </el-popover>
                                    </template>
                                    <template #default="{ row }">
                                        <div v-if="isEditMode" class="editable-cell">
                                            <el-input-number
                                                v-model="row.weight"
                                                size="small"
                                                :min="0"
                                                :step="1"
                                                @keyup.enter="handleSpecsSave(row)"
                                                placeholder="输入克重">
                                            </el-input-number>
                                        </div>
                                        <span v-else>{{ row.weight || '-' }}</span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="材质" prop="yarn" width="100">
                                    <template #header>
                                        <el-popover placement="bottom" :width="200" trigger="click" v-model:visible="filterVisible.yarn">
                                            <template #reference>
                                                <span :style="{ color: selectedFilters.yarn !== null ? '#ADD8E6' : 'inherit' }" style="cursor: pointer">
                                                    材质
                                                    <el-icon v-if="selectedFilters.yarn !== null" class="el-icon--right"></el-icon>
                                                </span>
                                            </template>
                                            <div class="filter-options">
                                                <div v-for="item in filterOptions.yarns" 
                                                    :key="item.value" 
                                                    class="filter-option-item"
                                                    :class="{ 'is-active': selectedFilters.yarn === item.value }"
                                                    @click="selectedFilters.yarn = item.value">
                                                    {{ item.text }}
                                                </div>
                                            </div>
                                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #EBEEF5; text-align: right">
                                                <el-button size="small" @click="resetSpecificFilter('yarn')">重置</el-button>
                                                <el-button size="small" type="primary" @click="handleProductSearch">确定</el-button>
                                            </div>
                                        </el-popover>
                                    </template>
                                    <template #default="{ row }">
                                        <div v-if="isEditMode" class="editable-cell">
                                            <el-input
                                                v-model="row.yarn"
                                                size="small"
                                                @keyup.enter="handleSpecsSave(row)"
                                                placeholder="输入材质">
                                            </el-input>
                                        </div>
                                        <span v-else style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; width: 80px; cursor: pointer;" :title="row.yarn">{{ row.yarn || '-' }}</span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="成分" prop="composition" width=100">
                                    <template #header>
                                        <el-popover placement="bottom" :width="200" trigger="click" v-model:visible="filterVisible.composition">
                                            <template #reference>
                                                <span :style="{ color: selectedFilters.composition !== null ? '#ADD8E6' : 'inherit' }" style="cursor: pointer">
                                                    成分
                                                    <el-icon v-if="selectedFilters.composition !== null" class="el-icon--right"></el-icon>
                                                </span>
                                            </template>
                                            <div class="filter-options">
                                                <div v-for="item in filterOptions.compositions" 
                                                    :key="item.value" 
                                                    class="filter-option-item"
                                                    :class="{ 'is-active': selectedFilters.composition === item.value }"
                                                    @click="selectedFilters.composition = item.value">
                                                    {{ item.text }}
                                                </div>
                                            </div>
                                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #EBEEF5; text-align: right">
                                                <el-button size="small" @click="resetSpecificFilter('composition')">重置</el-button>
                                                <el-button size="small" type="primary" @click="handleProductSearch">确定</el-button>
                                            </div>
                                        </el-popover>
                                    </template>
                                    <template #default="{ row }">
                                        <div v-if="isEditMode" class="editable-cell">
                                            <el-input
                                                v-model="row.composition"
                                                size="small"
                                                @keyup.enter="handleSpecsSave(row)"
                                                placeholder="输入成分">
                                            </el-input>
                                        </div>
                                        <span v-else style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; width: 80px; cursor: pointer;" :title="row.composition">{{ row.composition || '-' }}</span>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="specs" label="颜色/库存" width="250" min-width="125">
                                    <template #default="scope">
                                        <template v-for="spec in getSpecs(scope.row.specs)" :key="spec.color">
                                            <el-tooltip
                                                v-if="spec.stock >= 1000"
                                                :content="spec.color + ': ' + spec.stock"
                                                placement="top"
                                                effect="light">
                                                <el-tag size="small" style="margin: 2px">
                                                    {{ spec.color }}(充足)
                                                </el-tag>
                                            </el-tooltip>
                                            <el-tag v-else size="small" style="margin: 2px">
                                                {{ spec.color }}({{ spec.stock }})
                                            </el-tag>
                                        </template>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="created_at" label="创建日期" width="120">
                                    <template #default="scope">
                                        {{ formatDate(scope.row.created_at) }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="175" fixed="right">
                                    <template #default="scope">
                                        <el-button-group>
                                            <el-button size="small" type="primary"
                                                @click="handleEdit(scope.row)">编辑</el-button>
                                        <el-button size="small" type="danger"
                                            @click="handleDelete(scope.row)">删除</el-button>
                                        <el-button size="small" :type="scope.row.status === 1 ? 'info' : 'success'"
                                            @click="handleStatusChange(scope.row,'status')">{{ scope.row.status === 1 ? '下架' : '上架' }}</el-button>
                                        </el-button-group>


                                    </template>
                                </el-table-column>
                            </el-table>
                            <!-- 分页 -->
                            <div class="pagination-container" style="margin-top: 20px; text-align: right;">
                                <el-pagination
                                    v-model:current-page="pagination.currentPage"
                                    v-model:page-size="pagination.pageSize"
                                    :page-sizes="[20, 30, 50, 100]"
                                    :total="pagination.total"
                                    layout="total, sizes, prev, pager, next, jumper"
                                    @size-change="handleSizeChange"
                                    @current-change="handleCurrentChange"
                                    :prev-text="'上一页'"
                                    :next-text="'下一页'"
                                    :total-text="'总计'"
                                    popper-class="pagination-dropdown"
                                />
                            </div>

                            <!-- 添加商品编辑商品对话框 -->
                            <el-dialog 
                                v-model="dialogVisible" 
                                :title="dialogType === 'add' ? '添加商品' : '编辑商品'"
                                width="60%"
                                @close="handleDialogClose">
                                <el-form :model="productForm" :rules="productRules" ref="productFormRef"
                                    label-width="100px">
                                    <el-form-item label="款号" >
                                        <el-input v-model="productForm.id" :disabled="true"
                                            placeholder="自动生成">
                                        </el-input>
                                    </el-form-item>

                                    <el-form-item label="商品名称" prop="name">
                                        <el-input v-model="productForm.name" placeholder="请输入商品名称"></el-input>
                                    </el-form-item>
                                    <el-form-item label="商品状态">
                                        <el-row :gutter="20">
                                            <el-col :span="12">
                                                <el-tag :type="productForm.status === 1 ? 'success' : 'info'" @click="handleStatusChange(productForm, 'status')">{{ productForm.status === 1 ? '上架' : '下架' }}</el-tag>
                                            </el-col>
                                            <el-col :span="12">
                                                <el-tag :type="productForm.is_public === 1 ? 'info' : 'success'" @click="handleStatusChange(productForm, 'is_public')">{{ productForm.is_public === 1 ? '公开' : '私密' }}</el-tag>   
                                                </el-switch>
                                            </el-col>
                                        </el-row>
                                    </el-form-item>

                                    

                                    <!-- 只有管理员(user_type=1)才显示这些价格设置 -->
                                    <template v-if="userInfo.user_type === 1">
                                        <el-row :gutter="10">
                                            <el-col :span="8">
                                                <el-form-item label="A类价格" prop="price_b">
                                                    <el-input-number v-model="productForm.price_b" :precision="2" :step="0.1" :min="0"></el-input-number>
                                                </el-form-item>
                                            </el-col>
                                            <el-col :span="8">
                                                <el-form-item label="B类价格" prop="price_c">
                                                    <el-input-number v-model="productForm.price_c" :precision="2" :step="0.1" :min="0"></el-input-number>
                                                </el-form-item>
                                            </el-col>
                                            <el-col :span="8">
                                                <el-form-item label="C类价格" prop="price_d">
                                                    <el-input-number v-model="productForm.price_d" :precision="2" :step="0.1" :min="0"></el-input-number>
                                                </el-form-item>
                                            </el-col>
                                        </el-row>
                                        <el-row :gutter="10" >
                                            <el-col :span="12">
                                                <el-form-item label="建议零售价" prop="price">
                                                    <el-input-number v-model="productForm.price" :precision="2" :step="0.1" :min="0"></el-input-number>
                                                </el-form-item>
                                            </el-col>
                                            <el-col :span="12">
                                                <el-form-item label="成本价" prop="cost_price">
                                                    <el-input-number v-model="productForm.cost_price" :precision="2" :step="0.1" :min="0"></el-input-number>
                                                </el-form-item>
                                            </el-col>
                                        </el-row>
                                    </template>

                                    <el-form-item label="商品款式" prop="style">
                                        <el-select v-model="productForm.style" placeholder="请选择商品款式">
                                            <el-option
                                                v-for="item in styleOptions"
                                                :key="item.id"
                                                :label="item.name"
                                                :value="item.id">
                                            </el-option>
                                        </el-select>
                                    </el-form-item>

                                    <el-form-item label="颜色">
                                        <div style="margin-bottom: 10px;">
                                            <el-checkbox-group v-model="selectedPresetColors"
                                                @change="handlePresetColorsChange">
                                                <el-checkbox v-for="color in presetColors" :key="color" :label="color">
                                                    <span class="color-label">{{ color }}</span>
                                                </el-checkbox>
                                            </el-checkbox-group>
                                        </div>
                                        <el-select v-model="customColorInput" multiple filterable allow-create
                                            default-first-option placeholder="可输入自定义颜色"
                                            @change="handleCustomColorChange" :reserve-keyword="false"
                                            style="width: 100%">
                                            <el-option v-for="color in customColorOptions" :key="color" :label="color"
                                                :value="color">
                                            </el-option>
                                        </el-select>
                                    </el-form-item>

                                    <el-form-item label="商品图片" prop="images">
                                        <el-upload 
                                            ref="uploadRef"
                                            list-type="picture-card"
                                            :auto-upload="dialogType === 'add' ? false : true" 
                                            :multiple="true"
                                            :http-request="customUpload"
                                            :before-upload="handleBeforeUpload"                                        
                                            :on-success="handleUploadSuccess" 
                                            :on-remove="handleRemove"
                                            :on-error="handleUploadError" 
                                            :on-exceed="handleExceed"
                                            :file-list="fileList" 
                                            :on-preview="handlePictureCardPreview"
                                            hide-on-click-modal
                                            accept=".jpg,.png,.jpeg,.gif,.webp"
                                            @change="handleFileChange">
                                            <el-icon>
                                                <Plus />
                                            </el-icon>
                                        </el-upload>
                                    </el-form-item>

                                    <el-form-item label="商品视频">
                                        <div v-if="videoPreviewUrl" class="video-preview-container" style="margin-top: 15px;">
                                            <video 
                                                :src="videoPreviewUrl" 
                                                controls 
                                                style="max-width: 100%; max-height: 300px; border-radius: 4px;"
                                                >
                                            </video>
                                            <div class="video-preview-actions" style="margin-top: 10px;">
                                                <el-button type="primary" size="small" @click="openVideoPreview">
                                                    <el-icon class="el-icon--left"></el-icon>预览视频
                                                </el-button>
                                                <el-button type="danger" size="small" @click="removeVideo">
                                                    <el-icon class="el-icon--left"><Delete /></el-icon>删除视频
                                                </el-button>
                                            </div>
                                        </div>
                                        <el-upload
                                            ref="videoUploadRef"
                                            class="video-uploader"
                                            :limit="1"
                                            :auto-upload="true"
                                            :multiple="false"
                                            :http-request="customVideoUpload"
                                            :before-upload="handleBeforeVideoUpload"
                                            :on-success="handleVideoUploadSuccess"
                                            :on-remove="handleVideoRemove"
                                            :on-error="handleUploadError"
                                            accept=".mp4,.mov,.avi,.webm"
                                            :file-list="videoFileList">
                                            <el-button type="primary">
                                                <el-icon class="el-icon--left"><Upload /></el-icon>上传视频
                                            </el-button>
                                            <template #tip>
                                                <div class="el-upload__tip">仅支持MP4/MOV/AVI/WebM格式，大小不超过50MB</div>
                                            </template>
                                        </el-upload>
                                        
                                    </el-form-item>

                                    <el-form-item label="商品描述" >
                                        <el-input type="textarea" v-model="productForm.description"
                                            placeholder="请输入商品描述"></el-input>
                                    </el-form-item>

                                    
                                    <el-form-item label="商品规格">
                                        <div class="spec-form-container">
                                            <el-row :gutter="4" class="spec-form-row">
                                                <el-col :span="5">
                                                    <div class="spec-form-item">
                                                        <label style='width: 50px;' >尺寸</label>
                                                        <el-input 
                                                            v-model="productForm.size" 
                                                            placeholder="请输入尺寸">
                                                        </el-input>
                                                    </div>
                                                </el-col>
                                                <el-col :span="6">
                                                    <div class="spec-form-item">
                                                        <label style='width: 50px;' >克重</label>
                                                        <el-input-number 
                                                            v-model="productForm.weight" 
                                                            :min="0" 
                                                            :precision="1" 
                                                            placeholder="请输入克重"
                                                            style="width: 100%">
                                                        </el-input-number>
                                                    </div>
                                                </el-col>
                                                <el-col :span="5">
                                                    <div class="spec-form-item">
                                                        <label style='width: 50px;' >材质</label>
                                                        <el-input 
                                                            v-model="productForm.yarn" 
                                                            placeholder="请输入材质">
                                                        </el-input>
                                                    </div>
                                                </el-col>
                                                <el-col :span="5">
                                                    <div class="spec-form-item">
                                                        <label style='width: 50px;' >成分</label>
                                                        <el-input 
                                                            v-model="productForm.composition" 
                                                            placeholder="请输入成分">
                                                        </el-input>
                                                    </div>
                                                </el-col>
                                            </el-row>
                                        </div>
                                    </el-form-item>

                                    <el-form-item label="颜色库存">
                                        <div class="color-stock-form-item" style="border: 1px solid #dcdfe6; border-radius: 4px; padding: 5px;">
                                            <div v-for="(color, index) in productForm.specs" :key="index" class="color-stock-item">
                                                <el-tag class="color-tag" size="small">{{ color.color }}</el-tag>
                                                <div class="stock-input">
                                                    <el-input-number v-model="color.stock" :min="0" :step="1"
                                                        size="small" controls-position="right" style="width: 100px;"
                                                        placeholder="库存数量">
                                                    </el-input-number>
                                                </div>
                                                <div class="color-image-preview" @click="handleColorImageClick(index)">
                                                    <el-image 
                                                        v-if="color.image" 
                                                        :src="this.cloudtohttps(color.image)" 
                                                        fit="cover"
                                                        style="width: 40px; height: 40px; border-radius: 4px;">
                                                    </el-image>
                                                    <el-button v-else size="small" type="primary" link>
                                                        选择图片
                                                    </el-button>
                                                </div>
                                            </div>
                                        </div>
                                    </el-form-item>

                                    <el-form-item label="库存预警" prop="stock_warning">
                                        <el-input-number v-model="productForm.stock_warning" :min="0" :step="1"
                                            placeholder="库存预警阈值">
                                        </el-input-number>
                                        <div class="el-form-item__description">
                                            当库存低于此值时将发出预警提醒
                                        </div>
                                    </el-form-item>
                                </el-form>
                                <template #footer>
                                    <span class="dialog-footer">
                                        <el-button @click="handleCancel">取消</el-button>
                                        <el-button type="primary" @click="submitProduct">确定</el-button>
                                    </span>
                                </template>
                            </el-dialog>

                            <!-- 添加颜色图片选择对话框 -->
                            <el-dialog
                                v-model="colorImageDialogVisible"
                                title="选择颜色图片"
                                width="60%"
                                append-to-body>
                                <div class="image-select-grid">
                                    <div 
                                        v-for="(file, index) in fileList"
                                        :key="index"
                                        class="image-select-item"
                                        :class="{ 'selected': selectedImageUrl === file.url }"
                                        @click="selectImage(file)">
                                        <el-image 
                                            :src="file.url" 
                                            fit="cover"
                                            style="width: 100%; height: 100%;">
                                        </el-image>
                                    </div>
                                </div>
                                <template #footer>
                                    <span class="dialog-footer">
                                        <el-button @click="colorImageDialogVisible = false">取消</el-button>
                                        <el-button type="primary" @click="confirmColorImage">确定</el-button>
                                    </span>
                                </template>
                            </el-dialog>
                        </div>

                        <!-- 用户管理内容 -->
                        <div v-if="currentPage === '2'" class="user-container">
                            <!-- 用户列表 -->
                            <el-button size="small" type="primary"
                                 @click="handleAddUser">新增用户</el-button>
                            <el-table :data="users" style="width: 100%">
                                <el-table-column prop="id" label="ID" width="80"></el-table-column>
                                <el-table-column prop="username" label="用户名" width="120"></el-table-column>
                                <el-table-column label="头像" width="80">
                                    <template #default="scope">
                                        <el-avatar :size="40" :src="scope.row.avatar">
                                            <img
                                                src="https://cube.elemecdn.com/e/fd/0fc7d20532fdaf769a25683617711png.png" />
                                        </el-avatar>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="nickname" label="昵称" width="120"></el-table-column>
                                <el-table-column prop="phone" label="电话" width="120"></el-table-column>
                                <el-table-column prop="address" label="地址"></el-table-column>
                                <el-table-column prop="contact" label="联系人" width="100"></el-table-column>
                                <el-table-column prop="status" label="状态" width="80">
                                    <template #default="scope">
                                        <el-tag :type="scope.row.status === 1 ? 'success' : 'danger'">
                                            {{ scope.row.status === 1 ? '启用' : '禁用' }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="created_at" label="注册时间" width="160">
                                    <template #default="scope">
                                        {{ formatDate(scope.row.created_at) }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="180" fixed="right">
                                    <template #default="scope">
                                        <el-button-group>
                                            <el-button size="small" type="primary"
                                                @click="handleEditUser(scope.row)">编辑</el-button>
                                            <el-button size="small"
                                                :type="scope.row.status === 1 ? 'danger' : 'success'"
                                                @click="handleToggleUserStatus(scope.row)">
                                                {{ scope.row.status === 1 ? '禁用' : '启用' }}
                                            </el-button>
                                            <el-button size="small" type="primary"
                                                @click="handleDeleteUser(scope.row)">删除</el-button>
                                        </el-button-group>
                                    </template>
                                </el-table-column>
                            </el-table>

                            <!-- 分页 -->
                            <div class="pagination-container" style="margin-top: 20px; text-align: right;">
                                <el-pagination v-model:current-page="userPagination.currentPage"
                                    v-model:page-size="userPagination.pageSize" :page-sizes="pageSizeOptions"
                                    :total="userPagination.total" layout="total, sizes, prev, pager, next, jumper"
                                    @size-change="handleUserSizeChange" @current-change="handleUserCurrentChange" />
                            </div>

                            <!-- 编辑用户对话框 -->
                            <el-dialog v-model="userDialogVisible" :title="userDialogStatus === 'add' ? '新增用户' : '编辑用户'" width="50%">
                                <el-form :model="userForm" :rules="userFormRules" ref="userFormRef" label-width="100px">
                                    <el-form-item label="用户名" prop="username">
                                        <el-input v-model="userForm.username" :disabled="userDialogStatus === 'edit'"></el-input>
                                    </el-form-item>
                                    <el-form-item label="密码" prop="password" v-if="userDialogStatus === 'add'"> 
                                        <el-input v-model="userForm.password" type="password"></el-input>
                                    </el-form-item>
                                    <el-form-item label="昵称" prop="nickname">
                                        <el-input v-model="userForm.nickname"></el-input>
                                    </el-form-item>
                                    <el-form-item label="电话" prop="phone">
                                        <el-input v-model="userForm.phone"></el-input>
                                    </el-form-item>
                                    <el-form-item label="地址">
                                        <el-input v-model="userForm.address" type="textarea"></el-input>
                                    </el-form-item>
                                    <el-form-item label="联系人">
                                        <el-input v-model="userForm.contact"></el-input>
                                    </el-form-item>
                                    <el-form-item label="状态">
                                        <el-switch v-model="userForm.status" :active-value="1" :inactive-value="0"
                                            active-text="启用" inactive-text="禁用">
                                        </el-switch>
                                    </el-form-item>
                                </el-form>
                                <template #footer>
                                    <span class="dialog-footer">
                                        <el-button @click="userDialogVisible = false">取消</el-button>
                                        <el-button type="primary" @click="submitUserForm" v-if="userDialogStatus === 'edit'">确定</el-button>
                                        <el-button type="primary" @click="handleAddUserSubmit" v-if="userDialogStatus === 'add'">注册</el-button>
                                    </span>
                                </template>
                            </el-dialog>
                        </div>

                        <!-- 系统设置内容 -->
                        <div v-if="currentPage === '5'" class="content-container">
                            <h2>系统设置</h2>
                            <div class="settings-container" style="padding: 20px;">
                                <el-row :gutter="20">
                                    <el-col :span="8" >
                                        <el-card shadow="hover" class="settings-card">
                                            <template #header>
                                                <div class="card-header">
                                                    <span>系统基础设置</span>
                                                </div>
                                            </template>
                                            <div class="card-content">
                                                <el-button type="primary" @click="showSystemSettings">设置</el-button>
                                            </div>
                                        </el-card>
                                    </el-col>
                                    <el-col :span="8">
                                        <el-card shadow="hover" class="settings-card">
                                            <template #header>
                                                <div class="card-header">
                                                    <span>商品款式管理</span>
                                                </div>
                                                
                                            </template>     
                                            <el-button type="primary" @click="showStyleSettings">管理</el-button>                                      
                                        </el-card>
                                    </el-col>
                                    <el-col :span="8">
                                        <el-card shadow="hover" class="settings-card">
                                            <template #header>
                                                <div class="card-header">
                                                    <span>推荐商品管理</span>
                                                </div>
                                            </template>
                                            <el-button type="primary" @click="showRecommendedProducts">管理</el-button>
                                        </el-card>
                                    </el-col>
                                    <el-col :span="8">
                                        <el-card shadow="hover" class="settings-card">
                                            <template #header>
                                                <div class="card-header">
                                                    <span>暗推产品管理</span>
                                                </div>
                                            </template>
                                            <el-button type="primary" @click="showHiddenProducts">管理</el-button>
                                        </el-card>
                                    </el-col>
                                </el-row>
                            </div>
                        </div>

                        <!-- 数据统计内容 -->
                        <div v-if="currentPage === '6'" class="statistics-container">
                            <div class="filter-bar">
                                <el-radio-group v-model="timeRange" @change="loadStatistics">
                                    <el-radio-button label="all">全部</el-radio-button>
                                    <el-radio-button label="today">今日</el-radio-button>
                                    <el-radio-button label="week">本周</el-radio-button>
                                    <el-radio-button label="month">本月</el-radio-button>
                                </el-radio-group>
                            </div>

                            <!-- 总体数据卡片 -->
                            <el-row :gutter="20" class="summary-cards">
                                <el-col :span="6">
                                    <el-card shadow="hover">
                                        <template #header>
                                            <div class="card-header">
                                                <span>总浏览量</span>
                                            </div>
                                        </template>
                                        <div class="card-value">{{ statistics.summary.total_views || 0 }}</div>
                                    </el-card>
                                </el-col>
                                <el-col :span="6">
                                    <el-card shadow="hover">
                                        <template #header>
                                            <div class="card-header">
                                                <span>被浏览商品数</span>
                                            </div>
                                        </template>
                                        <div class="card-value">{{ statistics.summary.viewed_products || 0 }}</div>
                                    </el-card>
                                </el-col>
                                <el-col :span="6">
                                    <el-card shadow="hover">
                                        <template #header>
                                            <div class="card-header">
                                                <span>采购单数</span>
                                            </div>
                                        </template>
                                        <div class="card-value">{{ statistics.summary.total_orders || 0 }}</div>
                                    </el-card>
                                </el-col>
                                <el-col :span="6">
                                    <el-card shadow="hover">
                                        <template #header>
                                            <div class="card-header">
                                                <span>采购总数量</span>
                                            </div>
                                        </template>
                                        <div class="card-value">{{ statistics.summary.total_quantity || 0 }}</div>
                                    </el-card>
                                </el-col>
                            </el-row>

                            <!-- 排行榜 -->
                            <el-row :gutter="20" class="rank-lists">
                                <el-col :span="12">
                                    <el-card shadow="hover">
                                        <template #header>
                                            <div class="card-header">
                                                <span>浏览量排行</span>
                                            </div>
                                        </template>
                                        <el-table :data="statistics.top_viewed" stripe>
                                            <el-table-column type="index" label="排名" width="80"></el-table-column>
                                            <el-table-column prop="id" label="款号" width="100"></el-table-column>
                                            <el-table-column prop="name" label="商品名称"></el-table-column>
                                            <el-table-column prop="view_count" label="浏览量"
                                                width="100"></el-table-column>
                                        </el-table>
                                    </el-card>
                                </el-col>
                                <el-col :span="12">
                                    <el-card shadow="hover">
                                        <template #header>
                                            <div class="card-header">
                                                <span>采购量排行</span>
                                            </div>
                                        </template>
                                        <el-table :data="statistics.top_purchased" stripe>
                                            <el-table-column type="index" label="排名" width="80"></el-table-column>
                                            <el-table-column prop="id" label="款号" width="100"></el-table-column>
                                            <el-table-column prop="name" label="商品名称"></el-table-column>
                                            <el-table-column prop="order_count" label="采购次数"
                                                width="100"></el-table-column>
                                            <el-table-column prop="total_quantity" label="采购总量"
                                                width="100"></el-table-column>
                                        </el-table>
                                    </el-card>
                                </el-col>
                            </el-row>
                        </div>

                        <!-- 采购单管理内容 -->
                        <div v-if="currentPage === '3'" class="content-container">
                            <!-- 搜索栏 -->
                            <div class="toolbar">
                                <div class="search-bar">
                                    <el-input v-model="purchaseSearch.keyword" placeholder="搜索采购单号/采购人" clearable
                                        @keyup.enter="handlePurchaseSearch">
                                        <template #append>
                                            <el-button @click="handlePurchaseSearch">搜索</el-button>
                                        </template>
                                    </el-input>
                                </div>
                            </div>

                            <!-- 采购单列表 -->
                            <el-table :data="purchaseOrders" v-loading="purchaseLoading" border stripe>
                                <el-table-column prop="order_number" label="采购单号" width="180">
                                    <template #default="scope">
                                        {{ scope.row.order_number }}
                                    </template>
                                </el-table-column>
                                <el-table-column prop="user_name" label="采购人" width="120">
                                    <template #default="scope">
                                        {{ scope.row.user_name }}

                                    </template>
                                </el-table-column>
                                <el-table-column prop="order_number" label="采购数量" width="180">
                                    <template #default="scope">
                                        {{ scope.row.total_quantity }}
                                    </template>
                                </el-table-column>
                                <el-table-column prop="order_number" label="采购金额" width="180">
                                    <template #default="scope">
                                        {{ scope.row.total_amount }}
                                    </template>
                                </el-table-column>
                                <el-table-column prop="status" label="状态" width="100">
                                    <template #default="scope">
                                        <el-tag :type="getPurchaseStatusType(scope.row.status)">
                                            {{ getPurchaseStatusText(scope.row.status) }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="created_at" label="创建时间" width="180">
                                    <template #default="scope">
                                        {{ formatDate(scope.row.created_at) }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="200" fixed="right">
                                    <template #default="scope">
                                        <el-button-group>
                                            <el-button size="small"
                                                @click="viewPurchaseDetail(scope.row)">查看</el-button>
                                            <el-button v-if="scope.row.status === 0" size="small" type="success"
                                                @click="handleAcceptPurchase(scope.row)">接受</el-button>
                                            <el-button v-if="scope.row.status === 0" size="small" type="danger"
                                                @click="handleCancelPurchase(scope.row)">取消</el-button>
                                            <el-button size="small" type="primary"
                                                @click="createFromPurchase(scope.row.id)">生成配送单</el-button>
                                        </el-button-group>
                                    </template>
                                </el-table-column>
                            </el-table>

                            <!-- 分页 -->
                            <div class="pagination-container">
                                <el-pagination v-model:current-page="purchasePagination.currentPage"
                                    v-model:page-size="purchasePagination.pageSize" :total="purchasePagination.total"
                                    @current-change="handlePurchasePageChange" layout="total, prev, pager, next" />
                            </div>

                            <!-- 采购单详情对话框 -->
                            <el-dialog v-model="purchaseDetailVisible" title="采购单详情" width="60%">
                                <div v-if="currentPurchaseOrder">
                                    <el-descriptions :column="2" border>
                                        <el-descriptions-item label="采购单号">{{ currentPurchaseOrder.order_number
                                            }}</el-descriptions-item>
                                        <el-descriptions-item label="创建时间">{{
                                            formatDate(currentPurchaseOrder.created_at) }}</el-descriptions-item>
                                        <el-descriptions-item label="状态">
                                            <el-tag :type="getPurchaseStatusType(currentPurchaseOrder.status)">
                                                {{ getPurchaseStatusText(currentPurchaseOrder.status) }}
                                            </el-tag>
                                        </el-descriptions-item>
                                        <el-descriptions-item label="采购人">{{ currentPurchaseOrder.user_name
                                            }}</el-descriptions-item>
                                        <el-descriptions-item label="备注" :span="2">{{ currentPurchaseOrder.remark || '无'
                                            }}</el-descriptions-item>
                                    </el-descriptions>

                                    <el-divider>商品明细</el-divider>

                                    <el-table :data="currentPurchaseOrder.items" border>
                                        <el-table-column prop="product_name" label="商品名称" >
                                            <template #default="scope">
                                                {{ scope.row.product_name }}
                                            </template>
                                        </el-table-column>
                                        <el-table-column prop="product_name" label="款号"  width="60">
                                            <template #default="scope">
                                                {{ scope.row.product_id }}
                                            </template>
                                        </el-table-column>
                                        <el-table-column prop="quantity" label="数量" width="60" >
                                            <template #default="scope">
                                                {{ scope.row.quantity }}
                                            </template>
                                        </el-table-column>
                                        <el-table-column prop="color" label="颜色" width="60" >
                                            <template #default="scope">
                                                {{ scope.row.color }}
                                            </template>
                                        </el-table-column>
                                        <el-table-column prop="price" label="单价" width="120">
                                            <template #default="scope">
                                                ¥{{ scope.row.price }}
                                            </template>
                                        </el-table-column>
                                        <el-table-column label="小计" width="120">
                                            <template #default="scope">
                                                ¥{{ (scope.row.price * scope.row.quantity).toFixed(2) }}
                                            </template>
                                        </el-table-column>
                                    </el-table>

                                    <div class="total-amount">
                                        总金额：¥{{ currentPurchaseOrder.total_amount }}
                                    <div class="dialog-footer" style="margin-top: 20px; text-align: right;">
                                        <el-button @click="purchaseDetailVisible = false">关闭</el-button>
                                        <el-button 
                                            v-if="currentPurchaseOrder.status === 0"
                                            type="success" 
                                            @click="handleAcceptPurchase(currentPurchaseOrder)">
                                            接受订单
                                        </el-button>
                                        <el-button 
                                            v-if="currentPurchaseOrder.status === 0"
                                            type="danger"
                                            @click="handleCancelPurchase(currentPurchaseOrder)">
                                            取消订单
                                        </el-button>
                                    </div>
                                        
                                    </div>
                                    
                                </div>
                            </el-dialog>
                        </div>

                        <!-- 配送单管理内容 -->
                        <div v-if="currentPage === '4'" class="content-container">
                            <!-- 搜索栏 -->
                            <div class="toolbar">
                                <div class="search-bar">
                                    <el-input v-model="deliverySearch.keyword" placeholder="搜索配送单号/客户名称" clearable
                                        @keyup.enter="handleDeliverySearch">
                                        <template #append>
                                            <el-button @click="handleDeliverySearch">搜索</el-button>
                                        </template>
                                    </el-input>
                                </div>
                                <el-button type="primary" @click="showCreateDeliveryDialog">
                                     新建配送单
                                </el-button>
                                
                            </div>
                            <div class="status-tabs">
                                <el-radio-group v-model="deliverySearch.status" @change="handleDeliverySearch">
                                    <el-radio-button label="all">
                                        全部
                                        <el-tag type="info" size="small" class="count-tag">{{ deliveryStats.total || 0 }}</el-tag>
                                    </el-radio-button>
                                    <el-radio-button label="0">
                                        待配送
                                        <el-tag type="warning" size="small" class="count-tag">{{ deliveryStats.pending || 0 }}</el-tag>
                                    </el-radio-button>
                                    <el-radio-button label="1">
                                        配送中
                                        <el-tag type="primary" size="small" class="count-tag">{{ deliveryStats.delivering || 0 }}</el-tag>
                                    </el-radio-button>
                                    <el-radio-button label="2">
                                        已完成
                                        <el-tag type="success" size="small" class="count-tag">{{ deliveryStats.completed || 0 }}</el-tag>
                                    </el-radio-button>
                                    <el-radio-button label="3">
                                        已取消
                                        <el-tag type="danger" size="small" class="count-tag">{{ deliveryStats.cancelled || 0 }}</el-tag>
                                    </el-radio-button>
                                </el-radio-group>
                            </div>
                            <!-- 配送单列表 -->
                            <el-table :data="deliveryOrders" v-loading="deliveryLoading" border stripe>
                                <el-table-column prop="order_number" label="配送单号" width="180">
                                    <template #default="scope">
                                        {{ scope.row.orderNumber }}
                                    </template>
                                </el-table-column>
                                <el-table-column prop="customer_name" label="发货人" width="120">
                                    <template #default="scope">
                                        {{ scope.row.deliveryName }}
                                    </template>
                                </el-table-column>
                                <el-table-column prop="customer_name" label="客户名称" width="120">
                                    <template #default="scope">
                                        {{ scope.row.customerName }}
                                    </template>
                                </el-table-column>
                                <el-table-column prop="customer_phone" label="联系电话" width="120">
                                    <template #default="scope">
                                        {{ scope.row.customerPhone }}
                                    </template>
                                </el-table-column>
                                <el-table-column prop="status" label="状态" width="100">
                                    <template #default="scope">
                                        <el-tag :type="getDeliveryStatusType(scope.row.status)">
                                            {{ getDeliveryStatusText(scope.row.status) }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="created_at" label="创建时间" width="180">
                                    <template #default="scope">
                                        {{ formatDate(scope.row.createdAt) }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="220" fixed="right">
                                    <template #default="scope">
                                        <el-button-group>
                                            <el-button size="small"
                                                @click="viewDeliveryDetail(scope.row)">查看</el-button>
                                            <el-button v-if="scope.row.status === 0" size="small" type="success"
                                                @click="handleStartDelivery(scope.row)">配送</el-button>
                                            <el-button v-if="scope.row.status === 1" size="small" type="success"
                                                @click="handleCompleteDelivery(scope.row)">完成</el-button>
                                            <el-button v-if="scope.row.status === 0" size="small" type="danger"
                                                @click="handleCancelDelivery(scope.row)">取消</el-button>
                                            <el-button 
                                                size="small" 
                                                type="danger" 
                                                @click="handleDeleteDelivery(scope.row)"
                                                :disabled="![0, 3].includes(scope.row.status)" >                                                
                                                删除    
                                            </el-button>    
                                        </el-button-group>
                                    </template>
                                </el-table-column>
                            </el-table>

                            <!-- 分页 -->
                            <div class="pagination-container">
                                <el-pagination v-model:current-page="deliveryPagination.currentPage"
                                    v-model:page-size="deliveryPagination.pageSize" :total="deliveryPagination.total"
                                    @current-change="handleDeliveryPageChange" layout="total, prev, pager, next" />
                            </div>                            

                            <!-- 新建配送单对话框 -->
                            <el-dialog v-model="createDeliveryVisible" title="新建配送单" width="800px">
                                <el-form :model="deliveryForm" label-width="100px">
                                    <el-form-item label="客户名称" prop="customerName">
                                        <el-input v-model="deliveryForm.customerName" />
                                    </el-form-item>
                                    <el-form-item label="联系电话" prop="customerPhone">
                                        <el-input v-model="deliveryForm.customerPhone" />
                                    </el-form-item>
                                    <el-form-item label="配送地址" prop="deliveryAddress">
                                        <el-input v-model="deliveryForm.deliveryAddress" />
                                    </el-form-item>
                                    <el-form-item label="配送日期" prop="deliveryDate">
                                        <el-date-picker v-model="deliveryForm.deliveryDate" type="date" placeholder="选择配送日期" />
                                    </el-form-item>
                                    <el-form-item label="配送时段" prop="deliveryTimeSlot">
                                        <el-select v-model="deliveryForm.deliveryTimeSlot" placeholder="选择配送时段">
                                            <el-option label="上午" value="morning" />
                                            <el-option label="下午" value="afternoon" />
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item label="备注" prop="remark">
                                        <el-input v-model="deliveryForm.remark" type="textarea" />
                                    </el-form-item>
                                    
                                    <el-form-item label="商品列表">
                                        <el-button type="primary" @click="showAddItemDialog">添加商品</el-button>
                                        <el-table :data="deliveryForm.items" border style="margin-top: 10px;">
                                            <el-table-column prop="productName" label="商品名称" >
                                                <template #default="scope"> 
                                                    {{ scope.row.productName }}
                                                </template>
                                            </el-table-column>
                                            <el-table-column prop="color" label="颜色" width="120" >
                                                <template #default="scope"> 
                                                    {{ scope.row.color }}
                                                </template>
                                            </el-table-column>
                                            <el-table-column prop="quantity" label="数量" width="120" >
                                                <template #default="scope"> 
                                                    {{ scope.row.quantity }}
                                                </template>
                                            </el-table-column>
                                            <el-table-column label="操作" width="120">
                                                <template #default="scope">
                                                    <el-button type="danger" size="small" @click="removeDeliveryItem(scope.$index)">删除</el-button>
                                                </template>
                                            </el-table-column>
                                        </el-table>
                                    </el-form-item>
                                </el-form>
                                <template #footer>
                                    <span class="dialog-footer">
                                        <el-button @click="createDeliveryVisible = false">取消</el-button>
                                        <el-button type="primary" @click="submitDeliveryForm">确定</el-button>
                                    </span>
                                </template>
                            </el-dialog>

                            <el-dialog v-model="addItemDialogVisible" title="添加商品" width="60%">
                                <div class="search-bar" style="margin-bottom: 20px;">
                                    <el-input
                                        v-model="itemSearch.keyword"
                                        placeholder="搜索商品"
                                        clearable
                                        @keyup.enter="handleItemSearch"
                                    >
                                        <template #append>
                                            <el-button @click="handleItemSearch">搜索</el-button>
                                        </template>
                                    </el-input>
                                </div>

                                <el-table :data="searchProducts" border @selection-change="handleProductSelectionChange">
                                    <el-table-column type="selection" width="55" >
                                        <template #header>
                                            <el-button type="danger" :disabled="!selectedProducts.length" @click="handleBatchDelete">
                                                批量删除
                                            </el-button>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="id" label="款号" width="120" >
                                        <template #default="scope">
                                            {{ scope.row.id }}
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="name" label="商品名称" >
                                        <template #default="scope">
                                            {{ scope.row.name }}
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="颜色" width="150">
                                        <template #default="scope">
                                            <el-select 
                                                v-model="scope.row.selected_color" 
                                                placeholder="选择颜色"
                                                size="small"
                                                style="width: 120px"
                                            >
                                                <el-option
                                                    v-for="color in scope.row.colors"
                                                    :key="color"
                                                    :label="color"
                                                    :value="color"
                                                />
                                            </el-select>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="数量" width="150">
                                        <template #default="scope">
                                            <el-input-number 
                                                v-model="scope.row.quantity" 
                                                :min="1"
                                                size="small"
                                                style="width: 120px"
                                            />
                                        </template>
                                    </el-table-column>
                                </el-table>

                                <template #footer>
                                    <span class="dialog-footer">
                                        <el-button @click="addItemDialogVisible = false">取消</el-button>
                                        <el-button type="primary" @click="confirmAddItems">确定</el-button>
                                    </span>
                                </template>
                            </el-dialog> 
                            

                            <!-- 查看配送单详情对话框 -->
                            <el-dialog v-model="viewDeliveryVisible" title="配送单详情" width="800px">
                                <el-descriptions :column="2" border>
                                    <el-descriptions-item label="订单编号">{{ currentDeliveryOrder?.orderNumber }}</el-descriptions-item>
                                    <el-descriptions-item label="配送状态">{{ getDeliveryStatusText(currentDeliveryOrder?.status) }}</el-descriptions-item>
                                    <el-descriptions-item label="客户名称">{{ currentDeliveryOrder?.customerName }}</el-descriptions-item>
                                    <el-descriptions-item label="联系电话">{{ currentDeliveryOrder?.customerPhone }}</el-descriptions-item>
                                    <el-descriptions-item label="配送地址">{{ currentDeliveryOrder?.deliveryAddress }}</el-descriptions-item>
                                    <el-descriptions-item label="配送日期">{{ currentDeliveryOrder?.deliveryDate }}</el-descriptions-item>
                                    <el-descriptions-item label="配送时段">{{ currentDeliveryOrder?.deliveryTimeSlot === 'morning' ? '上午' : '下午' }}</el-descriptions-item>
                                    <el-descriptions-item label="备注">{{ currentDeliveryOrder?.remark }}</el-descriptions-item>
                                    <el-descriptions-item label="创建人">{{ currentDeliveryOrder?.creatorName }}</el-descriptions-item>
                                    <el-descriptions-item label="创建时间">{{ currentDeliveryOrder?.createdAt }}</el-descriptions-item>
                                </el-descriptions>
                                
                                <el-table :data="currentDeliveryOrder?.items" border style="margin-top: 20px;">
                                    <el-table-column prop="productName" label="商品名称" >
                                        <template #default="scope">
                                            {{ scope.row.productName }}
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="color" label="颜色" width="120" >
                                        <template #default="scope">
                                            {{ scope.row.color }}
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="quantity" label="数量" width="120" >
                                        <template #default="scope">
                                            {{ scope.row.quantity }}
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </el-dialog>
                        </div>

                        <!-- 推送单管理内容 -->
                        <div v-if="currentPage === '7'" class="content-container">
                            <!-- 搜索栏 -->
                            <div class="toolbar">
                                <div class="search-bar">
                                    <el-input v-model="pushSearch.keyword" placeholder="搜索推送单号/推送对象" clearable @keyup.enter="handlePushSearch">
                                        <template #append>
                                            <el-button @click="handlePushSearch">搜索</el-button>
                                        </template>
                                    </el-input>
                                </div>
                            </div>
                            
                            <!-- 状态筛选 -->
                            <div class="status-tabs">
                                <el-radio-group v-model="pushSearch.status" @change="handlePushSearch">
                                    <el-radio-button label="all">
                                        全部
                                        <el-tag type="info" size="small" class="count-tag">{{ pushStats.total || 0 }}</el-tag>
                                    </el-radio-button>
                                    <el-radio-button label="0">
                                        有效
                                        <el-tag type="success" size="small" class="count-tag">{{ pushStats.active || 0 }}</el-tag>
                                    </el-radio-button>
                                    <el-radio-button label="1">
                                        已失效
                                        <el-tag type="danger" size="small" class="count-tag">{{ pushStats.inactive || 0 }}</el-tag>
                                    </el-radio-button>
                                </el-radio-group>
                            </div>
                            
                            <!-- 推送单列表 -->
                            <el-table :data="pushOrders" v-loading="pushLoading" border stripe>
                                <el-table-column prop="order_number" label="推送单号" width="180"></el-table-column>
                                <el-table-column prop="target_name" label="推送对象" width="120"></el-table-column>
                                <el-table-column prop="creator_name" label="创建人" width="120"></el-table-column>
                                <el-table-column prop="product_count" label="商品数量" width="100"></el-table-column>
                                <el-table-column prop="status" label="状态" width="100">
                                    <template #default="scope">
                                        <el-tag :type="scope.row.status === 0 ? 'success' : 'danger'">
                                            {{ scope.row.status === 0 ? '有效' : '已失效' }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="created_at" label="创建时间" width="180">
                                    <template #default="scope">
                                        {{ formatDate(scope.row.created_at) }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="200" fixed="right">
                                    <template #default="scope">
                                        <el-button-group>
                                            <el-button size="small" @click="viewPushDetail(scope.row)">查看</el-button>
                                            <el-button v-if="scope.row.status === 0" size="small" type="danger"
                                                @click="handleInvalidatePush(scope.row)">设为失效</el-button>
                                            <el-button v-if="scope.row.status === 1" size="small" type="success"
                                                @click="handleActivatePush(scope.row)">设为有效</el-button>
                                            <el-button size="small" type="danger" @click="handleDeletePush(scope.row)">删除</el-button>
                                        </el-button-group>
                                    </template>
                                </el-table-column>
                            </el-table>
                            
                            <!-- 分页 -->
                            <div class="pagination-container">
                                <el-pagination v-model:current-page="pushPagination.currentPage"
                                    v-model:page-size="pushPagination.pageSize" :total="pushPagination.total"
                                    @current-change="handlePushPageChange" layout="total, prev, pager, next" />
                            </div>
                            
                            <!-- 推送单详情对话框 -->
                            <el-dialog v-model="pushDetailVisible" title="推送单详情" width="60%">
                                <div v-if="currentPushOrder">
                                    <el-descriptions :column="2" border>
                                        <el-descriptions-item label="推送单号">{{ currentPushOrder.order_number }}</el-descriptions-item>
                                        <el-descriptions-item label="推送对象">{{ currentPushOrder.target_name }}</el-descriptions-item>
                                        <el-descriptions-item label="创建人">{{ currentPushOrder.creator_name }}</el-descriptions-item>
                                        <el-descriptions-item label="创建时间">{{ formatDate(currentPushOrder.created_at) }}</el-descriptions-item>
                                        <el-descriptions-item label="状态">
                                            <el-tag :type="currentPushOrder.status === 0 ? 'success' : 'danger'">
                                                {{ currentPushOrder.status === 0 ? '有效' : '已失效' }}
                                            </el-tag>
                                        </el-descriptions-item>
                                    </el-descriptions>
                                    
                                    <el-divider>商品明细</el-divider>
                                    <el-table :data="currentPushOrder.products" border>
                                        <el-table-column prop="name" label="商品名称"></el-table-column>
                                        <el-table-column prop="price" label="价格" width="120">
                                            <template #default="scope">
                                                ¥{{ scope.row.price }}
                                            </template>
                                        </el-table-column>
                                        <el-table-column prop="specs" label="规格" width="200">
                                            <template #default="scope">
                                                <el-tag v-for="spec in scope.row.specs" :key="spec.color" size="small" style="margin: 2px">
                                                    {{ spec.color }}
                                                </el-tag>
                                            </template>
                                        </el-table-column>
                                    </el-table>
                                    
                                    <div v-if="currentPushOrder.qrcode_path" style="margin-top: 20px; text-align: center;">
                                        <el-image :src="getImageUrl(currentPushOrder.qrcode_path)" style="width: 200px; height: 200px;"
                                            :preview-src-list="[getImageUrl(currentPushOrder.qrcode_path)]">
                                        </el-image>
                                    </div>
                                </div>
                            </el-dialog>
                        </div>
                    </div>
                </el-main>
            </el-container>
        </el-container>

    <!-- 个人信息编辑对话框 -->
    <el-dialog v-model="profileDialogVisible" title="编辑个人信息" width="50%">
        <el-form :model="profileForm" :rules="profileFormRules" ref="profileFormRef" label-width="100px">
            <el-form-item label="用户名">
                <el-input v-model="profileForm.username" disabled></el-input>
            </el-form-item>
            <el-form-item label="昵称" prop="nickname">
                <el-input v-model="profileForm.nickname"></el-input>
            </el-form-item>
            <el-form-item label="电话" prop="phone">
                <el-input v-model="profileForm.phone"></el-input>
            </el-form-item>
            <el-form-item label="地址">
                <el-input v-model="profileForm.address" type="textarea"></el-input>
            </el-form-item>
            <el-form-item label="联系人">
                <el-input v-model="profileForm.contact"></el-input>
            </el-form-item>
        </el-form>
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="profileDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="submitProfile">确定</el-button>
            </span>
        </template>
    </el-dialog>

    <!-- 系统管理对话框 -->
    <el-dialog 
        v-model="systemSettingsVisible" 
        title="系统设置" 
        width="500px"
        :close-on-click-modal="false"
        :show-close="true"
        destroy-on-close
    >
        <el-form :model="systemSettings" label-width="120px">
            <el-form-item label="系统名称">
                <el-input v-model="systemSettings.system_name"></el-input>
            </el-form-item>
            <el-form-item label="系统描述">
                <el-input type="textarea" v-model="systemSettings.system_description"></el-input>
            </el-form-item>
            <el-form-item label="系统Logo">
                <el-upload
                    class="avatar-uploader"
                    action="/upload"
                    :show-file-list="false"
                    :on-success="handleLogoSuccess"
                    :before-upload="beforeLogoUpload">
                    <img v-if="systemSettings.logo_url" :src="systemSettings.logo_url" class="avatar">
                    <el-icon v-else><Plus /></el-icon>
                </el-upload>
            </el-form-item>
        </el-form>
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="closeSystemSettings">取消</el-button>
                <el-button type="primary" @click="saveSystemSettings">保存</el-button>
            </span>
        </template>
    </el-dialog>

    <!-- 商品款式设置对话框 -->
    <el-dialog title="商品款式设置" v-model="styleSettingsVisible" width="600px">
        <el-table :data="product_types" border style="width: 100%">
            <el-table-column prop="id" label="ID" width="80"></el-table-column>
            <el-table-column prop="name" label="款式名称">
                <template #default="scope">
                    <el-input v-model="scope.row.name" placeholder="请输入款式名称"></el-input>
                </template>
            </el-table-column>
            <el-table-column label="操作" width="100">
                <template #default="scope">
                    <el-button-group>
                        <el-button 
                            type="primary" 
                            size="small"
                            :disabled="scope.$index === 0"
                            @click="moveStyle(scope.$index, 'up')">
                            上移
                        </el-button>
                        <el-button 
                            type="primary" 
                            size="small"
                            :disabled="scope.$index === product_types.length - 1"
                            @click="moveStyle(scope.$index, 'down')">
                            下移
                        </el-button>
                        <el-button type="danger" size="small" @click="handleRemoveStyle(scope.$index)">删除</el-button>
                    </el-button-group>
                </template>
            </el-table-column>
        </el-table>
        <div style="margin-top: 20px;">
            <el-button type="primary" @click="handleAddStyle">添加款式</el-button>
        </div>
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="styleSettingsVisible = false">取消</el-button>
                <el-button type="primary" @click="saveStyleSettings">保存</el-button>
            </span>
        </template>
    </el-dialog>

    <!-- 添加推荐商品管理弹窗 -->
    <el-dialog v-model="recommendedProductsVisible" title="推荐商品管理" width="800px">
        <div class="recommended-products-container">
            <div class="search-bar" style="margin-bottom: 20px;">
                <el-input
                    v-model="recommendedSearch.keyword"
                    placeholder="搜索商品名称或ID"
                    clearable
                    @keyup.enter="searchProductsForRecommended"
                >
                    <template #append>
                        <el-button @click="searchProductsForRecommended">搜索</el-button>
                    </template>
                </el-input>
            </div>
            
            <div v-if="searchProductsResults.length > 0" class="search-results">
                <h4>搜索结果</h4>
                <el-table :data="searchProductsResults" border style="margin-bottom: 20px;">
                    <el-table-column prop="id" label="ID" width="80"></el-table-column>
                    <el-table-column prop="name" label="商品名称"></el-table-column>
                    <el-table-column label="图片" width="100">
                        <template #default="scope">
                            <el-image 
                                v-if="scope.row.images && scope.row.images.length > 0"
                                style="width: 50px; height: 50px; cursor: pointer; border-radius: 4px; overflow: hidden;" 
                                :src="handleImageUrl(scope.row.images[0])"
                                :preview-src-list="scope.row.images.map(img => handleImageUrl(img))"
                                fit="cover">
                            </el-image>
                        </template>
                    </el-table-column>
                    <el-table-column label="操作" width="120">
                        <template #default="scope">
                            <el-button 
                                type="primary" 
                                size="small" 
                                @click="addToRecommended(scope.row)"
                                :disabled="isProductRecommended(scope.row.id)">
                                添加
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
            
            <div class="recommended-list">
                <h4>当前推荐商品 ({{recommendedProducts.length}})</h4>
                <el-empty v-if="recommendedProducts.length === 0" description="暂无推荐商品"></el-empty>
                <el-table 
                    v-else 
                    :data="recommendedProducts" 
                    row-key="id"
                    border 
                    style="width: 100%;">
                    <el-table-column type="index" width="50" label="排序"></el-table-column>
                    <el-table-column prop="id" label="ID" width="80"></el-table-column>
                    <el-table-column prop="name" label="商品名称"></el-table-column>
                    <el-table-column label="图片" width="100">
                        <template #default="scope">
                            <el-image 
                                v-if="scope.row.images && scope.row.images.length > 0"
                                style="width: 50px; height: 50px; cursor: pointer; border-radius: 4px; overflow: hidden;" 
                                :src="handleImageUrl(scope.row.images[0])"
                                :preview-src-list="scope.row.images.map(img => handleImageUrl(img))"
                                fit="cover">
                            </el-image>
                        </template>
                    </el-table-column>
                    <el-table-column label="操作" width="200">
                        <template #default="scope">
                            <el-button-group>
                                <el-button 
                                    type="primary" 
                                    size="small"
                                    :disabled="scope.$index === 0"
                                    @click="moveRecommendedProduct(scope.$index, 'up')">
                                    上移
                                </el-button>
                                <el-button 
                                    type="primary" 
                                    size="small"
                                    :disabled="scope.$index === recommendedProducts.length - 1"
                                    @click="moveRecommendedProduct(scope.$index, 'down')">
                                    下移
                                </el-button>
                                <el-button 
                                    type="danger" 
                                    size="small"
                                    @click="removeFromRecommended(scope.$index)">
                                    删除
                                </el-button>
                            </el-button-group>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
        </div>
    </el-dialog>

    <!-- 批量修改状态对话框 -->
    <el-dialog title="批量修改状态" v-model="batchStatusDialogVisible" width="400px">
        <el-form :model="batchStatusForm" label-width="80px">
            <el-form-item label="状态">
                <el-radio-group v-model="batchStatusForm.status">
                    <el-radio :label="1">上架</el-radio>
                    <el-radio :label="0">下架</el-radio>
                </el-radio-group>
            </el-form-item>
        </el-form>
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="batchStatusDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="handleBatchStatusUpdate">确定</el-button>
            </span>
        </template>
    </el-dialog>

    <!-- 批量修改公开状态对话框 -->
    <el-dialog title="批量修改公开状态" v-model="batchPublicDialogVisible" width="400px">
        <el-form :model="batchPublicForm" label-width="80px">
            <el-form-item label="状态">
                <el-radio-group v-model="batchPublicForm.is_public">
                    <el-radio :label="1">公开</el-radio>
                    <el-radio :label="0">私密</el-radio>
                </el-radio-group>
            </el-form-item>
        </el-form>
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="batchPublicDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="handleBatchPublicUpdate">确定</el-button>
            </span>
        </template>
    </el-dialog>

    <!-- 添加暗推产品管理弹窗 -->
    <el-dialog v-model="hiddenProductsVisible" title="暗推产品管理" width="800px">
        <div class="hidden-products-container">
            <div class="search-bar" style="margin-bottom: 20px;">
                <el-input
                    v-model="hiddenSearch.keyword"
                    placeholder="搜索商品名称或ID"
                    clearable
                    @keyup.enter="searchProductsForHidden"
                >
                    <template #append>
                        <el-button @click="searchProductsForHidden">搜索</el-button>
                    </template>
                </el-input>
            </div>
            
            <div v-if="searchProductsResults.length > 0" class="search-results">
                <h4>搜索结果</h4>
                <el-table :data="searchProductsResults" border style="margin-bottom: 20px;">
                    <el-table-column prop="id" label="ID" width="80"></el-table-column>
                    <el-table-column prop="name" label="商品名称"></el-table-column>
                    <el-table-column label="图片" width="100">
                        <template #default="scope">
                            <el-image 
                                v-if="scope.row.images && scope.row.images.length > 0"
                                style="width: 50px; height: 50px; cursor: pointer; border-radius: 4px; overflow: hidden;" 
                                :src="handleImageUrl(scope.row.images[0])"
                                :preview-src-list="scope.row.images.map(img => handleImageUrl(img))"
                                fit="cover">
                            </el-image>
                        </template>
                    </el-table-column>
                    <el-table-column label="操作" width="120">
                        <template #default="scope">
                            <el-button 
                                type="primary" 
                                size="small" 
                                @click="addToHidden(scope.row)"
                                :disabled="isProductHidden(scope.row.id)">
                                添加
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
            
            <div class="hidden-list">
                <h4>当前暗推产品 ({{hiddenProducts.length}})</h4>
                <el-empty v-if="hiddenProducts.length === 0" description="暂无暗推产品"></el-empty>
                <el-table 
                    v-else 
                    :data="hiddenProducts" 
                    row-key="id"
                    border 
                    style="width: 100%;">
                    <el-table-column type="index" width="50" label="排序"></el-table-column>
                    <el-table-column prop="id" label="ID" width="80"></el-table-column>
                    <el-table-column prop="name" label="商品名称"></el-table-column>
                    <el-table-column label="图片" width="100">
                        <template #default="scope">
                            <el-image 
                                v-if="scope.row.images && scope.row.images.length > 0"
                                style="width: 50px; height: 50px; cursor: pointer; border-radius: 4px; overflow: hidden;" 
                                :src="handleImageUrl(scope.row.images[0])"
                                :preview-src-list="scope.row.images.map(img => handleImageUrl(img))"
                                fit="cover">
                            </el-image>
                        </template>
                    </el-table-column>
                    <el-table-column label="操作" width="120">
                        <template #default="scope">
                            <el-button 
                                type="danger" 
                                size="small" 
                                @click="removeFromHidden(scope.$index)">
                                移除
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
        </div>
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="hiddenProductsVisible = false">关闭</el-button>
                <el-button type="primary" @click="saveHiddenProducts">保存</el-button>
            </span>
        </template>
    </el-dialog>

    <!-- 图片预览对话框 -->
    <el-dialog
        v-model="dialogImageVisible"
        width="70%"
        top="5vh"
        :append-to-body="true"
        close-on-click-modal
        center>
        <img 
            :src="dialogImageUrl" 
            alt="预览图片" 
            style="width: 100%; max-height: 70vh; object-fit: contain;" 
        />
    </el-dialog>

    <!-- 视频预览对话框 -->
    <el-dialog
        v-model="videoDialogVisible"
        width="70%"
        top="5vh"
        :append-to-body="true"
        center>
        <video 
            :src="videoPreviewUrl" 
            controls 
            style="width: 100%; max-height: 70vh; object-fit: contain;" 
            autoplay
        ></video>
    </el-dialog>

    </div>



    <!-- 引入依赖 -->
    <script src="//unpkg.com/vue@3"></script>
    <script src="//unpkg.com/element-plus"></script>
    <script src="//unpkg.com/axios/dist/axios.min.js"></script>
    <script>

        const { createApp, computed } = Vue
        
        
        // 设置 axios 默认配置
        const isDevelopment = window.location.hostname === 'localhost' || 
                             window.location.hostname === '127.0.0.1';
        
        axios.defaults.baseURL = isDevelopment ? 'http://127.0.0.1' : '';
        
        // 请求拦截器
        axios.interceptors.request.use(config => {
            console.log('准备发送请求:', {
                url: config.url,
                method: config.method,
                params: config.params,
                data: config.data
            });

            const token = localStorage.getItem('token');
            if (token) {
            //    console.log('添加token到请求头:', `Bearer ${token}`);
                config.headers['Authorization'] = `Bearer ${token}`;
            } else {
                console.warn('未找到token');
            }
            config.headers['Cache-Control'] = 'no-cache';
            config.headers['Pragma'] = 'no-cache';
            return config;
        }, error => {
            console.error('请求拦截器错误:', error);
            return Promise.reject(error);
        });

        // 响应拦截器
        axios.interceptors.response.use(response => {
            // console.log('收到响应:', {
            //     url: response.config.url,
            //     status: response.status,
            //     data: response.data
            // });
            return response;
        }, error => {
            console.group('请求失败详情');
            console.error('请求失败:', {
                url: error.config?.url,
                method: error.config?.method,
                headers: error.config?.headers,
                params: error.config?.params,
                data: error.config?.data
            });

            if (error.response) {
                console.error('服务器响应:', {
                    status: error.response.status,
                    data: error.response.data,
                    headers: error.response.headers
                });

                switch (error.response.status) {
                    case 401:
                        console.warn('认证失败，需要重新登录');
                        ElementPlus.ElMessage.error('登录已过期，请重新登录');
                localStorage.removeItem('token');
                        localStorage.removeItem('userInfo');
                window.location.href = '/admin/index.html';
                        break;
                    case 403:
                        console.warn('权限不足');
                        ElementPlus.ElMessage.error('没有权限访问');
                        break;
                    default:
                        console.error('其他错误:', error.response.data.error || '请求失败');
                        ElementPlus.ElMessage.error(error.response.data.error || '请求失败');
                }
            } else if (error.request) {
                console.error('未收到响应:', error.request);
                ElementPlus.ElMessage.error('网络错误，请稍后重试');
            } else {
                console.error('请求配置错误:', error.message);
                ElementPlus.ElMessage.error('请求配置错误');
            }

            console.groupEnd();
            return Promise.reject(error);
        });

        const app = Vue.createApp({
            data() {
                return {
                    activeTab: '0',
                    userInfo: JSON.parse(localStorage.getItem('userInfo') || '{}'),
                    productSearch: {
                        keyword: '',
                        sortField: '',
                        sortOrder: ''
                    },
                    productLoading: false,
                    currentPage: '1',
                    uploadedFiles: 0,
                    userDialogStatus: 'edit',
                    products: [],
                    pagination: {
                        currentPage: 1,
                        pageSize: 20,
                        total: 0
                    },
                    pageSizeOptions: [10, 25, 50],
                    dialogVisible: false,
                    dialogType: 'add',
                    editingProductId: '',
                    uploadHeaders: {
                        Authorization: `Bearer ${localStorage.getItem('token')}`
                    },
                    fileList: [],
                    styleOptions: [
                        { value: 1, label: '披肩' },
                        { value: 2, label: '围巾' },
                        { value: 3, label: '帽子' },
                        { value: 4, label: '三角巾' },
                        { value: 5, label: '其他' }
                    ],
                    tempUploadData:[],
                    productForm: {
                        id: '',
                        name: '',
                        price: 0,
                        cost_price: 0,
                        price_b: 0,
                        price_c: 0,
                        price_d: 0,
                        style: 1,
                        colors: ['灰色', '黑色'],  // 默认颜色
                        specs: [                 // 初始化 specs 数组
                            { color: '灰色', stock: 0 },
                            { color: '黑色', stock: 0 }
                        ],
                        images: [],
                        description: '暂时没有',
                        stock: 0,
                        stock_warning: 10,
                        size: '',               // 尺寸
                        weight: 0,              // 克重
                        yarn: '',               // 材质
                        composition: '',         // 成分
                        status: 1,          // 默认上架
                        is_public: 0            // 默认私密
                    },
                    productRules: {
                        id: [
                            { 
                                validator: (rule, value, callback) => {
                                    if (this.dialogType === 'edit') {
                                        callback();
                                        return;
                                    }
                                    
                                    if (!value) {
                                        callback(new Error('请输入款号'));
                                        return;
                                    }
                                    if (!/^\d+$/.test(value)) {
                                        callback(new Error('款号必须为数字'));
                                        return;
                                    }
                                    if (value.toString().length < 2 || value.toString().length > 20) {
                                        callback(new Error('长度在 2 到 20 个数字'));
                                        return;
                                    }
                                    callback();
                                },
                                trigger: 'blur'
                            }
                        ],
                        name: [
                            { required: true, message: '请输入商品名称', trigger: 'blur' },
                            { min: 2, max: 50, message: '长度在 2 到 50 个字符', trigger: 'blur' }
                        ],
                        price: [
                            { required: true, message: '请输入商品价格', trigger: 'blur' }
                        ],
                        cost_price: [
                            { required: true, message: '请输入成本价', trigger: 'blur' }
                        ],
                        price_b: [
                            { required: true, message: '请输入价格B', trigger: 'blur' }
                        ],
                        price_c: [
                            { required: true, message: '请输入价格C', trigger: 'blur' }
                        ],
                        price_d: [
                            { required: true, message: '请输入价格D', trigger: 'blur' }
                        ],
                        style: [
                            { required: true, message: '请选择款式', trigger: 'change' }
                        ],
                        description: [
                            { required: true, message: '请输入商品描述', trigger: 'blur' }
                        ],
                        size: [
                            { max: 50, message: '尺寸长度不能超过50个字符', trigger: 'blur' }
                        ],
                        weight: [
                            { type: 'number', min: 0, message: '克重不能小于0', trigger: 'blur' }
                        ],
                        yarn: [
                            { max: 100, message: '材质长度不能超过100个字符', trigger: 'blur' }
                        ],
                        composition: [
                            { max: 500, message: '成分长度不能超过500个字符', trigger: 'blur' }
                        ]
                    },
                    tempProductId: '',
                    presetTags: [],
                    selectedPresetTags: [],
                    presetColors: ['黑色', '白色', '灰色', '红色', '蓝色', '粉色', '米色', '卡其色', '藏青色', '酒红色'],
                    selectedPresetColors: [],
                    customColorInput: [],
                    customColorOptions: [],
                    customTagInput: [],
                    customTagOptions: [],
                    timeRange: 'all',
                    purchaseDetailstatus: 'add',
                    statistics: {
                        summary: {
                            total_views: 0,
                            viewed_products: 0,
                            total_orders: 0,
                            total_quantity: 0
                        },
                        top_viewed: [],
                        top_purchased: []
                    },
                    users: [],
                    userPagination: {
                        currentPage: 1,
                        pageSize: 25,
                        total: 0
                    },
                    userDialogVisible: false,
                    userForm: {
                        id: null,
                        nickname: '',
                        phone: '',
                        address: '',
                        contact: '',
                        status: 1
                    },
                    userFormRules: {
                        nickname: [
                            { required: true, message: '请输入昵称', trigger: 'blur' },
                            { min: 2, max: 20, message: '长度在 2 到 20 个字符', trigger: 'blur' }
                        ],
                        phone: [
                            { pattern: /^1[3-9]\d{9}$/, message: '请输入正确的手机号码', trigger: 'blur' }
                        ]
                    },
                    profileDialogVisible: false,
                    profileForm: {
                        nickname: '',
                        phone: '',
                        address: '',
                        contact: '',
                        avatar: ''
                    },
                    profileFormRules: {
                        nickname: [
                            { required: true, message: '请输入昵称', trigger: 'blur' },
                            { min: 2, max: 20, message: '长度在 2 到 20 个字符', trigger: 'blur' }
                        ],
                        phone: [
                            { pattern: /^1[3-9]\d{9}$/, message: '请输入正确的手机号码', trigger: 'blur' }
                        ]
                    },
                    // 采购单相关数据
                    purchaseSearch: {
                        keyword: ''
                    },
                    purchaseLoading: false,
                    purchaseOrders: [],
                    purchasePagination: {
                        currentPage: 1,
                        pageSize: 15,
                        total: 0
                    },
                    purchaseDetailVisible: false,
                    currentPurchaseOrder: null,
                    // 配送单相关数据
                    deliverySearch: {
                        keyword: '',
                        status: 'all'  // 默认显示全部
                    },
                    deliveryLoading: false,
                    deliveryOrders: [],
                    deliveryPagination: {
                        currentPage: 1,
                        pageSize: 15,
                        total: 0
                    },
                    createDeliveryVisible: false,
                    viewDeliveryVisible: false,
                    currentDeliveryOrder: null,
                    deliveryForm: {
                        customerName: '',
                        customerPhone: '',
                        deliveryAddress: '',
                        deliveryDate: '',
                        deliveryTimeSlot: '',
                        remark: '',
                        items: []
                    },
                    addItemDialogVisible: false,
                    addItemForm: {
                        productName: '',
                        color: '',
                        quantity: ''
                    },
                    itemSearch: {
                        keyword: ''
                    },
                    searchProducts: [],
                    productSearch: {
                        keyword: ''
                    },
                    productLoading: false,
                    batchStockDialogVisible: false,
                    batchStockForm: {
                        mode: 'set',
                        value: 0
                    },
                    imagesLoading: null,
                    selectedProducts: [],
                    deliveryStats: {
                        total: 0,
                        pending: 0,    // 待配送
                        delivering: 0, // 配送中
                        completed: 0,  // 已完成
                        cancelled: 0   // 已取消
                    },
                    purchaseListVisible: false,
                    pushSearch: {
                        keyword: '',
                        status: 'all'
                    },
                    pushStats: {
                        total: 0,
                        active: 0,
                        inactive: 0
                    },
                    pushOrders: [],
                    pushLoading: false,
                    pushPagination: {
                        currentPage: 1,
                        pageSize: 15,
                        total: 0
                    },
                    pushDetailVisible: false,
                    currentPushOrder: null,
                    uploadUrl: '', // 存储上传URL
                    uploadKey: '', // 存储cos key
                    uploadSignature: '', // 存储cos security token
                    uploadxcossecuritytoken: '', // 存储cos key time
                    uploadFileId: '', // 存储file id
                    cloudBaseUrl: 'cloud://prod-9gd4jllic76d4842.7072-prod-9gd4jllic76d4842-1348936510', // 替换为您的云存储域名
                    httpsBaseUrl: 'https://7072-prod-9gd4jllic76d4842-1348936510.tcb.qcloud.la/', // 替换为您的云存储域名
                    uploadProgress: 0, // 上传进度
                    uploadProductData: {}, // 添加这个属性
                    fileUploadInfo: new Map(), // 用于存储每个文件的上传信息
                    productFilter: {
                        type: '', // 款式筛选值
                        keyword: '', // 搜索关键词
                        spec_info: '' // 规格筛选值
                    },
                    batchStyleDialogVisible: false,
                    batchStyleForm: {
                        type: ''
                    },
                    systemSettingsVisible: false,
                    systemSettings: {},
                    styleSettingsVisible: false,
                    product_types: [], // 修改为 product_types
                    imageViewerConfig: {
                        zIndex: 2050,
                        maskClosable: true,
                        onClose: () => {
                            console.log('图片预览关闭');
                        },
                        onSwitch: (index) => {
                            console.log('切换到图片:', index);
                        }
                    },
                    sizeFilters: [],
                    weightFilters: [],
                    yarnFilters: [],
                    compositionFilters: [],
                    filterOptions: {
                        types: [],
                        sizes: [],
                        weights: [],
                        yarns: [],
                        compositions: []
                    },
                    filterVisible: {
                        type: false,
                        size: false,
                        weight: false,
                        yarn: false,
                        composition: false,
                        status: false,
                        is_public: false
                    },
                    selectedFilters: {
                        type: null,
                        size: null,
                        weight: null,
                        yarn: null,
                        composition: null,
                        status: 1,
                        is_public: null
                    },
                    colorImageDialogVisible: false,
                    selectedImageUrl: '',
                    currentColorIndex: -1,
                    isEditMode: false,
                    previewSrcList: [],
                    videoFileList: [],
                    videoPreviewUrl: '',
                    videoPreviewVisible: false,
                    recommendedProductsVisible: false,
                    recommendedSearch: {
                        keyword: ''
                    },
                    searchProductsResults: [],
                    recommendedProducts: [],
                    batchStatusDialogVisible: false,
                    batchStatusForm: {
                        status: 1
                    },
                    batchPublicDialogVisible: false,
                    batchPublicForm: {
                        is_public: 1
                    },
                    hiddenProductsVisible: false,
                    hiddenProducts: [],
                    hiddenSearch: {
                        keyword: ''
                    },
                    dialogImageUrl: '',
                    tagDialogVisible: false,
                    dialogImageVisible: false,
                    videoDialogVisible: false,
                }
            },
           // computed: {
            //    allTagOptions() {
            //        return [...new Set([...this.presetTags, ...this.productForm.tags])]
            //    }
            //},
            created() {
                // 检查登录状态
                const token = localStorage.getItem('token');
                if (!token) {
                    ElementPlus.ElMessage.warning('请先登录');
                    window.location.href = '/admin/index.html';
                    return;
                }

                // 获取当前用户信息并初始化数据
                this.getCurrentUserInfo();
                // 加载款式选项
                this.loadStyleOptions();
                this.loadFilterOptions();
                
                // 初始化加载
                this.loadProducts();
                this.$nextTick(() => {
                    this.initSortable();
                });
            },
            methods: {
                handleSelect(index) {
                    this.currentPage = index;
                    if (index === '1') {
                        this.loadProducts();
                    } else if (index === '2') {
                        this.loadUsers();
                    } else if (index === '3') {
                        this.loadPurchaseOrders();
                    } else if (index === '4') {
                        this.loadDeliveryOrders();
                    } else if (index === '5') {
                        // 加载系统设置
                    } else if (index === '6') {
                        this.loadStatistics();
                    } else if (index === '7') {
                        this.loadPushOrders();
                    }
                },
                handleLogout() {
                    // 清除登录信息
                    localStorage.removeItem('token');
                    localStorage.removeItem('userInfo');
                    window.location.href = '/admin/index.html';
                },
                async loadProducts() {
                    try {
                        this.productLoading = true;
                        const params = {
                            page: this.pagination.currentPage,
                            page_size: this.pagination.pageSize,
                            keyword: this.productSearch.keyword
                        };
                        if (this.productFilter.type) {
                            params.type = this.productFilter.type;
                        }
                        if (this.selectedFilters.size) {
                            params.size = this.selectedFilters.size;
                        }
                        if (this.selectedFilters.weight) {
                            params.weight = this.selectedFilters.weight;
                        }
                        if (this.selectedFilters.yarn) {
                            params.yarn = this.selectedFilters.yarn;
                        }
                        if (this.selectedFilters.composition) {
                            params.composition = this.selectedFilters.composition;
                        }
                        if (this.selectedFilters.status !== null) {
                            params.status = this.selectedFilters.status;
                        }
                        if (this.selectedFilters.is_public !== null) {
                            params.is_public = this.selectedFilters.is_public;
                        }
                        // 添加排序参数
                        if (this.productSearch.sortField) {
                            params.sort_field = this.productSearch.sortField;
                        }
                        if (this.productSearch.sortOrder) {
                            params.sort_order = this.productSearch.sortOrder;
                        }
                        
                        const response = await axios.get('/products', { 
                            params
                        });
                        console.log('搜索商品结果:', response.data);
                        if (response.status === 200) {
                            this.products = response.data.products;
                            this.pagination.total = response.data.total;
                        }
                        
                        // 数据加载完成后更新筛选选项
                        this.updateFilters();
                    } catch (error) {
                        console.error('加载商品列表失败:', error);
                        ElementPlus.ElMessage.error('加载商品列表失败');
                    } finally {
                        this.productLoading = false;
                        }
                },
                showAddProductDialog() {
                    this.dialogType = 'add'
                    this.productForm = {
                        id: '',
                        name: '',
                        price: 0,
                        cost_price: 0,
                        price_b: 0,
                        price_c: 0,
                        price_d: 0,
                        style: 1,
                        colors: ['灰色', '黑色'],  // 默认颜色
                        specs: [                 // 初始化 specs 数组
                            { color: '灰色', stock: 0 },
                            { color: '黑色', stock: 0 }
                        ],
                        images: [],
                        description: '暂时没有',
                        stock: 0,
                        stock_warning: 10,
                        size: '',               // 尺寸
                        weight: 0,              // 克重
                        yarn: '',               // 材质
                        composition: '',         // 成分
                        status: 1,          // 默认上架
                        is_public: 0            // 默认私密
                    }
                    // 清空文件列表
                    if (this.$refs.uploadRef) {
                        this.$refs.uploadRef.clearFiles()
                    }
                    this.dialogVisible = true
                    this.selectedPresetColors = [];
                    this.customColorInput = [];
                    this.customColorOptions = [];
                    
                    // 延迟初始化排序功能，确保DOM已更新
                    setTimeout(() => {
                        this.initSortable();
                    }, 300);
                },

                showCreateDeliveryDialog() {
                    this.createDeliveryVisible = true;
                    this.currentDeliveryOrder = null;
                    this.deliveryForm = {
                        customerName: '无',
                        customerPhone: '13000000000',
                        deliveryAddress: '无',
                        deliveryDate: new Date().toISOString().split('T')[0],
                        deliveryName: '猪猪',
                        deliveryTimeSlot: 'morning',
                        remark: '无',
                        items: []
                    };
                },

                handleEdit(row) {
                    this.dialogType = 'edit'
                    this.editingProductId = row.id
                    
                    // 解析数据
                    const images = typeof row.images === 'string' ? JSON.parse(row.images) : (row.images || []);
                    const specs = typeof row.specs === 'string' ? JSON.parse(row.specs) : (row.specs || []);
                    const tags = typeof row.tags === 'string' ? JSON.parse(row.tags) : (row.tags || []);
                    
                    // 设置文件列表
                    this.fileList = images.map(url => ({
                        name: url.split('/').pop(),
                        url: this.handleImageUrl(url),
                        status: 'success'
                    }));
                    
                    // 更新预览图片列表
                    this.previewSrcList = this.fileList.map(file => file.url);
                    
                    // 处理视频文件
                    if (row.video_url) {
                        const videoUrl = this.handleImageUrl(row.video_url);
                        this.videoPreviewUrl = videoUrl;
                        this.videoFileList = [{
                            name: row.video_url.split('/').pop(),
                            url: videoUrl,
                            status: 'success'
                        }];
                    } else {
                        this.videoPreviewUrl = '';
                        this.videoFileList = [];
                    }
                    
                    // 设置表单数据
                    this.productForm = {
                        id: row.id,
                        name: row.name,
                        price: parseFloat(row.price) || 0,
                        cost_price: parseFloat(row.cost_price) || 0,
                        price_b: parseFloat(row.price_b) || 0,
                        price_c: parseFloat(row.price_c) || 0,
                        price_d: parseFloat(row.price_d) || 0,
                        description: row.description || '',
                        style: parseInt(row.type) || 1,
                        colors: specs.map(spec => spec.color),  // 提取颜色列表
                        specs: specs,  // 保存完整的规格数据（包含库存）
                        tags: tags,
                        images: images,
                        video_url: row.video_url || '',
                        stock: parseInt(row.stock) || 0,
                        stock_warning: parseInt(row.stock_warning) || 10,
                        created_at: row.created_at,
                        size: row.size || '',
                        weight: parseFloat(row.weight) || 0,
                        yarn: row.yarn || '',
                        composition: row.composition || '',
                        status: row.status || 1,
                        is_public: row.is_public || 0
                    };

                    // 解析标签数据
                    const uniqueTags = [...new Set(tags)];
                    
                    // 更新预设标签的选中状态
                    this.selectedPresetTags = uniqueTags.filter(tag => this.presetTags.includes(tag));
                    
                    // 设置预设颜色的选中状态
                    this.selectedPresetColors = specs
                        .map(spec => spec.color)
                        .filter(color => this.presetColors.includes(color));

                    // 设置自定义颜色
                    this.customColorInput = specs.map(spec => spec.color);
                    this.customColorOptions = specs
                        .map(spec => spec.color)
                        .filter(color => !this.presetColors.includes(color));

                    // 直接设置所有标签到 productForm.tags
                    this.productForm.tags = uniqueTags;

                    // 最后再打开对话框
                    this.$nextTick(() => {
                        this.dialogVisible = true;
                        // 延迟初始化排序功能，确保DOM已更新
                        setTimeout(() => {
                            this.initSortable();
                        }, 300);
                    });
                },

                handleDeliveryPageChange(page, pageSize) {
                    this.deliveryPagination.currentPage = page;
                    this.deliveryPagination.pageSize = pageSize;
                    this.loadDeliveryOrders();
                },

                async handleDelete(row) {
                    try {
                        await ElementPlus.ElMessageBox.confirm(
                            '确定要删除这个商品吗？',
                            '警告',
                            {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'warning',
                            }
                        );

                        const response = await axios.delete(`/products/${row.id}`);
                        console.log('response:', response);
                        if (response.status === 200 || response.status === 201) {
                            ElementPlus.ElMessage.success('删除成功');
                            await this.loadProducts(); // 重新加载商品列表
                        } else {
                            throw new Error(response.data.error || '删除失败');
                        }
                    } catch (error) {
                        console.error('删除失败:', error);
                        ElementPlus.ElMessage.error(
                            error.response?.data?.error || error.message || '删除失败，请重试'
                        );
                    }
                },

                handleTagsChange(value) {
                    // 将输入的字符串转换为数组
                    this.productForm.tags = value.split(',')
                        .map(tag => tag.trim())
                        .filter(tag => tag !== '');
                },
                

                // 添加图片压缩方法
                async compressImage(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = (event) => {
                            const img = new Image();
                            img.src = event.target.result;
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                
                                // 计算压缩后的尺寸
                                let width = img.width;
                                let height = img.height;
                                const maxSize = 1920; // 最大尺寸
                                
                                if (width > height && width > maxSize) {
                                    height = Math.round((height * maxSize) / width);
                                    width = maxSize;
                                } else if (height > maxSize) {
                                    width = Math.round((width * maxSize) / height);
                                    height = maxSize;
                                }
                                
                                canvas.width = width;
                                canvas.height = height;
                                
                                // 绘制图片
                                ctx.drawImage(img, 0, 0, width, height);
                                
                                // 转换为Blob
                                canvas.toBlob((blob) => {
                                    // 创建新的File对象
                                    const compressedFile = new File([blob], file.name, {
                                        type: 'image/jpeg',
                                        lastModified: Date.now()
                                    });
                                    resolve(compressedFile);
                                }, 'image/jpeg', 0.7); // 0.7是压缩质量
                            };
                            img.onerror = reject;
                        };
                        reader.onerror = reject;
                    });
                },

                async handleBeforeUpload(file) {
                    this.totalFiles++;
                    this.imagesLoading = ElementPlus.ElLoading.service({
                        lock: true,
                        text: '图片上传中...',
                        background: 'rgba(0, 0, 0, 0.7)'
                    });
                   // console.log('准备上传文件:', file);
                    try {
                        let processedFile = file;
                        if (file.size > 1024 * 1024) {
                            processedFile = await this.compressImage(file);
                        }
                        // 使用时间戳和随机数生成唯一文件名，避免中文路径问题
                        const timestamp = Date.now();
                        const random = Math.random().toString(36).substr(2, 6);
                        const ext = file.name.split('.').pop();
                        const fileName = `${timestamp}_${random}.${ext}`;
                        const path = `products/${this.productForm.id}/${fileName}`;
                        
                        const uploadResponse = await axios.post('/get_uploadfileUrl', {
                            path: path
                        });                 
                        const uploadData = uploadResponse.data;
                        //console.log('获取到上传链接:', uploadData);
                        if (uploadData.errcode !== 0) {
                            throw new Error(uploadData.errmsg);
                        }
                        // 将上传信息存储在Map中，使用文件的uid作为key
                        this.fileUploadInfo.set(file.uid, {
                            ...uploadData,
                            path: path,
                            file: processedFile
                        });

                        return true; // 允许文件被添加到上传列表
                    } catch (error) {
                        console.error('准备上传失败:', error);
                        this.$message.error('文件准备失败：' + error.message);
                        return false;
                    }
                },

                checkUploadComplete() {
                    console.log('this.uploadedFiles:', this.uploadedFiles);
                    console.log('this.totalFiles:', this.totalFiles);
                    if (
                        this.uploadedFiles >= this.totalFiles) {
                        this.$message.success('所有文件上传完成');
                        //this.dialogVisible = false;
                        this.loadProducts();
                    } else {
                        console.log('有图片上传失败');
                    }
                },


                handleUploadSuccess(response, file, fileList) {
                    console.log('上传成功:', response);
                    
                    // 更新文件列表
                    this.fileList = fileList.map(file => {
                        return {
                            name: file.name,
                            url: file.url || (response.url && file.uid === file.uid ? response.url : ''),
                            status: file.status,
                            uid: file.uid
                        };
                    });
                    
                    // 更新商品图片列表
                    if (response.url) {
                        this.uploadedFiles++;
                        if (!this.productForm.images) this.productForm.images = [];
                        this.productForm.images.push(response.url);
                        console.log('文件上传成功:', response.url);
                    }
                    
                    // 检查是否所有文件都上传完成
                    const allFilesUploaded = fileList.every(file => 
                        file.status === 'success' || file.status === 'fail'
                    );
                    
                    if (allFilesUploaded || this.uploadedFiles >= this.totalFiles) {
                        this.closeLoading(); // 所有文件上传完成，关闭 loading
                    }
                    
                    this.checkUploadComplete();
                },


                handlePictureCardPreview(file) {
                    console.log('预览图片:', file);
                    this.dialogImageUrl = this.handleImageUrl(file.url);
                    this.dialogImageVisible = true;
                },

                handleCancel() {
                    // 清空表单
                    this.productForm = {
                        id: '',
                        name: '',
                        price: 0,
                        cost_price: 0,
                        price_b: 0,
                        price_c: 0,
                        price_d: 0,
                        style: 1,
                        colors: ['灰色', '黑色'],
                        specs: [
                            { color: '灰色', stock: 0 },
                            { color: '黑色', stock: 0 }
                        ],
                        images: [],
                        description: '暂时没有',
                        stock: 0,
                        stock_warning: 10,
                        size: '',
                        weight: 0,
                        yarn: '',
                        composition: '',
                        status: 1,
                        is_public: 0

                    };
                    
                    // 清空文件列表
                    if (this.$refs.uploadRef) {
                        this.$refs.uploadRef.clearFiles();
                    }
                    
                    // 重置其他相关状态
                    this.selectedPresetColors = [];
                    this.customColorInput = [];
                    this.customColorOptions = [];
                    
                    // 关闭对话框
                   
                    this.dialogVisible = false;
                    this.loadProducts();
                },

                async submitProduct() {
                    try {
                        await this.$refs.productFormRef.validate(); // 验证表单

                        // 处理规格数据
                        const specs = this.productForm.specs.map(spec => ({
                            color: spec.color,
                            stock: parseInt(spec.stock) || 0,
                            image: spec.image || ''
                        }));

                         //如果有待上传的图片，处理上传

                        const submitData = {
                            id: this.productForm.id,
                            name: this.productForm.name.trim(),
                            description: this.productForm.description.trim(),
                            price: parseFloat(this.productForm.price) || 0,
                            cost_price: parseFloat(this.productForm.cost_price) || 0,
                            price_b: parseFloat(this.productForm.price_b) || 0,
                            price_c: parseFloat(this.productForm.price_c) || 0,
                            price_d: parseFloat(this.productForm.price_d) || 0,
                            specs: specs,
                            images: this.productForm.images || [],
                            type: parseInt(this.productForm.style) || 1,
                            stock: specs.reduce((sum, spec) => sum + (parseInt(spec.stock) || 0), 0),
                            stock_warning: parseInt(this.productForm.stock_warning) || 10,
                            created_at: this.dialogType === 'add' ? new Date().toISOString() : this.productForm.created_at,
                            size: (this.productForm.size || '').trim(),
                            weight: parseFloat(this.productForm.weight) || 0,
                            yarn: (this.productForm.yarn || '').trim(),
                            composition: (this.productForm.composition || '').trim(),
                            status: this.productForm.status,
                            is_public: this.productForm.is_public
                        };
                        const url = `/products`;
                        const method = 'post';
                        const response = await axios[method](url, submitData);
                        

                        if (response.status === 200 || response.status === 201) {
                            ElementPlus.ElMessage.success(this.dialogType === 'add' ? '添加成功' : '更新成功');
                            if (this.dialogType === 'add') {
                            const uploadComponent = this.$refs.uploadRef;
                            this.totalFiles = 0;
                            this.uploadedFiles = 0;
                            console.log('商品创建/更新成功返回:', response.data.product_id);
                            this.tempProductId = response.data.product_id;
                            await new Promise(resolve => setTimeout(resolve, 200));
                            await uploadComponent.submit();   
                            console.log('商品创建/更新成功返回:', this.tempProductId);
                        }
                            this.dialogVisible = false;
                            this.loadProducts();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '保存商品失败');
                    }
                },

                getStyleLabel(styleValue) {
                    const style = this.styleOptions.find(option => option.id === styleValue);
                    return style ? style.name : '未知';
                },
                
                getSpecs(specs) {
                    if (!specs) return [];
                    // 处理可能是字符串的情况
                    if (typeof specs === 'string') {
                        try {
                            return JSON.parse(specs);
                        } catch (e) {
                            return [];
                        }
                    }
                    return Array.isArray(specs) ? specs : [];
                },

                getColors(specs) {
                    const specArray = this.getSpecs(specs);
                    return specArray.map(spec => spec.color);
                },

                handlePresetTagsChange(value) {
                    // 更新预设标签的选中状态
                    this.selectedPresetTags = value;
                    // 合并预设标签和自定义标签，更新到 productForm.tags
                    const customTags = this.productForm.tags.filter(tag => !this.presetTags.includes(tag));
                    this.productForm.tags = [...value, ...customTags];
                },

                handleCustomTagChange(value) {
                    // value 现在包含所有标签（预设和自定义）
                    // 分离预设标签和自定义标签
                    const presetTags = value.filter(tag => this.presetTags.includes(tag));
                    const customTags = value.filter(tag => !this.presetTags.includes(tag));
                    
                    // 更新预设标签的选中状态
                    this.selectedPresetTags = presetTags;
                    
                    // 更新所有标签
                    this.productForm.tags = value;
                },

                handlePresetColorsChange(value) {
                    // 获取当前自定义颜色（非预设颜色）
                    const customColors = this.productForm.colors.filter(
                        color => !this.presetColors.includes(color)
                    );
                    
                    // 合并预设颜色和自定义颜色
                    this.productForm.colors = [...value, ...customColors];

                    // 更新 specs 数组
                    this.productForm.specs = this.productForm.colors.map(color => ({
                        color: color,
                        stock: this.productForm.specs.find(s => s.color === color)?.stock || 0
                    }));

                    // 同步更新 customColorInput
                    this.customColorInput = this.productForm.colors;
                    // 更新自定义颜色选项
                    this.customColorOptions = customColors;
                },

                handleCustomColorChange(value) {
                    // 保持预设颜色的选中状态
                    const selectedPreset = value.filter(color => this.presetColors.includes(color));
                    this.selectedPresetColors = selectedPreset;
                    
                    // 更新商品颜色列表
                    this.productForm.colors = value;

                    // 更新 specs 数组
                    this.productForm.specs = value.map(color => ({
                        color: color,
                        stock: this.productForm.specs.find(s => s.color === color)?.stock || 0
                    }));
                    
                    // 更新自定义颜色选项（只保留非预设颜色）
                    this.customColorOptions = value.filter(
                        color => !this.presetColors.includes(color)
                    );
                },

                formatDate(dateStr) {
                    if (!dateStr) return '';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        }).replace(/\//g, '-');
                    } catch (e) {
                        console.error('日期格式化错误:', e);
                        return dateStr;
                    }
                },

                beforeImportUpload(file) {
                    // 更新上传请求头
                    this.updateUploadHeaders();
                    const isExcel = file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                        file.type === 'application/vnd.ms-excel';
                    if (!isExcel) {
                        ElementPlus.ElMessage.error('只能上传 Excel 文件!');
                        return false;
                    }
                    return true;
                },

                handleImportSuccess(response, uploadFile, uploadFiles) {
                    ElementPlus.ElMessage.success('导入成功');
                    this.loadProducts();  // 重新加载商品列表
                },

                handleImportError(err) {
                    console.error('导入失败:', err);
                    ElementPlus.ElMessage.error('导入失败，请检查文件格式是否正确');
                },

                async downloadTemplate() {
                    try {
                        const response = await axios.get('/static/templates/products_template.xlsx', {
                            responseType: 'blob',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        });
                        // ... 下载处理代码
                    } catch (error) {
                        this.handleAxiosError(error, '下载模板失败');
                    }
                },

                handleSizeChange(newSize) {
                    this.pagination.pageSize = newSize;
                    this.pagination.currentPage = 1;
                this.loadProducts();
                },

                handleCurrentChange(newPage) {
                    this.pagination.currentPage = newPage;
                    this.loadProducts();
                },

                async loadStatistics() {
                    try {
                        const response = await axios.get('/statistics', {
                            params: { range: this.timeRange }
                        });

                        if (response.status === 200) {
                            this.statistics = response.data;
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '加载统计数据失败');
                    }
                },

                async loadUsers() {
                    try {
                        const response = await axios.get('/users', {
                            params: {
                                page: this.userPagination.currentPage,
                                page_size: this.userPagination.pageSize
                            }
                        });

                        if (response.status === 200) {
                            this.users = response.data.users;
                            this.userPagination.total = response.data.total;
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '加载用户列表失败');
                    }
                },

                handleAddUser() {
                    this.userDialogStatus = 'add';
                    this.userForm = {
                        username: '',
                        password: '',
                        confirmPassword: '',
                        nickname: '',
                        phone: '',
                        contact: '',
                        address: ''
                    };
                    this.userDialogVisible = true;
                },

                handleEditUser(user) {
                    this.userDialogStatus = 'edit';
                    this.userForm = { ...user };
                    this.userDialogVisible = true;
                },
                async handleDeleteUser(user) {
                    try {
                        // 确认删除
                        await ElementPlus.ElMessageBox.confirm(
                            `确定要删除用户 "${user.username}" 吗？`,
                            '警告',
                            {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'warning'
                            }
                        );
                        
                        const response = await axios.post('/users/delete', {
                            user_id: user.id
                        });
                        
                        if (response.data.code === 200) {
                            ElementPlus.ElMessage.success('用户删除成功');
                            this.loadUsers();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            if (error.response) {
                                ElementPlus.ElMessage.error(error.response.data.error);
                            } else {
                                ElementPlus.ElMessage.error('删除用户失败');
                            }
                        }
                    }
                },

                async handleToggleUserStatus(user) {
                    try {
                        const newStatus = user.status === 1 ? 0 : 1;
                        const response = await axios.put(`/users/${user.id}`, {
                            ...user,
                            status: newStatus
                        });

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success(newStatus === 1 ? '用户已启用' : '用户已禁用');
                            // 直接修改本地数据
                            user.status = newStatus;
                            // 可选：重新加载用户列表以确保数据同步
                            // await this.loadUsers();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '更新用户状态失败');
                    }
                },

                async submitUserForm() {
                    try {
                        const response = await axios.put(`/users/${this.userForm.id}`, {
                            ...this.userForm,  // 包含所有字段
                            status: parseInt(this.userForm.status)  // 确保状态是数字
                        });

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('更新成功');
                            this.userDialogVisible = false;
                            await this.loadUsers();  // 重新加载列表
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '更新用户信息失败');
                    }
                },

                handleUserSizeChange(newSize) {
                    this.userPagination.pageSize = newSize;
                    this.loadUsers();
                },

                handleUserCurrentChange(newPage) {
                    this.userPagination.currentPage = newPage;
                    this.loadUsers();
                },

                // 获取当前用户信息
                getCurrentUser() {
                    this.getCurrentUserInfo();
                },
                async handleAddUserSubmit() {
                    try {
                        await this.$refs.userFormRef.validate();
                        const response = await axios.post('/register', this.userForm);
                        if (response.data.code === 200) {
                            ElementPlus.ElMessage.success('用户创建成功');
                            this.userDialogVisible = false;
                            this.loadUsers();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '新增用户失败');
                    }
                },

                // 修改获取用户信息的方法
                async getCurrentUserInfo() {
                    try {
                        const response = await axios.get('/user/profile');
                        if (response.status === 200 && response.data.user) {
                            this.userInfo = response.data.user;
                            // 更新本地存储
                            localStorage.setItem('userInfo', JSON.stringify(response.data.user));

                            // 检查是否是管理员
                            if (this.userInfo.user_type != 1 && this.userInfo.user_type != 5) {
                                ElementPlus.ElMessage.error('您没有管理员权限');
                                window.location.href = '/admin/index.html';
                                return;
                            }

                            // 加载初始数据
                            this.loadProducts();
                            this.updateUploadHeaders();  // 初始化 headers
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '获取用户信息失败');
                    }
                },

                // 修改个人信息更新方法
                async submitProfile() {
                    try {
                        await this.$refs.profileFormRef.validate();
                        const response = await axios.put('/user/profile', this.profileForm);

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('个人信息更新成功');
                            this.profileDialogVisible = false;
                            // 更新用户信息
                            if (response.data.user) {
                                this.userInfo = response.data.user;
                                localStorage.setItem('userInfo', JSON.stringify(response.data.user));
                            }
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '更新个人信息失败');
                    }
                },

                // 添加全局错误处理
                handleAxiosError(error, customMessage = '操作失败') {
                    console.group('操作失败详情');
                    console.error('错误信息:', error.message);
                    console.error('错误详情:', error);

                    if (error.response) {
                        console.error('服务器响应:', {
                            status: error.response.status,
                            data: error.response.data
                        });

                        if (error.response.status === 401) {
                            console.warn('Token已过期或无效，准备跳转登录页面');
                            ElementPlus.ElMessage.error('登录已过期，请重新登录');
                            this.handleLogout();
                            return;
                        }
                        ElementPlus.ElMessage.error(error.response.data.error || customMessage);
                    } else {
                        console.error('网络错误或请求被取消');
                        ElementPlus.ElMessage.error('网络错误，请稍后重试');
                    }

                    console.groupEnd();
                },

                // 添加下拉菜单命令处理
                handleCommand(command) {
                    switch (command) {
                        case 'profile':
                            this.showProfileDialog();
                            break;
                        case 'logout':
                            this.handleLogout();
                            break;
                    }
                },

                // 更新 uploadHeaders 的方法
                updateUploadHeaders() {
                    this.uploadHeaders = {
                        Authorization: `Bearer ${localStorage.getItem('token')}`
                    };
                },

                // 显示个人信息编辑对话框
                showProfileDialog() {
                    this.profileForm = { ...this.userInfo };
                    this.profileDialogVisible = true;
                },

                // 获取用户显示信息
                getUserInfo() {
                    return {
                        username: this.userInfo?.username || '',
                        nickname: this.userInfo?.nickname || '',
                        avatar: this.userInfo?.avatar || 'https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png'
                    };
                },

                // 加载采购单列表
                async loadPurchaseOrders() {
                    try {
                        this.purchaseLoading = true;
                        const response = await axios.get('/purchase_orders', {
                            params: {
                                keyword: this.purchaseSearch.keyword
                            }
                        });

                        if (response.status === 200) {
                            this.purchaseOrders = response.data.orders;
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '加载采购单列表失败');
                    } finally {
                        this.purchaseLoading = false;
                    }
                },

                // 搜索采购单
                handlePurchaseSearch() {
                    this.purchasePagination.currentPage = 1;
                    this.loadPurchaseOrders();
                },

                // 获取采购单状态类型
                getPurchaseStatusType(status) {
                    const typeMap = {
                        0: 'info',
                        1: 'warning',
                        2: 'success',
                        3: 'danger'
                    };
                    return typeMap[status] || '';
                },

                // 获取采购单状态文本
                getPurchaseStatusText(status) {
                    const statusMap = {
                        0: '待处理',
                        1: '已确认',
                        2: '已完成',
                        3: '已取消'
                    };
                    return statusMap[status] || '未知状态';
                },

                // 查看采购单详情
                async viewPurchaseDetail(order) {
                    this.purchaseDetailstatus = 'view';

                    try {
                        const response = await axios.get(`/purchase_orders/${order.id}`);
                        if (response.status === 200 && this.purchaseDetailstatus === 'view') {
                            this.currentPurchaseOrder = response.data;
                            this.purchaseDetailVisible = true;
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '获取采购单详情失败');
                    }
                },

                // 接受采购单
                async handleAcceptPurchase(order) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('确定要接受这个采购单吗？');
                        const response = await axios.put(`/purchase_orders/${order.id}/accept`, {
                            status: 1
                        });

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('采购单已接受');
                            this.purchaseDetailVisible = false;
                            this.loadPurchaseOrders();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.handleAxiosError(error, '接受采购单失败');
                        }
                    }
                },

                // 从采购单生成配送单
                async createFromPurchase(purchaseId) {
                    try {
                        const response = await axios.post(`/delivery_orders/from_purchase/${purchaseId}`);
                        if (response.status === 200) {
                            // 使用采购单数据填充配送单表单 
                            ElementPlus.ElMessage.success('配送单生成成功');
                            this.loadDeliveryOrders(); // 刷新配送单列表
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '生成配送单失败');
                    }
                },

                // 取消采购单
                async handleCancelPurchase(order) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('确定要取消这个采购单吗？', '警告', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });

                        const response = await axios.put(`/purchase_orders/${order.id}/cancel`, {
                            status: 2
                        });

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('采购单已取消');
                            this.purchaseDetailVisible = false;
                            this.loadPurchaseOrders();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.handleAxiosError(error, '取消采购单失败');
                        }
                    }
                },

                // 加载配送单列表
                async loadDeliveryOrders() {
                    try {
                        const [ordersResponse, statsResponse] = await Promise.all([
                            axios.get('/delivery_orders', {
                                params: {
                                    page: this.deliveryPagination.currentPage,
                                    page_size: this.deliveryPagination.pageSize,
                                    keyword: this.deliverySearch.keyword,
                                    status: this.deliverySearch.status === 'all' ? '' : this.deliverySearch.status
                                }
                            }),
                            axios.get('/delivery_orders/stats')
                        ]);
                        
                        console.log('配送单列表:', ordersResponse.data);
                        
                        if (ordersResponse.status === 200) {
                            this.deliveryOrders = ordersResponse.data.orders;
                            this.deliveryPagination.total = ordersResponse.data.total;
                        }

                        if (statsResponse.status === 200) {
                            this.deliveryStats = statsResponse.data.data;
                            console.log('配送单统计:', this.deliveryStats);
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '加载配送单列表失败');
                    }
                },

                // 搜索配送单
                handleDeliverySearch() {
                    this.deliveryPagination.currentPage = 1;
                    this.loadDeliveryOrders();
                },

                // 获取配送单状态类型
                getDeliveryStatusType(status) {
                    const types = {
                        0: 'warning',   // 待配送
                        1: 'success',   // 配送中
                        2: 'danger',    // 已完成
                        3: 'info'       // 已取消
                    };
                    return types[status] || 'info';
                },

                // 获取配送单状态文本
                getDeliveryStatusText(status) {
                    const texts = {
                        0: '待配送',
                        1: '配送中',
                        2: '已完成',
                        3: '已取消'
                    };
                    return texts[status] || '未知';
                },

                // 开始配送
                async handleStartDelivery(order) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('确定要开始配送这个配送单吗？');
                        const response = await axios.put(`/delivery_orders/${order.id}/status`, {
                            status: 1
                        });

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('配送单已开始配送');
                            this.loadDeliveryOrders();
                        }   
                    } catch (error) {
                        this.handleAxiosError(error, '开始配送失败');
                    }
                },  

                // 完成配送
                async handleCompleteDelivery(order) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('确定要完成这个配送单吗？');
                        const response = await axios.put(`/delivery_orders/${order.id}/status`, {
                            status: 2
                        });

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('配送单已完成');
                            this.loadDeliveryOrders();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '完成配送失败');
                    }   
                },

                // 查看配送单详情
                async viewDeliveryDetail(order) {
                    try {
                        const response = await axios.get(`/delivery_orders/${order.id}`);
                        if (response.status === 200) {
                            this.currentDeliveryOrder = response.data;
                            this.viewDeliveryVisible = true;
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '获取配送单详情失败');
                    }
                },

                // 接受配送单
                async handleAcceptDelivery(order) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('确定要接受这个配送单吗？');
                        const response = await axios.put(`/delivery_orders/${order.id}/status`, {
                            status: 1
                        });

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('配送单已接受');
                            this.deliveryDetailVisible = false;
                            this.loadDeliveryOrders();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.handleAxiosError(error, '接受配送单失败');
                        }
                    }
                },

                // 删除配送单
                async handleDeleteDelivery(order) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('确定要删除这个配送单吗？', '警告', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });

                        const response = await axios.delete(`/delivery_orders/${order.id}`);
                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('配送单删除成功');
                            this.loadDeliveryOrders();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '删除配送单失败');
                    }
                },

                // 取消配送单
                async handleCancelDelivery(order) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('确定要取消这个配送单吗？', '警告', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });

                        const response = await axios.put(`/delivery_orders/${order.id}/status`, {
                            status: 3
                        });

                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('配送单已取消');
                            this.deliveryDetailVisible = false;
                            this.loadDeliveryOrders();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.handleAxiosError(error, '取消配送单失败');
                        }
                    }
                },            

                // 提交配送单表单
                async submitDeliveryForm() {
                    try {
                        const response = await axios.post('/delivery_orders', this.deliveryForm);
                        if (response.status === 201 || response.status === 200) {
                            ElementPlus.ElMessage.success('配送单已提交成功');
                            this.createDeliveryVisible = false;
                            this.loadDeliveryOrders();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '提交配送单失败');
                    }
                },

                // 显示添加商品对话框
                showAddItemDialog() {
                    this.addItemDialogVisible = true;
                    this.selectedProducts = [];
                },

                // 搜索商品
                async handleItemSearch() {
                    try {
                        const response = await axios.get('/products', {
                            params: {
                                keyword: this.itemSearch.keyword
                            }
                        });
                        if (response.status === 200) {
                            this.searchProducts = response.data.products.map(product => ({
                                ...product,
                                selected_color: '',
                                quantity: 1,
                                colors: this.getSpecs(product.specs).map(spec => spec.color)
                            }));
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '搜索商品失败');
                    }
                },

                // 处理商品选择
                handleProductSelectionChange(selection) {
                    this.selectedProducts = selection;
                },

                // 确认添加商品
                confirmAddItems() {
                    const validProducts = this.selectedProducts.filter(
                        product => product.selected_color && product.quantity > 0
                    );

                    if (validProducts.length === 0) {
                        ElementPlus.ElMessage.warning('请选择商品颜色和数量');
                        return;
                    }

                    const newItems = validProducts.map(product => ({
                        productId: product.id,
                        productName: product.name,
                        color: product.selected_color,
                        quantity: parseInt(product.quantity),
                        productImage: product.image || null
                    }));

                    // 检查是否有重复商品
                    for (const newItem of newItems) {
                        const existingItem = this.deliveryForm.items.find(
                            item => item.productId === newItem.productId && item.color === newItem.color
                        );
                        if (existingItem) {
                            existingItem.quantity += newItem.quantity;
                        } else {
                            this.deliveryForm.items.push(newItem);
                        }
                    }

                    this.addItemDialogVisible = false;
                    this.selectedProducts = [];
                    this.itemSearch.keyword = '';
                    this.searchProducts = [];
                },

                // 移除配送单商品
                removeDeliveryItem(index) {
                    this.deliveryForm.items.splice(index, 1);
                    this.calculateTotal();
                },

                // 处理配送单图像上传
                handleDeliveryImageSuccess(response, file) {
                    // 实现处理配送单图像上传的逻辑
                },

                // 处理配送单图像上传前的逻辑
                beforeDeliveryImageUpload(file) {
                    // 实现处理配送单图像上传前的逻辑
                },

                async handleBatchDelete() {
                    try {
                        await ElementPlus.ElMessageBox.confirm(
                            `确定要删除选中的 ${this.selectedProducts.length} 个商品吗？`,
                            '警告',
                            {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'warning'
                            }
                        );
                        
                        const productIds = this.selectedProducts.map(p => p.id);
                        const response = await axios.post('/products/batch/delete', {
                            product_ids: productIds
                        });
                        
                        if (response.data.code === 200) {
                            ElementPlus.ElMessage.success(response.data.message);
                            this.loadProducts();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.handleAxiosError(error, '批量删除失败');
                        }
                    }
                },
                handleBatchUpdateStock() {
                    this.batchStockDialogVisible = true;
                },
                async confirmBatchUpdateStock() {
                    try {
                        const productIds = this.selectedProducts.map(p => p.id);
                        const response = await axios.post('/products/batch/stock', {
                            product_ids: productIds,
                            mode: this.batchStockForm.mode,
                            value: this.batchStockForm.value
                        });
                        
                        if (response.data.code === 200) {
                            ElementPlus.ElMessage.success(response.data.message);
                            this.batchStockDialogVisible = false;
                            this.loadProducts();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '修改库存失败');
                    }
                },
                calculateTotal() {
                    this.deliveryForm.total_quantity = this.deliveryForm.items.reduce(
                        (sum, item) => sum + item.quantity, 
                        0
                    );
                },
                // 显示采购单列表
                showPurchaseListDialog() {
                    this.purchaseListVisible = true;
                    this.loadPurchaseOrders();
                },
                async loadPushOrders() {
                    try {
                        this.pushLoading = true;
                        const response = await axios.get('/push_orders', {
                            params: {
                                keyword: this.pushSearch.keyword,
                                status: this.pushSearch.status
                            }
                        });
                        if (response.status === 200) {
                            this.pushOrders = response.data.orders;
                            this.pushPagination.total = response.data.total;
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '加载推送单列表失败');
                    } finally {
                        this.pushLoading = false;
                    }
                },
                handlePushSearch() {
                    this.pushPagination.currentPage = 1;
                    this.loadPushOrders();
                },
                handlePushPageChange(page, pageSize) {
                    this.pushPagination.currentPage = page;
                    this.pushPagination.pageSize = pageSize;
                    this.loadPushOrders();
                },
                viewPushDetail(order) {
                    this.pushDetailVisible = true;
                    this.currentPushOrder = order;
                },
                handleInvalidatePush(order) {
                    this.handleAxiosError(new Error('推送单已失效'));
                    this.loadPushOrders();
                },
                handleActivatePush(order) {
                    this.handleAxiosError(new Error('推送单已激活'));
                    this.loadPushOrders();
                },
                handleDeletePush(order) {
                    this.handleAxiosError(new Error('推送单已删除'));
                    this.loadPushOrders();
                },
                getImageUrl(path) {
                    return this.httpsBaseUrl + path;

                },
                // 添加文件大小检查方法
                checkFileSize(file) {
                    const maxSize = 5 * 1024 * 1024; // 5MB 限制
                    if (file.size > maxSize) {
                        this.$message.error('文件大小不能超过5MB');
                        return false;
                    }
                    return true;
                },                
             
                // 处理图片链接
                handleImageUrl(url) {
                    if (!url) return '';
                    try {
                        if (url.startsWith('http')) {
                            return url;
                        }
                    if (url.startsWith('cloud://')) {
                            return url.replace(
                                this.cloudBaseUrl,
                                this.httpsBaseUrl
                            );
                        }
                        return `http://127.0.0.1/${url}`;
                    } catch (error) {
                        console.error('处理图片URL失败:', error);
                        return '';
                    }
                },

                // 修改文件列表的显示方法
                handleFilePreview(file) {
                    const url = this.handleImageUrl(file.url);
                    window.open(url);
                },
               

                // 处理文件变化
                handleFileChange(file, fileList) {
                    console.log('文件改变:', file, fileList);
                    this.fileList = fileList;
                    
                },

                // 处理超出限制
                handleExceed(files, fileList) {
                    this.$message.warning(`最多只能上传 9 张图片`);
                },

                // 提交表单时保存商品信息
                async submitForm() {
                    try {
                        // 更新商品图片列表
                        this.productForm.images = this.fileList.map(file => file.url);
                        
                        // 根据dialogType决定是新增还是编辑
                        if (this.dialogType === 'add') {
                            const response = await axios.post('/products', this.productForm);
                            if (response.status === 200) {
                                this.$message.success('添加商品成功');
                                this.dialogVisible = false;
                                this.loadProducts();
                            }
                    } else {
                            const response = await axios.put(`/products/${this.productForm.id}`, this.productForm);
                            if (response.status === 200) {
                                this.$message.success('更新商品成功');
                                this.dialogVisible = false;
                                this.loadProducts();
                            }
                        }
                    } catch (error) {
                        this.handleAxiosError(error, this.dialogType === 'add' ? '添加商品失败' : '更新商品失败');
                    }
                },
                // 处理文件移除
                async handleRemove(file) {
                    try {
                        const index = this.fileList.indexOf(file);

                        if (index !== -1) {
                            // 从文件列表中移除
                            this.fileList.splice(index, 1);                            
                            // 更新商品图片列表
                            this.productForm.images = this.fileList.map(file => this.httpstocloud(file.url));

                            
                            // 如果是编辑模式，直接更新商品信息
                            if (this.dialogType === 'edit' && this.productForm.id) {
                                const specs = this.productForm.specs.map(spec => ({
                                    color: spec.color,
                                    stock: parseInt(spec.stock) || 0
                                }));
                                
                                const submitData = {
                                    id: this.productForm.id,
                                    name: this.productForm.name.trim(),
                                    description: this.productForm.description.trim(),
                                    price: parseFloat(this.productForm.price) || 0,
                                    cost_price: parseFloat(this.productForm.cost_price) || 0,
                                    price_b: parseFloat(this.productForm.price_b) || 0,
                                    price_c: parseFloat(this.productForm.price_c) || 0,
                                    price_d: parseFloat(this.productForm.price_d) || 0,
                                    specs: specs,
                                    images: this.productForm.images,
                                    type: parseInt(this.productForm.style) || 1,
                                    stock: specs.reduce((sum, spec) => sum + (parseInt(spec.stock) || 0), 0),
                                    stock_warning: parseInt(this.productForm.stock_warning) || 10,
                                    size: (this.productForm.size || '').trim(),
                                    weight: parseFloat(this.productForm.weight) || 0,
                                    yarn: (this.productForm.yarn || '').trim(),
                                    composition: (this.productForm.composition || '').trim()

                                };
                                console.log('提交数据:', submitData.images);
                                const response = await axios.post(`/products`, submitData);
                                if (response.status === 200) {
                                    this.$message.success('删除图片成功');

                                }
                            }
                        }
                    } catch (error) {
                        this.$message.error('删除图片失败：' + error.message);
                        // 如果删除失败，恢复文件列表
                        this.fileList = [...this.fileList, file];
                        this.productForm.images = this.fileList.map(file => file.url);
                    }
                },
                async customUpload({ file }) {
                    try {
                        const uploadInfo = this.fileUploadInfo.get(file.uid);
                        if (!uploadInfo) {
                            ElementPlus.ElMessage.error('未找到文件上传信息');
                            throw new Error('未找到文件上传信息');
                        }
                        const formData = new FormData();
                        formData.append('key', uploadInfo.path);
                        formData.append('Signature', uploadInfo.authorization);
                        formData.append('x-cos-security-token', uploadInfo.token);
                        formData.append('x-cos-meta-fileid', uploadInfo.cos_file_id);
                        formData.append('file', file);
                        const response = await axios.post(uploadInfo.url, formData);
                        console.log('上传成功:', response);

                        // 构建完整的文件URL
                        const fileUrl = `${this.httpsBaseUrl}/${uploadInfo.path}`;
                        
                        // 清理该文件的上传信息
                        this.fileUploadInfo.delete(file.uid);
                        
                        // 更新productForm.images数组
                        if (!this.productForm.images) { this.productForm.images = []; }
                        this.productForm.images.push(uploadInfo.file_id);
                        
                        // 同步更新fileList
                        const fileIndex = this.fileList.findIndex(item => item.uid === file.uid);
                        if (fileIndex > -1) {
                            this.fileList[fileIndex].url = fileUrl;
                            this.fileList[fileIndex].status = 'success';
                        } else {
                            this.fileList.push({
                                name: file.name,
                                url: fileUrl,
                                status: 'success',
                                uid: file.uid
                            });
                        }
                        
                        if (this.productForm.id) {
                            this.tempProductId = this.productForm.id;
                        }
                        if (this.tempProductId) {
                            const productsResponse = await axios.post('/products', {
                                id: this.tempProductId,  // 商品ID
                                images: this.productForm.images  // 图片列表
                            });
                            
                            if (productsResponse.status === 200 || productsResponse.status === 201) {
                                console.log('更新商品图片成功:', productsResponse);   
                                this.uploadedFiles++;
                                console.log('已上传文件数:', this.uploadedFiles);
                                if (this.uploadedFiles >= this.totalFiles) {
                                    this.imagesLoading.close();
                                    this.loadProducts();
                                }
                                ElementPlus.ElMessage.success('图片上传成功');
                            }
                        } else {
                            ElementPlus.ElMessage.error('未找到商品ID');
                            
                            throw new Error('未找到商品ID');
                        }
                        
                        console.log('上传成功:', fileUrl);
                        return {
                            url: fileUrl // 返回完整的文件URL
                        };
                    } catch (error) {
                        console.error('上传失败:', error);
                        ElementPlus.ElMessage.error('图片上传失败：' + error.message);
                        throw error;
                    }
                },
                handleFilterChange() {
                    this.pagination.currentPage = 1; // 重置到第一页
                    this.loadProducts();
                },
                handleDialogClose() {
                    this.loadProducts(); // 刷新商品列表数据
                    this.fileList = []; // 清空文件列表
                    this.productForm = { // 重置表单
                        size: '',
                        weight: 0,
                        yarn: '',
                        composition: '',
                        specs: [],
                        status: 1,
                        is_public: 0
                    };
                },
                showBatchStyleDialog() {
                    console.log('打开批量修改款式对话框');
                    this.batchStyleDialogVisible = true;
                    this.batchStyleForm.type = '';
                },
                async handleBatchStyleUpdate() {
                    if (!this.batchStyleForm.type) {
                        ElementPlus.ElMessage.warning('请选择款式');
                        return;
                    }
                    const loading = ElementPlus.ElLoading.service({
                        lock: true,
                        text: '正在更新...',
                        background: 'rgba(0, 0, 0, 0.7)'
                    });
                    try {
                        const productIds = this.selectedProducts.map(product => product.id);
                        const response = await axios.post('/products/batch-update', {
                            ids: productIds,
                            type: this.batchStyleForm.type
                        });
                        
                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('批量更新成功');
                            this.batchStyleDialogVisible = false;
                            this.loadProducts();
                            this.$refs.productTable.clearSelection();
                        }
                    } catch (error) {
                        console.error('批量更新失败:', error);
                        ElementPlus.ElMessage.error('批量更新失败：' + error.message);
                    } finally {
                        loading.close();
                    }
                },
                handleSelectionChange(selection) {
                    console.log('选中的商品：', selection);
                    this.selectedProducts = selection;
                },
                // 系统管理相关方法
                showSystemSettings() {
                    this.loadSystemSettings().then(() => {
                        this.systemSettingsVisible = true;
                    }).catch(error => {
                        this.$message.error('加载系统设置失败：' + error.message);
                    });
                },
                closeSystemSettings() {
                    this.systemSettingsVisible = false;
                    // 延迟一段时间再重置数据，确保对话框已完全关闭
                    setTimeout(() => {
                        this.systemSettings = {};
                    }, 300);
                },
                async loadSystemSettings() {
                    try {
                        const response = await axios.get('/system/settings');
                        if (response.status === 200) {
                            this.systemSettings = response.data.settings || {};
                            return Promise.resolve(this.systemSettings);
                        }
                        return Promise.reject(new Error('加载系统设置失败'));
                    } catch (error) {
                        console.error('加载系统设置失败:', error);
                        return Promise.reject(error);
                    }
                },
                async saveSystemSettings() {
                    try {
                        const response = await axios.post('/system/settings', this.systemSettings);
                        if (response.status === 200) {
                            this.$message.success('保存成功');
                            this.systemSettingsVisible = false;
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '保存系统设置失败');
                    }
                },
                // 商品款式管理
                showStyleSettings() {
                    this.styleSettingsVisible = true;
                    this.loadStyleSettings();
                },
                async loadStyleSettings() {
                    try {
                        const response = await axios.get('/system/settings');
                        if (response.status === 200) {
                            this.product_types = response.data.product_types || [];
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '加载款式设置失败');
                    }
                },
                async saveStyleSettings() {
                    try {
                        const response = await axios.put('/system/settings', {
                            product_types: this.product_types
                        });
                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('保存成功');
                            this.styleSettingsVisible = false;
                            // 重新加载款式选项
                            await this.loadStyleOptions();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '保存款式设置失败');
                    }
                },
                handleAddStyle() {
                    const maxId = Math.max(...this.product_types.map(type => type.id), 0);
                    this.product_types.push({
                        id: maxId + 1,
                        name: ''
                    });
                },
                handleRemoveStyle(index) {
                    this.product_types.splice(index, 1);
                },
                // 移动款式位置
                moveStyle(index, direction) {
                    if (direction === 'up' && index > 0) {
                        // 上移
                        const temp = this.product_types[index];
                        this.product_types[index] = this.product_types[index - 1];
                        this.product_types[index - 1] = temp;
                    } else if (direction === 'down' && index < this.product_types.length - 1) {
                        // 下移
                        const temp = this.product_types[index];
                        this.product_types[index] = this.product_types[index + 1];
                        this.product_types[index + 1] = temp;
                    }
                },
                // 加载款式选项
                async loadStyleOptions() {
                    try {
                        const response = await axios.get('/system/settings');
                        if (response.status === 200) {
                            this.styleOptions = response.data.product_types || [];
                            this.styleOptions.unshift({
                                id: null,
                                name: '全部'
                            });
                            console.log('加载款式选项成功:', this.styleOptions);
                        }
                    } catch (error) {
                        console.error('加载款式选项失败:', error);
                        this.handleAxiosError(error, '加载款式选项失败');
                    }
                },
                // 上传成功的回调
                handleUploadSuccess(response, file, fileList) {
                    console.log('上传成功:', response);
                    this.fileList = fileList;
                    
                    // 检查是否所有文件都上传完成
                    const allFilesUploaded = fileList.every(file => 
                        file.status === 'success' || file.status === 'fail'
                    );
                    
                    if (allFilesUploaded) {
                        this.closeLoading(); // 所有文件上传完成，关闭 loading
                    }
                },
                // 上传出错的回调
                handleUploadError(error, file, fileList) {
                    console.error('上传出错:', error);
                    this.$message.error('上传失败');
                    
                    // 检查是否所有文件都处理完成
                    const allFilesProcessed = fileList.every(file => 
                        file.status === 'success' || file.status === 'fail'
                    );
                    
                    if (allFilesProcessed) {
                        this.closeLoading(); // 所有文件处理完成，关闭 loading
                    }
                },
                // 显示 loading
                showLoading() {
                    this.imagesLoading = ElementPlus.ElLoading.service({
                        lock: true,
                        text: '图片上传中...',
                        background: 'rgba(0, 0, 0, 0.7)'
                    });
                },
                
                // 关闭 loading
                closeLoading() {
                    if (this.imagesLoading) {
                        this.imagesLoading.close();
                        this.imagesLoading = null;
                    }
                },
                onImageLoad(e) {
                   // console.log('图片加载完成', e);
                },
                // 更新筛选选项
                updateFilters() {
                    // 获取所有不重复的尺寸
                    const sizes = new Set(this.products.map(p => p.size).filter(Boolean));
                    this.sizeFilters = Array.from(sizes).map(size => ({ text: size, value: size }));

                    // 获取所有不重复的克重并排序
                    const weights = new Set(this.products.map(p => p.weight).filter(Boolean));
                    this.weightFilters = Array.from(weights).sort((a, b) => a - b)
                        .map(weight => ({ text: `${weight}g`, value: weight }));

                    // 获取所有不重复的材质
                    const yarns = new Set(this.products.map(p => p.yarn).filter(Boolean));
                    this.yarnFilters = Array.from(yarns).map(yarn => ({ text: yarn, value: yarn }));

                    // 获取所有不重复的成分
                    const compositions = new Set(this.products.map(p => p.composition).filter(Boolean));
                    this.compositionFilters = Array.from(compositions).map(comp => ({ text: comp, value: comp }));
                },

                // 款式筛选方法
                filterType(value, row) {
                    return row.type === value;
                },

                // 尺寸筛选方法
                filterSize(value, row) {
                    return row.size === value;
                },

                // 克重筛选方法
                filterWeight(value, row) {
                    return row.weight === value;
                },

                // 材质筛选方法
                filterYarn(value, row) {
                    return row.yarn === value;
                },

                // 成分筛选方法
                filterComposition(value, row) {
                    return row.composition === value;
                },

                // 加载筛选选项
                async loadFilterOptions() {
                    try {
                        const response = await axios.get('/products/filter-options');
                        if (response.data.code === 0) {
                            // 为每个筛选选项添加"全部"选项
                            this.filterOptions = {
                                sizes: [{ text: '全部', value: null }, ...response.data.data.sizes],
                                weights: [{ text: '全部', value: null }, ...response.data.data.weights],
                                yarns: [{ text: '全部', value: null }, ...response.data.data.yarns],
                                compositions: [{ text: '全部', value: null }, ...response.data.data.compositions]
                            };
                            console.log( "规格筛选值：",this.filterOptions);
                        }
                    } catch (error) {
                        console.error('加载筛选选项失败:', error);
                        ElementPlus.ElMessage.error('加载筛选选项失败');
                    }
                },

                // 筛选方法
                filterHandler(value, row, column) {
                    const property = column.property;
                    if (!value) return true;
                    return row[property] === value;
                },

                // 重置筛选
                resetFilters() {
                    this.$refs.productTable.clearFilter();
                    this.loadProducts();
                },

                // 重置特定筛选条件
                resetSpecificFilter(filterType) {
                    this.selectedFilters[filterType] = null;
                    this.filterVisible[filterType] = false;
                    this.handleProductSearch();
                },

                // 处理筛选搜索
                handleProductSearch() {
                    // 更新筛选条件
                    this.productFilter.type = this.selectedFilters.type;
                    this.productFilter.size = this.selectedFilters.size;
                    this.productFilter.weight = this.selectedFilters.weight;
                    this.productFilter.yarn = this.selectedFilters.yarn;
                    this.productFilter.composition = this.selectedFilters.composition;
                    // 关闭所有筛选弹窗
                    Object.keys(this.filterVisible).forEach(key => {
                        this.filterVisible[key] = false;
                    });
                    
                    // 重置到第一页
                    this.productFilter.page = 1;
                    // 重新加载数据
                    this.loadProducts();
                },
                selectColorImage(colorIndex) {
                    this.currentColorIndex = colorIndex;
                    this.selectedImageUrl = this.productForm.colors[colorIndex].imageUrl || '';
                    this.colorImageDialogVisible = true;
                },

                selectImage(file) {
                    this.selectedImageUrl = file.url;
                    this.confirmColorImage();
                },

                confirmColorImage() {
                    
                    if (this.currentColorIndex >= 0 && this.selectedImageUrl) {
                        // 替换图片URL中的域名
                        if (this.selectedImageUrl.startsWith(this.httpsBaseUrl)) {
                            this.selectedImageUrl = this.httpstocloud(this.selectedImageUrl);
                        }
                        this.productForm.specs[this.currentColorIndex].image = this.selectedImageUrl;
                    }

                    console.log('确认颜色图片', this.productForm.specs);
                    this.colorImageDialogVisible = false;
                    this.currentColorIndex = -1;
                    this.selectedImageUrl = '';
                },

                cloudtohttps(url) {
                    return url.replace(
                        this.cloudBaseUrl,
                        this.httpsBaseUrl
                    );
                },
                httpstocloud(url) {
                    return url.replace(
                        this.httpsBaseUrl,
                        this.cloudBaseUrl
                    );
                },

                removeColorImage(colorIndex) {
                    this.productForm.colors[colorIndex].imageUrl = '';
                },
                handleColorImageClick(index) {
                    this.currentColorIndex = index;
                    this.selectedImageUrl = this.productForm.specs[index].image || '';
                    this.colorImageDialogVisible = true;
                },
                toggleEditMode() {
                    this.isEditMode = !this.isEditMode;
                },

                async handleSpecsSave(row) {
                    try {

                        const response = await axios.post(`/products`, {
                            id: row.id,
                            size: row.size || '',
                            weight: row.weight || null,
                            yarn: row.yarn || '',
                            composition: row.composition || '',                           
                        });
                        console.log('保存规格', response);

                        if (response.status === 200) {
                            this.$message.success('保存成功');
                        } else {
                            this.$message.error(response.data.message || '保存失败');
                            await this.loadProducts();
                        }
                    } catch (error) {
                        console.error('保存失败:', error);
                        this.$message.error('保存失败');
                        await this.loadProducts();
                    }
                },
                
                // 初始化拖拽排序功能
                initSortable() {
                    this.$nextTick(() => {
                        const el = document.querySelector('.el-upload-list--picture-card');
                        if (el) {
                            this.sortable = Sortable.create(el, {
                                animation: 150,
                                ghostClass: 'sortable-ghost',
                                onEnd: (evt) => {
                                    // 更新文件列表顺序
                                    const itemEl = evt.item;
                                    const newIndex = evt.newIndex;
                                    const oldIndex = evt.oldIndex;
                                    
                                    if (newIndex !== oldIndex) {
                                        // 从旧位置移除，在新位置插入
                                        const movedItem = this.fileList.splice(oldIndex, 1)[0];
                                        this.fileList.splice(newIndex, 0, movedItem);
                                        
                                        // 更新预览图片列表
                                        this.previewSrcList = this.fileList.map(file => file.url);
                                        
                                        // 更新表单数据中的图片顺序
                                        if (this.productForm.images) {
                                            this.productForm.images = this.fileList.map(file => file.url);
                                        }
                                        
                                        ElementPlus.ElMessage.success('图片顺序已更新');
                                    }
                                }
                            });
                        }
                    });
                },
                async handleBeforeVideoUpload(file) {
                    // 检查文件类型
                    const isVideo = ['video/mp4', 'video/quicktime', 'video/avi', 'video/webm'].includes(file.type);
                    if (!isVideo) {
                        ElementPlus.ElMessage.error('请上传MP4/MOV/AVI/WebM格式的视频');
                        return false;
                    }
                    
                    // 检查文件大小 (50MB)
                    const isLessThan50MB = file.size / 1024 / 1024 < 50;
                    if (!isLessThan50MB) {
                        ElementPlus.ElMessage.error('视频大小不能超过50MB');
                        return false;
                    }
                    
                    this.imagesLoading = ElementPlus.ElLoading.service({
                        lock: true,
                        text: '视频上传中...',
                        background: 'rgba(0, 0, 0, 0.7)'
                    });
                    
                    try {
                        // 使用时间戳和随机数生成唯一文件名
                        const timestamp = Date.now();
                        const random = Math.random().toString(36).substr(2, 6);
                        const ext = file.name.split('.').pop();
                        const fileName = `${timestamp}_${random}.${ext}`;
                        const path = `videos/${fileName}`;
                        
                        const uploadResponse = await axios.post('/get_uploadfileUrl', {
                            path: path
                        });
                        
                        const uploadData = uploadResponse.data;
                        if (uploadData.errcode !== 0) {
                            throw new Error(uploadData.errmsg);
                        }
                        
                        // 存储上传信息
                        this.fileUploadInfo.set(file.uid, {
                            ...uploadData,
                            path: path,
                            file: file
                        });
                        
                        return true;
                    } catch (error) {
                        console.error('准备视频上传失败:', error);
                        ElementPlus.ElMessage.error('视频准备失败：' + error.message);
                        if (this.imagesLoading) {
                            this.imagesLoading.close();
                        }
                        return false;
                    }
                },
                
                async customVideoUpload({ file }) {
                    try {
                        const uploadInfo = this.fileUploadInfo.get(file.uid);
                        if (!uploadInfo) {
                            ElementPlus.ElMessage.error('未找到视频上传信息');
                            throw new Error('未找到视频上传信息');
                        }
                        
                        const formData = new FormData();
                        formData.append('key', uploadInfo.path);
                        formData.append('Signature', uploadInfo.authorization);
                        formData.append('x-cos-security-token', uploadInfo.token);
                        formData.append('x-cos-meta-fileid', uploadInfo.cos_file_id);
                        formData.append('file', file);
                        
                        const response = await axios.post(uploadInfo.url, formData);
                        
                        // 构建完整的文件URL
                        const fileUrl = `${this.httpsBaseUrl}/${uploadInfo.path}`;
                        
                        // 清理该文件的上传信息
                        this.fileUploadInfo.delete(file.uid);
                        
                        // 更新产品表单
                        this.productForm.video_url = uploadInfo.file_id;
                        this.videoPreviewUrl = fileUrl;
                        
                        // 同步更新videoFileList
                        this.videoFileList = [{
                            name: file.name,
                            url: fileUrl,
                            status: 'success',
                            uid: file.uid
                        }];
                        
                        // 如果是编辑模式并且已有商品ID，更新商品信息
                        if (this.productForm.id) {
                            await axios.post('/products', {
                                id: this.productForm.id,
                                video_url: this.productForm.video_url
                            });
                        }
                        
                        if (this.imagesLoading) {
                            this.imagesLoading.close();
                        }
                        
                        ElementPlus.ElMessage.success('视频上传成功');
                        
                        return {
                            url: fileUrl
                        };
                    } catch (error) {
                        console.error('视频上传失败:', error);
                        ElementPlus.ElMessage.error('视频上传失败：' + error.message);
                        if (this.imagesLoading) {
                            this.imagesLoading.close();
                        }
                        throw error;
                    }
                },
                
                handleVideoUploadSuccess(response, file) {
                    this.videoPreviewUrl = response.url;
                    this.videoFileList = [file];
                },
                
                handleVideoRemove() {
                    this.videoPreviewUrl = '';
                    this.productForm.video_url = '';
                    this.videoFileList = [];
                },
                
                removeVideo() {
                    this.handleVideoRemove();
                    ElementPlus.ElMessage.success('视频已删除');
                },
                
                openVideoPreview() {
                    this.videoDialogVisible = true;
                },
                
                // 修改商品编辑方法，加载视频信息
                handleEdit(row) {
                    this.dialogType = 'edit';
                    this.editingProductId = row.id;
                    
                    // 解析数据
                    const images = typeof row.images === 'string' ? JSON.parse(row.images) : (row.images || []);
                    const specs = typeof row.specs === 'string' ? JSON.parse(row.specs) : (row.specs || []);
                    const tags = typeof row.tags === 'string' ? JSON.parse(row.tags) : (row.tags || []);
                    
                    // 设置文件列表
                    this.fileList = images.map(url => ({
                        name: url.split('/').pop(),
                        url: this.handleImageUrl(url),
                        status: 'success'
                    }));
                    
                    // 更新预览图片列表
                    this.previewSrcList = this.fileList.map(file => file.url);
                    
                    // 处理视频文件
                    if (row.video_url) {
                        const videoUrl = this.handleImageUrl(row.video_url);
                        this.videoPreviewUrl = videoUrl;
                        this.videoFileList = [{
                            name: row.video_url.split('/').pop(),
                            url: videoUrl,
                            status: 'success'
                        }];
                    } else {
                        this.videoPreviewUrl = '';
                        this.videoFileList = [];
                    }
                    
                    // 设置表单数据
                    this.productForm = {
                        id: row.id,
                        name: row.name,
                        price: parseFloat(row.price) || 0,
                        cost_price: parseFloat(row.cost_price) || 0,
                        price_b: parseFloat(row.price_b) || 0,
                        price_c: parseFloat(row.price_c) || 0,
                        price_d: parseFloat(row.price_d) || 0,
                        description: row.description || '',
                        style: parseInt(row.type) || 1,
                        colors: specs.map(spec => spec.color),  // 提取颜色列表
                        specs: specs,  // 保存完整的规格数据（包含库存）
                        tags: tags,
                        images: images,
                        video_url: row.video_url || '',
                        stock: parseInt(row.stock) || 0,
                        stock_warning: parseInt(row.stock_warning) || 10,
                        created_at: row.created_at,
                        size: row.size || '',
                        weight: parseFloat(row.weight) || 0,
                        yarn: row.yarn || '',
                        composition: row.composition || '',
                        status: row.status || 1,
                        is_public: row.is_public || 0
                    };

                    // 解析标签数据
                    const uniqueTags = [...new Set(tags)];
                    
                    // 更新预设标签的选中状态
                    this.selectedPresetTags = uniqueTags.filter(tag => this.presetTags.includes(tag));
                    
                    // 设置预设颜色的选中状态
                    this.selectedPresetColors = specs
                        .map(spec => spec.color)
                        .filter(color => this.presetColors.includes(color));

                    // 设置自定义颜色
                    this.customColorInput = specs.map(spec => spec.color);
                    this.customColorOptions = specs
                        .map(spec => spec.color)
                        .filter(color => !this.presetColors.includes(color));

                    // 直接设置所有标签到 productForm.tags
                    this.productForm.tags = uniqueTags;

                    // 最后再打开对话框
                    this.$nextTick(() => {
                        this.dialogVisible = true;
                        // 延迟初始化排序功能，确保DOM已更新
                        setTimeout(() => {
                            this.initSortable();
                        }, 300);
                    });
                },
                
                // 修改商品添加对话框初始化方法，重置视频相关字段
                showAddProductDialog() {
                    this.dialogType = 'add';
                    this.productForm = {
                        id: '',
                        name: '',
                        price: 0,
                        cost_price: 0,
                        price_b: 0,
                        price_c: 0,
                        price_d: 0,
                        style: 1,
                        colors: ['灰色', '黑色'],  // 默认颜色
                        specs: [                 // 初始化 specs 数组
                            { color: '灰色', stock: 0 },
                            { color: '黑色', stock: 0 }
                        ],
                        images: [],
                        video_url: '',
                        description: '暂时没有',
                        stock: 0,
                        stock_warning: 10,
                        size: '',               // 尺寸
                        weight: 0,              // 克重
                        yarn: '',               // 材质
                        composition: '',         // 成分
                        status: 1,          // 默认上架
                        is_public: 0            // 默认私密
                    };
                    // 清空文件列表
                    if (this.$refs.uploadRef) {
                        this.$refs.uploadRef.clearFiles();
                    }
                    // 清空视频文件
                    this.videoPreviewUrl = '';
                    this.videoFileList = [];
                    
                    this.dialogVisible = true;
                    this.selectedPresetColors = [];
                    this.customColorInput = [];
                    this.customColorOptions = [];
                    
                    // 延迟初始化排序功能，确保DOM已更新
                    setTimeout(() => {
                        this.initSortable();
                    }, 300);
                },
                
                // 修改提交方法，添加视频URL
                async submitProduct() {
                    try {
                        await this.$refs.productFormRef.validate(); // 验证表单

                        // 处理规格数据
                        const specs = this.productForm.specs.map(spec => ({
                            color: spec.color,
                            stock: parseInt(spec.stock) || 0,
                            image: spec.image || ''
                        }));

                        const submitData = {
                            id: this.productForm.id,
                            name: this.productForm.name.trim(),
                            description: this.productForm.description.trim(),
                            price: parseFloat(this.productForm.price) || 0,
                            cost_price: parseFloat(this.productForm.cost_price) || 0,
                            price_b: parseFloat(this.productForm.price_b) || 0,
                            price_c: parseFloat(this.productForm.price_c) || 0,
                            price_d: parseFloat(this.productForm.price_d) || 0,
                            specs: specs,
                            images: this.productForm.images || [],
                            video_url: this.productForm.video_url || '',
                            type: parseInt(this.productForm.style) || 1,
                            stock: specs.reduce((sum, spec) => sum + (parseInt(spec.stock) || 0), 0),
                            stock_warning: parseInt(this.productForm.stock_warning) || 10,
                            created_at: this.dialogType === 'add' ? new Date().toISOString() : this.productForm.created_at,
                            size: (this.productForm.size || '').trim(),
                            weight: parseFloat(this.productForm.weight) || 0,
                            yarn: (this.productForm.yarn || '').trim(),
                            composition: (this.productForm.composition || '').trim(),
                            status: this.productForm.status,
                            is_public: this.productForm.is_public
                        };
                        
                        const url = `/products`;
                        const method = 'post';
                        const response = await axios[method](url, submitData);
                        

                        if (response.status === 200 || response.status === 201) {
                            ElementPlus.ElMessage.success(this.dialogType === 'add' ? '添加成功' : '更新成功');
                            if (this.dialogType === 'add') {
                                const uploadComponent = this.$refs.uploadRef;
                                this.totalFiles = 0;
                                this.uploadedFiles = 0;
                                console.log('商品创建/更新成功返回:', response.data.product_id);
                                this.tempProductId = response.data.product_id;
                                await new Promise(resolve => setTimeout(resolve, 200));
                                await uploadComponent.submit();   
                                console.log('商品创建/更新成功返回:', this.tempProductId);
                            }
                            this.dialogVisible = false;
                            this.loadProducts();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '保存商品失败');
                    }
                },
                showRecommendedProducts() {
                    this.recommendedProductsVisible = true;
                    this.loadRecommendedProducts();
                },
                async loadRecommendedProducts() {
                    try {
                        const response = await axios.get('/recommended/products');
                        if (response.data.code === 0) {
                            this.recommendedProducts = response.data.data || [];
                            console.log('推荐商品列表:', this.recommendedProducts);
                        } else {
                            this.$message.error('加载推荐商品失败: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('加载推荐商品失败:', error);
                        this.$message.error('加载推荐商品失败');
                    }
                },
                async searchProductsForRecommended() {
                    if (!this.recommendedSearch.keyword.trim()) {
                        this.$message.warning('请输入搜索关键词');
                        return;
                    }
                    
                    try {
                        const response = await axios.get('/products', {
                            params: {
                                keyword: this.recommendedSearch.keyword,
                                page: 1,
                                page_size: 10
                            }
                        });
                        console.log('搜索商品结果:', response.data);
                        
                        if (response.status === 200) {
                            this.searchProductsResults = response.data.products || [];
                            if (this.searchProductsResults.length === 0) {
                                this.$message.info('未找到相关商品');
                            }
                        }
                    } catch (error) {
                        console.error('搜索商品失败:', error);
                        this.$message.error('搜索商品失败');
                    }
                },
                isProductRecommended(productId) {
                    return this.recommendedProducts.some(p => p.id === productId);
                },
                async addToRecommended(product) {
                    if (this.isProductRecommended(product.id)) {
                        this.$message.warning('该商品已经在推荐列表中');
                        return;
                    }
                    
                    try {
                        // 构建新的推荐列表
                        const newRecommendedList = [...this.recommendedProducts, product];
                        const productIds = newRecommendedList.map(p => p.id);
                        
                        const response = await axios.post('/recommended/products', {
                            product_ids: productIds
                        });
                        
                        if (response.data.code === 0) {
                            this.$message.success('添加推荐商品成功');
                            await this.loadRecommendedProducts();
                            // 清空搜索结果
                            this.recommendedSearch.keyword = '';
                            this.searchProductsResults = [];
                        } else {
                            this.$message.error('添加推荐商品失败: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('添加推荐商品失败:', error);
                        this.$message.error('添加推荐商品失败');
                    }
                },
                async moveRecommendedProduct(index, direction) {
                    if (direction === 'up' && index > 0) {
                        // 向上移动
                        const temp = this.recommendedProducts[index];
                        this.recommendedProducts[index] = this.recommendedProducts[index - 1];
                        this.recommendedProducts[index - 1] = temp;
                    } else if (direction === 'down' && index < this.recommendedProducts.length - 1) {
                        // 向下移动
                        const temp = this.recommendedProducts[index];
                        this.recommendedProducts[index] = this.recommendedProducts[index + 1];
                        this.recommendedProducts[index + 1] = temp;
                    } else {
                        return; // 无效的移动
                    }
                    
                    // 保存新的顺序
                    await this.saveRecommendedProducts();
                },
                async removeFromRecommended(index) {
                    try {
                        // 构建新的推荐列表
                        const newRecommendedList = [...this.recommendedProducts];
                        newRecommendedList.splice(index, 1);
                        
                        const productIds = newRecommendedList.map(p => p.id);
                        
                        const response = await axios.post('/recommended/products', {
                            product_ids: productIds
                        });
                        
                        if (response.data.code === 0) {
                            this.$message.success('移除推荐商品成功');
                            await this.loadRecommendedProducts();
                        } else {
                            this.$message.error('移除推荐商品失败: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('移除推荐商品失败:', error);
                        this.$message.error('移除推荐商品失败');
                    }
                },
                async saveRecommendedProducts() {
                    try {
                        const productIds = this.recommendedProducts.map(p => p.id);
                        
                        const response = await axios.post('/recommended/products', {
                            product_ids: productIds
                        });
                        
                        if (response.data.code === 0) {
                            this.$message.success('更新推荐商品顺序成功');
                        } else {
                            this.$message.error('更新推荐商品顺序失败: ' + response.data.message);
                            // 如果失败，重新加载列表
                            await this.loadRecommendedProducts();
                        }
                    } catch (error) {
                        console.error('更新推荐商品顺序失败:', error);
                        this.$message.error('更新推荐商品顺序失败');
                        // 如果失败，重新加载列表
                        await this.loadRecommendedProducts();
                    }
                },
                // 添加处理状态变更的方法
                async handleStatusChange(row, field) {
                    try {
                        const response = await axios.post(`/products`, {
                            id: row.id,
                            [field]: row[field] === 1 ? 0 : 1
                        });
                        
                        if (response.status === 200) {
                            ElementPlus.ElMessage.success('状态更新成功');
                            this.loadProducts();
                        } else {
                            ElementPlus.ElMessage.error('状态更新失败');
                            // 更新失败时恢复原状态
                            row[field] = row[field] === 1 ? 0 : 1;
                        }
                    } catch (error) {
                        console.error('状态更新失败:', error);
                        ElementPlus.ElMessage.error('状态更新失败');
                        // 更新失败时恢复原状态
                        row[field] = row[field] === 1 ? 0 : 1;
                    }
                },
                handleBatchCommand(command) {
                    switch(command) {
                        case 'delete':
                            this.handleBatchDelete();
                            break;
                        case 'style':
                            this.showBatchStyleDialog();
                            break;
                        case 'status':
                            this.batchStatusDialogVisible = true;
                            break;
                        case 'public':
                            this.batchPublicDialogVisible = true;
                            break;
                    }
                },

                async handleBatchStatusUpdate() {
                    try {
                        const productIds = this.selectedProducts.map(p => p.id);
                        const response = await axios.post('/products/batch/status', {
                            product_ids: productIds,
                            status: this.batchStatusForm.status
                        });
                        
                        if (response.data.code === 200) {
                            ElementPlus.ElMessage.success('批量更新状态成功');
                            this.batchStatusDialogVisible = false;
                            this.loadProducts();
                            this.$refs.productTable.clearSelection();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '批量更新状态失败');
                    }
                },

                async handleBatchPublicUpdate() {
                    try {
                        const productIds = this.selectedProducts.map(p => p.id);
                        const response = await axios.post('/products/batch/public', {
                            product_ids: productIds,
                            is_public: this.batchPublicForm.is_public
                        });
                        
                        if (response.data.code === 200) {
                            ElementPlus.ElMessage.success('批量更新公开状态成功');
                            this.batchPublicDialogVisible = false;
                            this.loadProducts();
                            this.$refs.productTable.clearSelection();
                        }
                    } catch (error) {
                        this.handleAxiosError(error, '批量更新公开状态失败');
                    }
                },
                showHiddenProducts() {
                    this.hiddenProductsVisible = true;
                    this.loadHiddenProducts();
                },
                async loadHiddenProducts() {
                    try {
                        const response = await axios.get('/api/hidden_products');
                        if (response.data.code === 0) {
                            this.hiddenProducts = response.data.data || [];
                            console.log('暗推产品列表:', this.hiddenProducts);
                        } else {
                            this.$message.error('加载暗推产品失败: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('加载暗推产品失败:', error);
                        this.$message.error('加载暗推产品失败');
                    }
                },
                async searchProductsForHidden() {
                    if (!this.hiddenSearch.keyword.trim()) {
                        this.$message.warning('请输入搜索关键词');
                        return;
                    }
                    
                    try {
                        const response = await axios.get('/products', {
                            params: {
                                keyword: this.hiddenSearch.keyword,
                                page: 1,
                                page_size: 10
                            }
                        });
                        console.log('搜索商品结果:', response.data);
                        
                        if (response.status === 200) {
                            this.searchProductsResults = response.data.products || [];
                            if (this.searchProductsResults.length === 0) {
                                this.$message.info('未找到相关商品');
                            }
                        }
                    } catch (error) {
                        console.error('搜索商品失败:', error);
                        this.$message.error('搜索商品失败');
                    }
                },
                isProductHidden(productId) {
                    return this.hiddenProducts.some(p => p.id === productId);
                },
                async addToHidden(product) {
                    if (this.isProductHidden(product.id)) {
                        this.$message.warning('该商品已经在暗推列表中');
                        return;
                    }
                    
                    try {
                        // 构建新的暗推列表
                        const newHiddenList = [...this.hiddenProducts, product];
                        const productIds = newHiddenList.map(p => p.id);
                        
                        const response = await axios.post('/api/hidden_products', {
                            product_ids: productIds
                        });
                        
                        if (response.data.code === 0) {
                            this.$message.success('添加暗推产品成功');
                            await this.loadHiddenProducts();
                            // 清空搜索结果
                            this.hiddenSearch.keyword = '';
                            this.searchProductsResults = [];
                        } else {
                            this.$message.error('添加暗推产品失败: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('添加暗推产品失败:', error);
                        this.$message.error('添加暗推产品失败');
                    }
                },
                async removeFromHidden(index) {
                    try {
                        // 构建新的暗推列表
                        const newHiddenList = [...this.hiddenProducts];
                        newHiddenList.splice(index, 1);
                        
                        const productIds = newHiddenList.map(p => p.id);
                        
                        const response = await axios.post('/api/hidden_products', {
                            product_ids: productIds
                        });
                        
                        if (response.data.code === 0) {
                            this.$message.success('移除暗推产品成功');
                            await this.loadHiddenProducts();
                        } else {
                            this.$message.error('移除暗推产品失败: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('移除暗推产品失败:', error);
                        this.$message.error('移除暗推产品失败');
                    }
                },
                async saveHiddenProducts() {
                    try {
                        const productIds = this.hiddenProducts.map(p => p.id);
                        
                        const response = await axios.post('/api/hidden_products', {
                            product_ids: productIds
                        });
                        
                        if (response.data.code === 0) {
                            this.$message.success('更新暗推产品顺序成功');
                        } else {
                            this.$message.error('更新暗推产品顺序失败: ' + response.data.message);
                            // 如果失败，重新加载列表
                            await this.loadHiddenProducts();
                        }
                    } catch (error) {
                        console.error('更新暗推产品顺序失败:', error);
                        this.$message.error('更新暗推产品顺序失败');
                        // 如果失败，重新加载列表
                        await this.loadHiddenProducts();
                    }
                },
                handleStatusFilterChange(value) {
                    this.selectedFilters.status = value;
                    this.handleProductSearch();
                },
                handleSortChange(column) {
                    // 处理排序逻辑
                    if (column.order === null) {
                        // 取消排序
                        this.productSearch.sortField = '';
                        this.productSearch.sortOrder = '';
                    } else {
                        this.productSearch.sortField = column.prop;
                        this.productSearch.sortOrder = column.order === 'ascending' ? 'asc' : 'desc';
                    }
                    this.handleProductSearch();
                },
            }
        })
        
        // 注册所有图标组件
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component)
        }

        // 使用 Element Plus
        app.use(ElementPlus, {
            size: 'default',
            zIndex: 3000
        })

        app.mount('#app')
    </script>
</body>

</html>